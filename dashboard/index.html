<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tribearium Lead Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'tribearium-primary': '#7c3aed',
            'tribearium-secondary': '#06b6d4',
            'tribearium-accent': '#f59e0b',
            'tribearium-sidebar': '#0f172a',
            'tribearium-hover': '#1e293b'
          }
        }
      }
    }
  </script>
  <style>
    .sidebar-item{transition:all .2s ease-in-out}
    .sidebar-item:hover{background-color:#1e293b;transform:translateX(2px)}
    .sidebar-item.active{background-color:#7c3aed;border-right:3px solid #a855f7}
    .content-fade{animation:fadeIn .3s ease-in-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .table-hover:hover{background-color:#f8fafc}
    .btn-primary{background:linear-gradient(135deg,#7c3aed 0%,#5b21b6 100%);transition:all .2s ease}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,.3)}
    .loading{opacity:0.7;pointer-events:none}
    .notification{position:fixed;top:1rem;right:1rem;z-index:1000;max-width:400px}
  </style>
</head>
<body class="bg-gray-50 font-sans">

  <!-- Notifications Container -->
  <div id="notifications" class="notification"></div>

  <!-- Top Navigation Bar -->
  <nav class="bg-white border-b border-gray-200 fixed w-full top-0 z-50">
    <div class="flex items-center justify-between px-6 py-3">
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-tribearium-primary rounded-lg flex items-center justify-center">
            <i class="fas fa-rocket text-white text-sm"></i>
          </div>
          <h1 class="text-xl font-bold text-gray-900">Tribearium</h1>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-3">
          <button class="p-2 text-gray-400 hover:text-gray-600">
            <i class="fas fa-bell"></i>
          </button>
          <button onclick="showSection('settings')" class="p-2 text-gray-400 hover:text-gray-600">
            <i class="fas fa-cog"></i>
          </button>
          <div class="w-8 h-8 bg-tribearium-primary rounded-full flex items-center justify-center text-white text-sm font-medium">TR</div>
        </div>
      </div>
    </div>
  </nav>

  <div class="flex pt-16 min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-tribearium-sidebar text-white fixed left-0 top-16 bottom-0 overflow-y-auto">
      <div class="p-4">
        <nav class="space-y-1">
          <a href="#" onclick="showSection('homepage')" class="sidebar-item active flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-home mr-3"></i>Homepage
          </a>
          <a href="#" onclick="showSection('sequences')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-paper-plane mr-3"></i>Sequences
          </a>
          <a href="#" onclick="showSection('tasks')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-tasks mr-3"></i>Tasks
          </a>
          <a href="#" onclick="showSection('inbox')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-inbox mr-3"></i>Unified Inbox
          </a>
          <a href="#" onclick="showSection('clients')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-building mr-3"></i>Client Management
          </a>
          <a href="#" onclick="showSection('leadfinder')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-search mr-3"></i>Lead Finder
          </a>
          <a href="#" onclick="showSection('prospects')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-users mr-3"></i>Prospects
          </a>
          <a href="#" onclick="showSection('verifier')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-check-circle mr-3"></i>Email Verifier
          </a>
          <a href="#" onclick="showSection('templates')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-file-alt mr-3"></i>Templates
          </a>
          <a href="#" onclick="showSection('analytics')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-chart-bar mr-3"></i>Analytics
          </a>
          <div class="border-t border-gray-600 my-4"></div>
          <a href="#" onclick="showSection('settings')" class="sidebar-item flex items-center px-3 py-2 rounded-lg text-sm font-medium">
            <i class="fas fa-cog mr-3"></i>Settings
          </a>
        </nav>
      </div>
    </aside>



    <main class="flex-1 ml-64 p-6">
      <!-- Homepage Section -->
<!-- Homepage Section - Dashboard Completo con M√©tricas Avanzadas -->
<div id="homepage-section" class="content-fade">
  <!-- Header con saludo din√°mico y resumen ejecutivo -->
  <div class="mb-6">
      <div class="flex items-center justify-between">
          <div>
              <h1 class="text-3xl font-bold text-gray-900" id="welcomeMessage">Welcome to Tribearium Dashboard</h1>
              <p class="text-gray-600 mt-1" id="dashboardSubtitle">Loading your data...</p>
          </div>
          <div class="text-right">
              <p class="text-sm text-gray-500" id="currentDateTime"></p>
              <p class="text-2xl font-bold text-tribearium-primary" id="currentTime"></p>
          </div>
      </div>
  </div>

  <!-- Revenue & Financial KPIs - Primera fila NUEVA -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
      <!-- Monthly Recurring Revenue -->
      <div class="bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl p-6 text-white">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-green-100 text-sm font-medium">MRR</p>
                  <p class="text-3xl font-bold mt-2">$<span id="mrrValue">0</span></p>
                  <div class="flex items-center mt-2">
                      <i class="fas fa-arrow-up text-xs mr-1"></i>
                      <span class="text-xs"><span id="mrrGrowth">0</span>% vs last month</span>
                  </div>
              </div>
              <div class="bg-white bg-opacity-20 rounded-full p-3">
                  <i class="fas fa-dollar-sign text-2xl"></i>
              </div>
          </div>
      </div>

      <!-- Pipeline Value -->
      <div class="bg-gradient-to-r from-blue-600 to-cyan-600 rounded-xl p-6 text-white">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-blue-100 text-sm font-medium">Pipeline Value</p>
                  <p class="text-3xl font-bold mt-2">$<span id="pipelineValue">0</span></p>
                  <div class="flex items-center mt-2">
                      <span class="text-xs"><span id="pipelineDeals">0</span> deals</span>
                  </div>
              </div>
              <div class="bg-white bg-opacity-20 rounded-full p-3">
                  <i class="fas fa-funnel-dollar text-2xl"></i>
              </div>
          </div>
      </div>

      <!-- Conversion Rate -->
      <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl p-6 text-white">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-purple-100 text-sm font-medium">Conversion Rate</p>
                  <p class="text-3xl font-bold mt-2"><span id="conversionRate">0</span>%</p>
                  <div class="flex items-center mt-2">
                      <span class="text-xs">Lead to Customer</span>
                  </div>
              </div>
              <div class="bg-white bg-opacity-20 rounded-full p-3">
                  <i class="fas fa-percentage text-2xl"></i>
              </div>
          </div>
      </div>

      <!-- Average Deal Size -->
      <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-xl p-6 text-white">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-orange-100 text-sm font-medium">Avg Deal Size</p>
                  <p class="text-3xl font-bold mt-2">$<span id="avgDealSize">0</span></p>
                  <div class="flex items-center mt-2">
                      <span class="text-xs">Per customer</span>
                  </div>
              </div>
              <div class="bg-white bg-opacity-20 rounded-full p-3">
                  <i class="fas fa-receipt text-2xl"></i>
              </div>
          </div>
      </div>

      <!-- Customer Lifetime Value -->
      <div class="bg-gradient-to-r from-indigo-600 to-violet-600 rounded-xl p-6 text-white">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-indigo-100 text-sm font-medium">CLV</p>
                  <p class="text-3xl font-bold mt-2">$<span id="clvValue">0</span></p>
                  <div class="flex items-center mt-2">
                      <span class="text-xs">Lifetime value</span>
                  </div>
              </div>
              <div class="bg-white bg-opacity-20 rounded-full p-3">
                  <i class="fas fa-gem text-2xl"></i>
              </div>
          </div>
      </div>
  </div>

  <!-- Operational KPIs - Segunda fila -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="kpiCards">
      <!-- Total Leads -->
      <div class="bg-white border-2 border-purple-200 rounded-xl p-6">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-gray-600 text-sm font-medium">Total Leads</p>
                  <p class="text-3xl font-bold mt-2 text-gray-900"><span id="totalLeads">0</span></p>
                  <div class="flex items-center mt-2">
                      <div class="w-full bg-gray-200 rounded-full h-2">
                          <div class="bg-purple-500 h-2 rounded-full" id="leadsProgress" style="width: 0%"></div>
                      </div>
                  </div>
              </div>
              <div class="bg-purple-100 rounded-full p-3">
                  <i class="fas fa-users text-purple-600 text-2xl"></i>
              </div>
          </div>
      </div>

      <!-- Active Sequences -->
      <div class="bg-white border-2 border-blue-200 rounded-xl p-6">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-gray-600 text-sm font-medium">Active Sequences</p>
                  <p class="text-3xl font-bold mt-2 text-gray-900"><span id="activeSequences">0</span></p>
                  <div class="flex items-center mt-2 text-xs text-gray-500">
                      <span><span id="sequenceProspects">0</span> prospects enrolled</span>
                  </div>
              </div>
              <div class="bg-blue-100 rounded-full p-3">
                  <i class="fas fa-paper-plane text-blue-600 text-2xl"></i>
              </div>
          </div>
      </div>

      <!-- Today's Activity -->
      <div class="bg-white border-2 border-green-200 rounded-xl p-6">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-gray-600 text-sm font-medium">Today's Emails</p>
                  <p class="text-3xl font-bold mt-2 text-gray-900"><span id="todayEmails">0</span></p>
                  <div class="flex items-center mt-2">
                      <div class="w-full bg-gray-200 rounded-full h-2">
                          <div class="bg-green-500 h-2 rounded-full" id="emailQuota" style="width: 0%"></div>
                      </div>
                      <span class="text-xs ml-2"><span id="quotaPercent">0</span>%</span>
                  </div>
              </div>
              <div class="bg-green-100 rounded-full p-3">
                  <i class="fas fa-envelope text-green-600 text-2xl"></i>
              </div>
          </div>
      </div>

      <!-- Response Rate -->
      <div class="bg-white border-2 border-orange-200 rounded-xl p-6">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-gray-600 text-sm font-medium">Response Rate</p>
                  <p class="text-3xl font-bold mt-2 text-gray-900"><span id="responseRate">0</span>%</p>
                  <div class="flex items-center mt-2 text-xs">
                      <span class="text-green-600"><span id="positiveResponses">0</span> positive</span>
                      <span class="text-gray-400 mx-1">|</span>
                      <span class="text-red-600"><span id="negativeResponses">0</span> negative</span>
                  </div>
              </div>
              <div class="bg-orange-100 rounded-full p-3">
                  <i class="fas fa-chart-line text-orange-600 text-2xl"></i>
              </div>
          </div>
      </div>
  </div>

  <!-- Tercera fila - 4 columnas con widgets -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
      <!-- Quick Actions Panel -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-bolt text-yellow-500 mr-2"></i>
              Quick Actions
          </h3>
          <div class="space-y-2" id="quickActionsPanel">
              <!-- Se llenar√° din√°micamente -->
          </div>
      </div>

      <!-- Sales Funnel Mini -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-filter text-purple-500 mr-2"></i>
              Sales Funnel
          </h3>
          <div class="space-y-3" id="salesFunnelMini">
              <div class="relative">
                  <div class="flex justify-between items-center mb-1">
                      <span class="text-xs font-medium">Leads</span>
                      <span class="text-xs font-bold" id="funnelLeads">0</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3">
                      <div class="bg-purple-500 h-3 rounded-full" style="width: 100%"></div>
                  </div>
              </div>
              <div class="relative">
                  <div class="flex justify-between items-center mb-1">
                      <span class="text-xs font-medium">Qualified</span>
                      <span class="text-xs font-bold" id="funnelQualified">0</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3">
                      <div class="bg-blue-500 h-3 rounded-full" id="qualifiedBar" style="width: 0%"></div>
                  </div>
              </div>
              <div class="relative">
                  <div class="flex justify-between items-center mb-1">
                      <span class="text-xs font-medium">Opportunities</span>
                      <span class="text-xs font-bold" id="funnelOpportunities">0</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3">
                      <div class="bg-green-500 h-3 rounded-full" id="opportunitiesBar" style="width: 0%"></div>
                  </div>
              </div>
              <div class="relative">
                  <div class="flex justify-between items-center mb-1">
                      <span class="text-xs font-medium">Customers</span>
                      <span class="text-xs font-bold" id="funnelCustomers">0</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3">
                      <div class="bg-emerald-500 h-3 rounded-full" id="customersBar" style="width: 0%"></div>
                  </div>
              </div>
          </div>
      </div>

      <!-- Recent Activity Feed -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-stream text-blue-500 mr-2"></i>
              Recent Activity
          </h3>
          <div class="space-y-2 max-h-64 overflow-y-auto" id="activityFeed">
              <!-- Se llenar√° din√°micamente -->
          </div>
      </div>

      <!-- Top Performing Sequences -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i class="fas fa-trophy text-yellow-500 mr-2"></i>
              Top Sequences
          </h3>
          <div class="space-y-2" id="topSequences">
              <!-- Se llenar√° din√°micamente -->
          </div>
      </div>
  </div>

  <!-- Cuarta fila - Gr√°ficos principales -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Revenue Trend Chart -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900">Revenue Trend</h3>
              <select id="revenueChartPeriod" onchange="updateRevenueChart()" class="text-sm border border-gray-300 rounded px-2 py-1">
                  <option value="7">Last 7 days</option>
                  <option value="30" selected>Last 30 days</option>
                  <option value="90">Last 90 days</option>
                  <option value="365">Last year</option>
              </select>
          </div>
          <div class="h-64">
              <canvas id="revenueChart"></canvas>
          </div>
      </div>

      <!-- Email Performance Chart -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900">Email Performance</h3>
              <div class="flex space-x-2">
                  <button onclick="updateEmailChart('sent')" class="text-xs px-2 py-1 rounded bg-purple-100 text-purple-700">Sent</button>
                  <button onclick="updateEmailChart('opened')" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">Opened</button>
                  <button onclick="updateEmailChart('clicked')" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">Clicked</button>
              </div>
          </div>
          <div class="h-64">
              <canvas id="emailPerformanceChart"></canvas>
          </div>
      </div>

      <!-- Lead Sources Distribution -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900">Lead Sources</h3>
              <button onclick="refreshLeadSources()" class="text-sm text-gray-500 hover:text-gray-700">
                  <i class="fas fa-sync-alt"></i>
              </button>
          </div>
          <div class="h-64">
              <canvas id="leadSourcesChart"></canvas>
          </div>
      </div>
  </div>

  <!-- Quinta fila - M√°s gr√°ficos -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Conversion Funnel Chart -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Conversion Funnel Analysis</h3>
          <div class="h-64">
              <canvas id="conversionFunnelChart"></canvas>
          </div>
      </div>

      <!-- Team Performance -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Team Performance</h3>
          <div class="h-64">
              <canvas id="teamPerformanceChart"></canvas>
          </div>
      </div>
  </div>

  <!-- Sexta fila - Tablas de datos -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <!-- Hot Leads Table -->
      <div class="bg-white rounded-xl border border-gray-200">
          <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">üî• Hot Leads</h3>
                  <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full" id="hotLeadsCount">0</span>
              </div>
          </div>
          <div class="overflow-x-auto max-h-80">
              <table class="w-full">
                  <thead class="bg-gray-50 sticky top-0">
                      <tr>
                          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                      </tr>
                  </thead>
                  <tbody id="hotLeadsTable" class="divide-y divide-gray-200">
                      <!-- Se llenar√° din√°micamente -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Recent Conversions -->
      <div class="bg-white rounded-xl border border-gray-200">
          <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">‚úÖ Recent Conversions</h3>
                  <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full" id="conversionsCount">0</span>
              </div>
          </div>
          <div class="overflow-x-auto max-h-80">
              <table class="w-full">
                  <thead class="bg-gray-50 sticky top-0">
                      <tr>
                          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Value</th>
                          <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                      </tr>
                  </thead>
                  <tbody id="conversionsTable" class="divide-y divide-gray-200">
                      <!-- Se llenar√° din√°micamente -->
                  </tbody>
              </table>
          </div>
      </div>

      <!-- Tasks & Reminders -->
      <div class="bg-white rounded-xl border border-gray-200">
          <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                  <h3 class="text-lg font-semibold text-gray-900">üìã Today's Tasks</h3>
                  <button onclick="showSection('tasks')" class="text-sm text-tribearium-primary hover:text-purple-700">
                      View all ‚Üí
                  </button>
              </div>
          </div>
          <div class="p-6 max-h-80 overflow-y-auto" id="todayTasksList">
              <!-- Se llenar√° din√°micamente -->
          </div>
      </div>
  </div>

  <!-- S√©ptima fila - Email & Campaign Stats -->
  <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
      <div class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-xs text-gray-500 uppercase">Open Rate</p>
                  <p class="text-2xl font-bold text-gray-900" id="openRateStat">-</p>
                  <p class="text-xs text-gray-500 mt-1">Last 30 days</p>
              </div>
              <i class="fas fa-envelope-open text-blue-400 text-xl"></i>
          </div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-xs text-gray-500 uppercase">Click Rate</p>
                  <p class="text-2xl font-bold text-gray-900" id="clickRateStat">-</p>
                  <p class="text-xs text-gray-500 mt-1">CTR</p>
              </div>
              <i class="fas fa-mouse-pointer text-purple-400 text-xl"></i>
          </div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-xs text-gray-500 uppercase">Reply Rate</p>
                  <p class="text-2xl font-bold text-gray-900" id="replyRateStat">-</p>
                  <p class="text-xs text-gray-500 mt-1">Responses</p>
              </div>
              <i class="fas fa-reply text-green-400 text-xl"></i>
          </div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-xs text-gray-500 uppercase">Bounce Rate</p>
                  <p class="text-2xl font-bold text-gray-900" id="bounceRateStat">-</p>
                  <p class="text-xs text-gray-500 mt-1">Bounced</p>
              </div>
              <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
          </div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-xs text-gray-500 uppercase">Unsubscribe</p>
                  <p class="text-2xl font-bold text-gray-900" id="unsubscribeRateStat">-</p>
                  <p class="text-xs text-gray-500 mt-1">Rate</p>
              </div>
              <i class="fas fa-user-minus text-red-400 text-xl"></i>
          </div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
              <div>
                  <p class="text-xs text-gray-500 uppercase">Avg Score</p>
                  <p class="text-2xl font-bold text-gray-900" id="avgScoreStat">-</p>
                  <p class="text-xs text-gray-500 mt-1">Lead quality</p>
              </div>
              <i class="fas fa-star text-yellow-400 text-xl"></i>
          </div>
      </div>
  </div>

  <!-- Octava fila - Goals & Targets -->
  <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Monthly Goals & Progress</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div>
              <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-gray-700">New Leads</span>
                  <span class="text-sm font-bold"><span id="currentLeads">0</span> / <span id="targetLeads">500</span></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                  <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-3 rounded-full transition-all duration-500" id="leadsGoalProgress" style="width: 0%"></div>
              </div>
          </div>
          <div>
              <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-gray-700">Revenue</span>
                  <span class="text-sm font-bold">$<span id="currentRevenue">0</span> / $<span id="targetRevenue">50K</span></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                  <div class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-500" id="revenueGoalProgress" style="width: 0%"></div>
              </div>
          </div>
          <div>
              <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-gray-700">Conversions</span>
                  <span class="text-sm font-bold"><span id="currentConversions">0</span> / <span id="targetConversions">25</span></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                  <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500" id="conversionsGoalProgress" style="width: 0%"></div>
              </div>
          </div>
          <div>
              <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-gray-700">Sequences</span>
                  <span class="text-sm font-bold"><span id="currentSequences">0</span> / <span id="targetSequences">10</span></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                  <div class="bg-gradient-to-r from-orange-500 to-orange-600 h-3 rounded-full transition-all duration-500" id="sequencesGoalProgress" style="width: 0%"></div>
              </div>
          </div>
      </div>
  </div>
</div>

<script>
  // Variables para los charts
  let revenueChart = null;
  let emailChart = null;
  let leadSourcesChart = null;
  let conversionFunnelChart = null;
  let teamPerformanceChart = null;
  
  // =====================
  // FUNCI√ìN PRINCIPAL
  // =====================
  
  async function loadHomepageDashboard() {
      console.log('üöÄ Loading complete dashboard with REAL data...');
      
      // Actualizar fecha y hora
      updateDateTime();
      setInterval(updateDateTime, 60000);
      
      // Cargar todos los datos en paralelo
      await Promise.all([
          loadFinancialKPIs(),
          loadOperationalKPIs(),
          loadSalesFunnel(),
          loadRecentActivity(),
          loadTopSequences(),
          loadHotLeads(),
          loadRecentConversions(),
          loadTodayTasks(),
          loadEmailStats(),
          loadMonthlyGoals(),
          initializeAllCharts()
      ]);
      
      // Configurar Quick Actions
      setupQuickActions();
      
      // Auto-refresh cada 5 minutos
      setInterval(() => {
          loadOperationalKPIs();
          loadEmailStats();
          loadRecentActivity();
      }, 300000);
      
      console.log('‚úÖ Dashboard loaded successfully!');
  }
  
  // =====================
  // FECHA Y HORA
  // =====================
  
  function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: true 
      });
  }
  
  // =====================
  // FINANCIAL KPIs
  // =====================
  
  async function loadFinancialKPIs() {
      try {
          const response = await fetch('/api/dashboard/financial-kpis');
          const data = await response.json();
          
          if (data.success) {
              const kpis = data.data;
              
              document.getElementById('mrrValue').textContent = formatCurrency(kpis.mrr || 0);
              document.getElementById('mrrGrowth').textContent = kpis.mrrGrowth || 0;
              document.getElementById('pipelineValue').textContent = formatCurrency(kpis.pipelineValue || 0);
              document.getElementById('pipelineDeals').textContent = kpis.pipelineDeals || 0;
              document.getElementById('conversionRate').textContent = kpis.conversionRate || 0;
              document.getElementById('avgDealSize').textContent = formatCurrency(kpis.avgDealSize || 0);
              document.getElementById('clvValue').textContent = formatCurrency(kpis.clv || 0);
              
              document.getElementById('dashboardSubtitle').textContent = 
                  `Revenue this month: $${formatCurrency(kpis.monthlyRevenue || 0)} | ${kpis.newCustomers || 0} new customers`;
          }
      } catch (error) {
          console.error('‚ùå Error loading financial KPIs:', error);
      }
  }
  
  // =====================
  // OPERATIONAL KPIs
  // =====================
  
  async function loadOperationalKPIs() {
      try {
          const response = await fetch('/api/dashboard/operational-kpis');
          const data = await response.json();
          
          if (data.success) {
              const kpis = data.data;
              
              document.getElementById('totalLeads').textContent = kpis.totalLeads || 0;
              const leadsProgress = Math.min((kpis.totalLeads / kpis.leadsTarget) * 100, 100);
              document.getElementById('leadsProgress').style.width = `${leadsProgress}%`;
              
              document.getElementById('activeSequences').textContent = kpis.activeSequences || 0;
              document.getElementById('sequenceProspects').textContent = kpis.sequenceProspects || 0;
              
              document.getElementById('todayEmails').textContent = kpis.todayEmails || 0;
              const quotaPercent = Math.min((kpis.todayEmails / kpis.dailyLimit) * 100, 100);
              document.getElementById('emailQuota').style.width = `${quotaPercent}%`;
              document.getElementById('quotaPercent').textContent = Math.round(quotaPercent);
              
              document.getElementById('responseRate').textContent = kpis.responseRate || 0;
              document.getElementById('positiveResponses').textContent = kpis.positiveResponses || 0;
              document.getElementById('negativeResponses').textContent = kpis.negativeResponses || 0;
          }
      } catch (error) {
          console.error('‚ùå Error loading operational KPIs:', error);
      }
  }
  
  // =====================
  // SALES FUNNEL
  // =====================
  
  async function loadSalesFunnel() {
      try {
          const response = await fetch('/api/dashboard/sales-funnel');
          const data = await response.json();
          
          if (data.success) {
              const funnel = data.data;
              
              document.getElementById('funnelLeads').textContent = funnel.leads || 0;
              document.getElementById('funnelQualified').textContent = funnel.qualified || 0;
              document.getElementById('funnelOpportunities').textContent = funnel.opportunities || 0;
              document.getElementById('funnelCustomers').textContent = funnel.customers || 0;
              
              const qualifiedPercent = funnel.leads > 0 ? (funnel.qualified / funnel.leads) * 100 : 0;
              const opportunitiesPercent = funnel.leads > 0 ? (funnel.opportunities / funnel.leads) * 100 : 0;
              const customersPercent = funnel.leads > 0 ? (funnel.customers / funnel.leads) * 100 : 0;
              
              document.getElementById('qualifiedBar').style.width = `${qualifiedPercent}%`;
              document.getElementById('opportunitiesBar').style.width = `${opportunitiesPercent}%`;
              document.getElementById('customersBar').style.width = `${customersPercent}%`;
          }
      } catch (error) {
          console.error('‚ùå Error loading sales funnel:', error);
      }
  }
  
  // =====================
  // RECENT ACTIVITY
  // =====================
  
  async function loadRecentActivity() {
      try {
          const response = await fetch('/api/dashboard/recent-activity');
          const data = await response.json();
          
          const feed = document.getElementById('activityFeed');
          if (!feed) return;
          
          if (data.success && data.data && data.data.length > 0) {
              feed.innerHTML = data.data.map(activity => `
                  <div class="flex items-start text-xs mb-2">
                      <span class="mr-2">${activity.icon}</span>
                      <div class="flex-1">
                          <p class="font-medium">${activity.text}</p>
                          <p class="text-gray-500">${activity.time}</p>
                      </div>
                  </div>
              `).join('');
          } else {
              feed.innerHTML = '<div class="text-center text-xs text-gray-500 py-4">No recent activity</div>';
          }
      } catch (error) {
          console.error('‚ùå Error loading recent activity:', error);
      }
  }
  
  // =====================
  // TOP SEQUENCES
  // =====================
  
  async function loadTopSequences() {
      try {
          const response = await fetch('/api/dashboard/top-sequences');
          const data = await response.json();
          
          const container = document.getElementById('topSequences');
          if (!container) return;
          
          if (data.success && data.data && data.data.length > 0) {
              container.innerHTML = data.data.map(seq => `
                  <div class="flex items-center justify-between mb-2">
                      <div class="flex-1">
                          <p class="text-sm font-medium">${seq.name}</p>
                          <div class="flex items-center mt-1">
                              <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                  <div class="bg-${seq.color}-500 h-2 rounded-full" style="width: ${seq.rate}%"></div>
                              </div>
                              <span class="text-xs text-gray-600">${seq.rate}%</span>
                          </div>
                      </div>
                  </div>
              `).join('');
          } else {
              container.innerHTML = '<div class="text-center text-xs text-gray-500 py-4">No active sequences</div>';
          }
      } catch (error) {
          console.error('‚ùå Error loading top sequences:', error);
      }
  }
  
  // =====================
  // HOT LEADS
  // =====================
  
  async function loadHotLeads() {
      try {
          const response = await fetch('/api/dashboard/hot-leads?limit=10');
          const data = await response.json();
          
          if (data.success) {
              const tbody = document.getElementById('hotLeadsTable');
              document.getElementById('hotLeadsCount').textContent = data.data.length;
              
              if (data.data.length === 0) {
                  tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-sm text-gray-500">No hot leads</td></tr>';
                  return;
              }
              
              tbody.innerHTML = data.data.map(lead => `
                  <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2">
                          <div class="text-sm font-medium text-gray-900">${lead.name}</div>
                          <div class="text-xs text-gray-500">${lead.company || 'No company'}</div>
                      </td>
                      <td class="px-4 py-2">
                          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                              ${lead.score}
                          </span>
                      </td>
                      <td class="px-4 py-2">
                          <button onclick="contactLead('${lead.id}')" class="text-xs text-blue-600 hover:text-blue-800">
                              Contact
                          </button>
                      </td>
                  </tr>
              `).join('');
          }
      } catch (error) {
          console.error('‚ùå Error loading hot leads:', error);
      }
  }
  
  // =====================
  // RECENT CONVERSIONS
  // =====================
  
  async function loadRecentConversions() {
      try {
          const response = await fetch('/api/dashboard/recent-conversions?limit=10');
          const data = await response.json();
          
          if (data.success) {
              const tbody = document.getElementById('conversionsTable');
              document.getElementById('conversionsCount').textContent = data.data.length;
              
              if (data.data.length === 0) {
                  tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-sm text-gray-500">No conversions</td></tr>';
                  return;
              }
              
              tbody.innerHTML = data.data.map(conversion => `
                  <tr class="hover:bg-gray-50">
                      <td class="px-4 py-2">
                          <div class="text-sm font-medium text-gray-900">${conversion.customer}</div>
                          <div class="text-xs text-gray-500">${conversion.source}</div>
                      </td>
                      <td class="px-4 py-2 text-sm font-bold text-green-600">
                          $${formatCurrency(conversion.value)}
                      </td>
                      <td class="px-4 py-2 text-xs text-gray-500">
                          ${formatDate(conversion.date)}
                      </td>
                  </tr>
              `).join('');
          }
      } catch (error) {
          console.error('‚ùå Error loading conversions:', error);
      }
  }
  
  // =====================
  // TODAY'S TASKS
  // =====================
  
  async function loadTodayTasks() {
      try {
          const response = await fetch('/api/tasks?status=pending&due_date=today&limit=5');
          const data = await response.json();
          
          const container = document.getElementById('todayTasksList');
          if (!container) return;
          
          if (data.success && data.data && data.data.length > 0) {
              container.innerHTML = data.data.map(task => `
                  <div class="flex items-start mb-3">
                      <input type="checkbox" 
                             class="mt-1 rounded text-purple-600" 
                             ${task.status === 'completed' ? 'checked' : ''}
                             onchange="toggleTaskStatus(${task.id}, this.checked)">
                      <div class="ml-3 flex-1">
                          <p class="text-sm font-medium ${task.status === 'completed' ? 'line-through text-gray-400' : 'text-gray-900'}">
                              ${task.title}
                          </p>
                          <p class="text-xs text-gray-500">${task.due_date ? formatTaskTime(task.due_date) : 'No due date'}</p>
                      </div>
                  </div>
              `).join('');
          } else {
              container.innerHTML = '<div class="text-center text-xs text-gray-500 py-4">No tasks for today</div>';
          }
      } catch (error) {
          console.error('‚ùå Error loading tasks:', error);
      }
  }
  
  async function toggleTaskStatus(taskId, isCompleted) {
      try {
          await fetch(`/api/tasks/${taskId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  status: isCompleted ? 'completed' : 'pending',
                  completed_at: isCompleted ? new Date().toISOString() : null
              })
          });
      } catch (error) {
          console.error('‚ùå Error updating task:', error);
      }
  }
  
  // =====================
  // EMAIL STATS
  // =====================
  
  async function loadEmailStats() {
      try {
          const response = await fetch('/api/dashboard/email-stats');
          const data = await response.json();
          
          if (data.success) {
              const stats = data.data;
              document.getElementById('openRateStat').textContent = stats.open_rate + '%';
              document.getElementById('clickRateStat').textContent = stats.click_rate + '%';
              document.getElementById('replyRateStat').textContent = stats.reply_rate + '%';
              document.getElementById('bounceRateStat').textContent = stats.bounce_rate + '%';
              document.getElementById('unsubscribeRateStat').textContent = stats.unsubscribe_rate + '%';
              document.getElementById('avgScoreStat').textContent = Math.round(stats.avg_score || 0);
          }
      } catch (error) {
          console.error('‚ùå Error loading email stats:', error);
      }
  }
  
  // =====================
  // MONTHLY GOALS
  // =====================
  
  async function loadMonthlyGoals() {
      try {
          const response = await fetch('/api/dashboard/monthly-goals');
          const data = await response.json();
          
          if (data.success) {
              const goals = data.data;
              
              document.getElementById('currentLeads').textContent = goals.currentLeads || 0;
              document.getElementById('targetLeads').textContent = goals.targetLeads || 500;
              const leadsPercent = Math.min((goals.currentLeads / goals.targetLeads) * 100, 100);
              document.getElementById('leadsGoalProgress').style.width = `${leadsPercent}%`;
              
              document.getElementById('currentRevenue').textContent = formatCurrency(goals.currentRevenue || 0);
              document.getElementById('targetRevenue').textContent = formatCurrency(goals.targetRevenue || 50000);
              const revenuePercent = Math.min((goals.currentRevenue / goals.targetRevenue) * 100, 100);
              document.getElementById('revenueGoalProgress').style.width = `${revenuePercent}%`;
              
              document.getElementById('currentConversions').textContent = goals.currentConversions || 0;
              document.getElementById('targetConversions').textContent = goals.targetConversions || 25;
              const conversionsPercent = Math.min((goals.currentConversions / goals.targetConversions) * 100, 100);
              document.getElementById('conversionsGoalProgress').style.width = `${conversionsPercent}%`;
              
              document.getElementById('currentSequences').textContent = goals.currentSequences || 0;
              document.getElementById('targetSequences').textContent = goals.targetSequences || 10;
              const sequencesPercent = Math.min((goals.currentSequences / goals.targetSequences) * 100, 100);
              document.getElementById('sequencesGoalProgress').style.width = `${sequencesPercent}%`;
          }
      } catch (error) {
          console.error('‚ùå Error loading monthly goals:', error);
      }
  }
  
  // =====================
  // CHARTS
  // =====================
  
  async function initializeAllCharts() {
      await Promise.all([
          updateRevenueChart(),
          updateEmailChart('sent'),
          updateLeadSourcesChart(),
          updateConversionFunnelChart(),
          updateTeamPerformanceChart()
      ]);
  }
  
  async function updateRevenueChart() {
      try {
          const period = document.getElementById('revenueChartPeriod')?.value || 30;
          const response = await fetch(`/api/dashboard/revenue-chart?days=${period}`);
          const data = await response.json();
          
          if (data.success) {
              const ctx = document.getElementById('revenueChart').getContext('2d');
              
              if (revenueChart) revenueChart.destroy();
              
              revenueChart = new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: data.data.labels,
                      datasets: [{
                          label: 'Revenue',
                          data: data.data.revenue,
                          borderColor: '#10b981',
                          backgroundColor: 'rgba(16, 185, 129, 0.1)',
                          tension: 0.4,
                          fill: true
                      }, {
                          label: 'Target',
                          data: data.data.target,
                          borderColor: '#ef4444',
                          borderDash: [5, 5],
                          tension: 0.4,
                          fill: false
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: { position: 'bottom' },
                          tooltip: {
                              callbacks: {
                                  label: (context) => context.dataset.label + ': $' + formatCurrency(context.parsed.y)
                              }
                          }
                      },
                      scales: {
                          y: {
                              beginAtZero: true,
                              ticks: { callback: (value) => '$' + formatCurrency(value) }
                          }
                      }
                  }
              });
          }
      } catch (error) {
          console.error('‚ùå Error updating revenue chart:', error);
      }
  }
  
  async function updateEmailChart(type) {
      try {
          const response = await fetch(`/api/dashboard/email-performance?days=7`);
          const data = await response.json();
          
          const ctx = document.getElementById('emailPerformanceChart');
          if (!ctx) return;
          
          if (emailChart) emailChart.destroy();
          
          emailChart = new Chart(ctx.getContext('2d'), {
              type: 'bar',
              data: {
                  labels: data.success ? data.data.labels : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                  datasets: [{
                      label: type.charAt(0).toUpperCase() + type.slice(1),
                      data: data.success ? data.data[type] : [0,0,0,0,0,0,0],
                      backgroundColor: type === 'sent' ? '#7c3aed' : type === 'opened' ? '#3b82f6' : '#10b981'
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { legend: { display: false } },
                  scales: { y: { beginAtZero: true } }
              }
          });
      } catch (error) {
          console.error('‚ùå Error updating email chart:', error);
      }
  }
  
  async function updateLeadSourcesChart() {
      try {
          const response = await fetch('/api/dashboard/lead-sources');
          const data = await response.json();
          
          const ctx = document.getElementById('leadSourcesChart');
          if (!ctx) return;
          
          if (leadSourcesChart) leadSourcesChart.destroy();
          
          leadSourcesChart = new Chart(ctx.getContext('2d'), {
              type: 'doughnut',
              data: {
                  labels: data.success ? data.data.labels : ['No data'],
                  datasets: [{
                      data: data.success ? data.data.values : [1],
                      backgroundColor: ['#7c3aed', '#3b82f6', '#10b981', '#f59e0b', '#ef4444']
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: 'bottom',
                          labels: { padding: 10, font: { size: 10 } }
                      }
                  }
              }
          });
      } catch (error) {
          console.error('‚ùå Error updating lead sources chart:', error);
      }
  }
  
  async function updateConversionFunnelChart() {
      try {
          const response = await fetch('/api/dashboard/conversion-funnel');
          const data = await response.json();
          
          if (data.success) {
              const ctx = document.getElementById('conversionFunnelChart').getContext('2d');
              
              if (conversionFunnelChart) conversionFunnelChart.destroy();
              
              conversionFunnelChart = new Chart(ctx, {
                  type: 'bar',
                  data: {
                      labels: data.data.stages,
                      datasets: [{
                          label: 'Count',
                          data: data.data.values,
                          backgroundColor: ['#7c3aed', '#3b82f6', '#10b981', '#f59e0b', '#ef4444']
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      indexAxis: 'y',
                      plugins: { legend: { display: false } }
                  }
              });
          }
      } catch (error) {
          console.error('‚ùå Error updating funnel chart:', error);
      }
  }
  
  async function updateTeamPerformanceChart() {
      try {
          const response = await fetch('/api/dashboard/team-performance');
          const data = await response.json();
          
          if (data.success) {
              const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
              
              if (teamPerformanceChart) teamPerformanceChart.destroy();
              
              teamPerformanceChart = new Chart(ctx, {
                  type: 'radar',
                  data: {
                      labels: data.data.metrics,
                      datasets: data.data.members.map((member, index) => ({
                          label: member.name,
                          data: member.scores,
                          borderColor: ['#7c3aed', '#3b82f6', '#10b981', '#f59e0b'][index % 4],
                          backgroundColor: ['rgba(124, 58, 237, 0.1)', 'rgba(59, 130, 246, 0.1)', 'rgba(16, 185, 129, 0.1)', 'rgba(245, 158, 11, 0.1)'][index % 4]
                      }))
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: { r: { beginAtZero: true, max: 100 } }
                  }
              });
          }
      } catch (error) {
          console.error('‚ùå Error updating team performance chart:', error);
      }
  }
  
  // =====================
  // HELPER FUNCTIONS
  // =====================
  
  function formatCurrency(value) {
      if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
      if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
      return value.toLocaleString();
  }
  
  function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Yesterday';
      if (diff < 7) return `${diff} days ago`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }
  
  function formatTaskTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffMs = date - now;
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      
      if (diffHours < 0) return 'Overdue';
      if (diffHours < 1) return 'Due soon';
      if (diffHours < 24) return `Due in ${diffHours} hours`;
      return `Due ${date.toLocaleDateString()}`;
  }
  
  function setupQuickActions() {
      const panel = document.getElementById('quickActionsPanel');
      if (panel) {
          panel.innerHTML = `
              <button onclick="showSection('sequences')" class="w-full text-left px-3 py-2 bg-purple-50 text-purple-700 rounded hover:bg-purple-100">
                  <i class="fas fa-plus mr-2"></i>New Sequence
              </button>
              <button onclick="showSection('prospects')" class="w-full text-left px-3 py-2 bg-blue-50 text-blue-700 rounded hover:bg-blue-100">
                  <i class="fas fa-user-plus mr-2"></i>Add Lead
              </button>
              <button onclick="showSection('inbox')" class="w-full text-left px-3 py-2 bg-green-50 text-green-700 rounded hover:bg-green-100">
                  <i class="fas fa-envelope-open mr-2"></i>Send Email
              </button>
              <button onclick="showSection('tasks')" class="w-full text-left px-3 py-2 bg-orange-50 text-orange-700 rounded hover:bg-orange-100">
                  <i class="fas fa-calendar-plus mr-2"></i>View Tasks
              </button>
          `;
      }
  }
  
  function refreshLeadSources() {
      updateLeadSourcesChart();
  }
  
  function contactLead(leadId) {
      console.log('Contacting lead:', leadId);
      showSection('prospects');
  }
  
  function showSection(section) {
      console.log('Showing section:', section);
      // Esta funci√≥n debe estar definida en tu main.js o index.html
  }
  
  // =====================
  // INICIALIZACI√ìN
  // =====================
  
  document.addEventListener('DOMContentLoaded', function() {
      const homepageSection = document.getElementById('homepage-section');
      if (homepageSection && !homepageSection.classList.contains('hidden')) {
          loadHomepageDashboard();
      }
  });
  
  window.loadHomepageData = loadHomepageDashboard;
  
  console.log('‚úÖ Dashboard script loaded - Ready for real data!');
  </script>
      <!-- ‚Üë Este cierre es MUY IMPORTANTE -->


      
      <!-- Sequences Section -->
      <div id="sequences-section" class="content-fade hidden">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Sequences</h2>
        </div>

        <!-- Onboarding Cards -->
        

        <!-- Sequences Table -->
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <input type="text" id="sequenceSearch" placeholder="Search sequences..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64" onkeyup="filterSequences()">
                <select id="sequenceClientFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterSequences()">
                  <option value="">All Clients</option>
                </select>
                <select id="sequenceStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterSequences()">
                  <option value="">All Status</option>
                  <option value="draft">Draft</option>
                  <option value="active">Active</option>
                  <option value="paused">Paused</option>
                </select>
              </div>
              <div class="flex items-center space-x-3">
                <button onclick="generateAISequence()" class="text-tribearium-primary hover:text-purple-700 text-sm font-medium">
                  <i class="fas fa-magic mr-2"></i>Write With AI
                </button>
                <button onclick="createSequence()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">Create Sequence</button>
              </div>
            </div>
          </div>

          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <input type="checkbox" id="selectAllSequences" class="rounded" onchange="toggleSelectAllSequences()">
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sequence Name</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prospects</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacted</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Opened</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Replied</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Positive</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="sequencesTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tasks Section -->
      <!-- REEMPLAZAR toda la secci√≥n tasks-section en tu index.html -->


  <!-- Tasks Toolbar
  <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <input type="text" id="tasksSearch" placeholder="Search tasks..." 
               class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64" 
               onkeyup="searchTasks()">
        <select id="tasksTypeFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterTasks()">
          <option value="">All Types</option>
          <option value="email">Email Follow-up</option>
          <option value="call">Call</option>
          <option value="follow_up">Follow Up</option>
          <option value="manual">Manual Task</option>
        </select>
        <select id="tasksPriorityFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterTasks()">
          <option value="">All Priorities</option>
          <option value="urgent">Urgent</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
      <div class="flex items-center space-x-3">
        <button onclick="bulkCompleteSelectedTasks()" id="bulkCompleteBtn" class="hidden text-green-600 hover:text-green-800 px-3 py-2 border border-green-300 rounded-lg text-sm bg-white">
          <i class="fas fa-check mr-2"></i>Mark Complete
        </button>
        <button onclick="createTask()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
          <i class="fas fa-plus mr-2"></i>Create Task
        </button>
      </div>
    </div>
  </div> -->

  <!-- Tasks List -->

<div id="tasks-section" class="content-fade hidden">
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900">Tasks</h2>
    <div class="flex items-center space-x-6 mt-4">
      <button onclick="switchTaskFilter('today')" class="task-filter-btn text-tribearium-primary border-b-2 border-tribearium-primary pb-1 text-sm font-medium" data-filter="today">
        Due Today <span class="ml-1" id="tasksDueToday">0</span>
      </button>
      <button onclick="switchTaskFilter('upcoming')" class="task-filter-btn text-gray-600 pb-1 text-sm font-medium" data-filter="upcoming">
        Upcoming <span class="ml-1" id="tasksUpcoming">0</span>
      </button>
      <button onclick="switchTaskFilter('overdue')" class="task-filter-btn text-gray-600 pb-1 text-sm font-medium" data-filter="overdue">
        Overdue <span class="ml-1" id="tasksOverdue">0</span>
      </button>
      <button onclick="switchTaskFilter('completed')" class="task-filter-btn text-gray-600 pb-1 text-sm font-medium" data-filter="completed">
        Completed <span class="ml-1" id="tasksCompleted">0</span>
      </button>
    </div>
  </div>

  <!-- Tasks Toolbar -->
  <div class="bg-white rounded-lg border border-gray-200 p-4 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <input type="text" id="tasksSearch" placeholder="Search tasks..." 
               class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64" 
               onkeyup="searchTasks()">
        <select id="tasksTypeFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterTasks()">
          <option value="">All Types</option>
          <option value="email">Email Follow-up</option>
          <option value="call">Call</option>
          <option value="follow_up">Follow Up</option>
          <option value="manual">Manual Task</option>
        </select>
        <select id="tasksPriorityFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterTasks()">
          <option value="">All Priorities</option>
          <option value="urgent">Urgent</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>
      <div class="flex items-center space-x-3">
        <button onclick="bulkCompleteSelectedTasks()" id="bulkCompleteBtn" class="hidden text-green-600 hover:text-green-800 px-3 py-2 border border-green-300 rounded-lg text-sm bg-white">
          <i class="fas fa-check mr-2"></i>Mark Complete
        </button>
        <button onclick="createTask()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
          <i class="fas fa-plus mr-2"></i>Create Task
        </button>
      </div>
    </div>
  </div>

  <!-- Tasks List Container - CON ELEMENTOS CORREGIDOS -->
  <div class="bg-white rounded-lg border border-gray-200" id="tasksContainer">
    <div class="p-6" id="tasksContent">
      <!-- Loading state inicial -->
      <div class="text-center py-16" id="tasksLoading">
        <div class="animate-pulse">
          <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-4"></i>
          <p class="text-gray-500">Loading tasks...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Task Modal -->
<div id="createTaskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-900">Create New Task</h3>
          <button onclick="closeModal('createTaskModal')" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <form id="taskForm" onsubmit="submitTaskForm(event)">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Task Title *</label>
              <input type="text" id="taskTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                     placeholder="e.g., Follow up with John from TechCorp" required>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
              <select id="taskType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="manual">Manual Task</option>
                <option value="email">Email Follow-up</option>
                <option value="call">Call</option>
                <option value="follow_up">Follow Up</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
              <select id="taskPriority" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
              <input type="datetime-local" id="taskDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Related Lead</label>
              <select id="taskLeadId" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="">Select a lead (optional)</option>
              </select>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
              <textarea id="taskDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                        placeholder="Describe what needs to be done..."></textarea>
            </div>
          </div>
          
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" onclick="closeModal('createTaskModal')" 
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
              Cancel
            </button>
            <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">
              Create Task
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Task Actions Modal -->
<div id="taskActionsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-md w-full">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-900">Task Actions</h3>
          <button onclick="closeModal('taskActionsModal')" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="space-y-3" id="taskActionsList">
          <!-- Actions populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>

      <!-- Unified Inbox Section -->
  <!-- Replace your existing inbox-section div with this updated version -->
<!-- EN TU INDEX.HTML, busca esta secci√≥n del Unified Inbox y reempl√°zala -->

<!-- Unified Inbox Section - VERSI√ìN ARREGLADA -->
<div id="inbox-section" class="content-fade hidden">
  <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-900">Unified Inbox</h2>
      <div class="flex items-center space-x-6 mt-4">
          <button data-inbox-filter="all" onclick="switchInboxFilter('all')" 
                  class="text-tribearium-primary border-b-2 border-tribearium-primary pb-1 text-sm font-medium">
              All <span class="inbox-count ml-1">0</span>
          </button>
          <button data-inbox-filter="unread" onclick="switchInboxFilter('unread')" 
                  class="text-gray-600 pb-1 text-sm font-medium">
              Unread <span class="inbox-count ml-1">0</span>
          </button>
          <button data-inbox-filter="scheduled" onclick="switchInboxFilter('scheduled')" 
                  class="text-gray-600 pb-1 text-sm font-medium">
              Scheduled <span class="inbox-count ml-1">0</span>
          </button>
          <button data-inbox-filter="draft" onclick="switchInboxFilter('draft')" 
                  class="text-gray-600 pb-1 text-sm font-medium">
              Draft <span class="inbox-count ml-1">0</span>
          </button>
      </div>
  </div>
  
  <!-- Inbox Content Container - ARREGLADO PARA MANTENERSE EN CONTAINER -->
  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden" style="height: 600px;">
      <div class="flex h-full">
          <!-- Conversations List Panel - ARREGLADO -->
          <div class="w-1/3 border-r border-gray-200 flex flex-col max-w-sm">
              <!-- Search Header -->
              <div class="p-4 border-b border-gray-200 bg-gray-50 flex-shrink-0">
                  <div class="relative">
                      <input type="text" id="inboxSearch" placeholder="Search conversations..." 
                             class="w-full px-3 py-2 pl-9 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                             onkeyup="searchInboxConversations()">
                      <i class="fas fa-search absolute left-3 top-3 text-gray-400 text-sm"></i>
                  </div>
              </div>
              
              <!-- Conversations List - CON SCROLL CONTENIDO -->
              <div id="conversations-list" class="flex-1 overflow-y-auto">
                  <!-- Initial loading state -->
                  <div class="text-center py-16">
                      <div class="animate-pulse">
                          <i class="fas fa-envelope text-4xl text-gray-300 mb-4"></i>
                          <p class="text-gray-500">Loading conversations...</p>
                      </div>
                  </div>
              </div>
          </div>
          
          <!-- Conversation Details Panel - ARREGLADO -->
          <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
              <div id="conversation-details" class="flex-1 flex flex-col overflow-hidden">
                  <!-- Initial empty state -->
                  <div class="flex items-center justify-center h-full bg-gray-50">
                      <div class="text-center">
                          <i class="fas fa-comments text-6xl text-gray-300 mb-4"></i>
                          <h3 class="text-lg font-medium text-gray-900 mb-2">No conversation selected</h3>
                          <p class="text-gray-500 max-w-sm">Choose a conversation from the left to view the email thread and engagement details.</p>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
  
  <!-- Inbox Statistics Panel - MANTIENE EL DISE√ëO ORIGINAL -->
  <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="flex items-center">
              <div class="p-2 bg-blue-100 rounded-lg">
                  <i class="fas fa-envelope text-blue-600"></i>
              </div>
              <div class="ml-3">
                  <p class="text-sm font-medium text-gray-500">Total Conversations</p>
                  <p class="text-2xl font-semibold text-gray-900" id="total-conversations">0</p>
              </div>
          </div>
      </div>
      
      <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="flex items-center">
              <div class="p-2 bg-green-100 rounded-lg">
                  <i class="fas fa-eye text-green-600"></i>
              </div>
              <div class="ml-3">
                  <p class="text-sm font-medium text-gray-500">Opened Emails</p>
                  <p class="text-2xl font-semibold text-gray-900" id="total-opens">0</p>
              </div>
          </div>
      </div>
      
      <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="flex items-center">
              <div class="p-2 bg-purple-100 rounded-lg">
                  <i class="fas fa-reply text-purple-600"></i>
              </div>
              <div class="ml-3">
                  <p class="text-sm font-medium text-gray-500">Replies Received</p>
                  <p class="text-2xl font-semibold text-gray-900" id="total-replies">0</p>
              </div>
          </div>
      </div>
      
      <div class="bg-white p-4 rounded-lg border border-gray-200">
          <div class="flex items-center">
              <div class="p-2 bg-yellow-100 rounded-lg">
                  <i class="fas fa-bell text-yellow-600"></i>
              </div>
              <div class="ml-3">
                  <p class="text-sm font-medium text-gray-500">Unread</p>
                  <p class="text-2xl font-semibold text-gray-900" id="total-unread">0</p>
              </div>
          </div>
      </div>
  </div>
</div>

<!-- TAMBI√âN AGREGA ESTE CSS AL <head> de tu HTML para mejorar el contenedor -->
<style>
.inbox-conversation-item {
    max-width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.inbox-content {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

#conversation-details {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
}

/* Arreglar el texto que se sale */
.email-item {
    max-width: 100%;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.email-item h4, 
.email-item p {
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Mejorar el scroll en conversaciones */
#conversations-list::-webkit-scrollbar {
    width: 6px;
}

#conversations-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#conversations-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

#conversations-list::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}
</style>
      <!-- Client Management Section -->
      <div id="clients-section" class="content-fade hidden">
        <div class="mb-6">
          <div class="flex items-center justify-between">
            <h2 class="text-2xl font-bold text-gray-900">Client Management</h2>
            <button onclick="addClient()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">Add Client</button>
          </div>
        </div>

        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <input type="text" id="clientSearch" placeholder="Search clients..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-64" onkeyup="filterClients()">
          </div>

          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client Name</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Active Sequences</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Active Email Account</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Prospects</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Email Sent</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Permission</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created On</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="clientsTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

<!-- Lead Finder Section -->
<!-- LEADFINDER SECTION ACTUALIZADO CON SCRAPERCITY REAL -->
<!-- LEADFINDER SECTION COMPLETO -->
<div id="leadfinder-section" class="content-fade p-6">
  <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-900">Lead Finder</h2>
      <div class="flex items-center space-x-6 mt-4">
          <button class="text-purple-600 border-b-2 border-purple-600 pb-1 text-sm font-medium">People</button>
          <button class="text-gray-600 pb-1 text-sm font-medium">Saved</button>
      </div>
  </div>

  <div class="bg-white rounded-lg border border-gray-200">
      <div class="flex">
          <!-- Filters Sidebar - EXACTAMENTE como Apollo -->
          <div class="w-80 border-r border-gray-200 p-6">
              <div class="space-y-4">
                  <!-- AI Search -->
                  <div class="border border-gray-200 rounded-lg p-3">
                      <h4 class="font-medium mb-3">
                          <i class="fas fa-magic mr-2 text-purple-600"></i>AI Search
                      </h4>
                      <textarea id="bulkSearchText" 
                                placeholder="Find CEOs in technology companies..." 
                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm h-20"></textarea>
                  </div>
                  
                  <!-- Location Filter -->
                  <div class="border border-gray-200 rounded-lg p-3">
                      <h4 class="font-medium mb-3">
                          <i class="fas fa-map-marker-alt mr-2 text-blue-600"></i>Location
                      </h4>
                      <input type="text" 
                             id="locationFilter" 
                             placeholder="e.g. Miami, New York, California" 
                             class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                      <div class="text-xs text-gray-500 mt-1">
                          Apollo: personLocations[]
                      </div>
                  </div>
                  
                  <!-- Job Titles -->
                  <div class="border border-gray-200 rounded-lg p-3">
                      <h4 class="font-medium mb-3">
                          <i class="fas fa-user-tie mr-2 text-green-600"></i>Job Titles
                      </h4>
                      <select id="jobTitleFilter" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                          <option value="">Any Title</option>
                          <option value="CEO">CEO</option>
                          <option value="CFO">CFO</option>
                          <option value="CTO">CTO</option>
                          <option value="COO">COO</option>
                          <option value="Owner">Owner</option>
                          <option value="Founder">Founder</option>
                          <option value="President">President</option>
                          <option value="VP">VP / Vice President</option>
                          <option value="Director">Director</option>
                          <option value="Manager">Manager</option>
                          <option value="Head">Head of Department</option>
                      </select>
                      <div class="text-xs text-gray-500 mt-1">
                          Apollo: personTitles[]
                      </div>
                  </div>
                  
                  <!-- Industry -->
                  <div class="border border-gray-200 rounded-lg p-3">
                      <h4 class="font-medium mb-3">
                          <i class="fas fa-industry mr-2 text-orange-600"></i>Industry
                      </h4>
                      <select id="industryFilter" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                          <option value="">Any Industry</option>
                          <option value="Technology">Technology</option>
                          <option value="Software">Software</option>
                          <option value="Finance">Finance</option>
                          <option value="Healthcare">Healthcare</option>
                          <option value="Manufacturing">Manufacturing</option>
                          <option value="Construction">Construction</option>
                          <option value="Real Estate">Real Estate</option>
                          <option value="Retail">Retail</option>
                          <option value="E-commerce">E-commerce</option>
                          <option value="Marketing">Marketing</option>
                          <option value="Consulting">Consulting</option>
                          <option value="Legal">Legal Services</option>
                          <option value="Insurance">Insurance</option>
                          <option value="Education">Education</option>
                          <option value="Transportation">Transportation</option>
                      </select>
                      <div class="text-xs text-gray-500">
                          Apollo: organizationIndustryTagIds[]
                      </div>
                  </div>
                  
                  <!-- Company Size -->
                  <div class="border border-gray-200 rounded-lg p-3">
                      <h4 class="font-medium mb-3">
                          <i class="fas fa-users mr-2 text-indigo-600"></i>Company Size
                      </h4>
                      <select id="companySizeFilter" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                          <option value="">Any Size</option>
                          <option value="1-10">1-10 employees</option>
                          <option value="11-50">11-50 employees</option>
                          <option value="51-200">51-200 employees</option>
                          <option value="201-500">201-500 employees</option>
                          <option value="501-1000">501-1000 employees</option>
                          <option value="1001-5000">1001-5000 employees</option>
                          <option value="5001+">5001+ employees</option>
                      </select>
                      <div class="text-xs text-gray-500">
                          Apollo: organizationNumEmployeesRanges[]
                      </div>
                  </div>
                  
                  <!-- Revenue Filter -->
                  <div class="border border-gray-200 rounded-lg p-3">
                      <h4 class="font-medium mb-3">
                          <i class="fas fa-dollar-sign mr-2 text-green-600"></i>Annual Revenue
                      </h4>
                      <select id="revenueFilter" class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                          <option value="">Any Revenue</option>
                          <option value="0-1M">$0 - $1M</option>
                          <option value="1M-10M">$1M - $10M</option>
                          <option value="10M-50M">$10M - $50M</option>
                          <option value="50M-100M">$50M - $100M</option>
                          <option value="100M-500M">$100M - $500M</option>
                          <option value="500M+">$500M+</option>
                      </select>
                  </div>
              </div>
              
              <!-- Search Buttons -->
              <div class="mt-6 space-y-3">
                  <button onclick="runScraperCitySearch()" 
                          class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg text-sm font-medium hover:from-purple-700 hover:to-blue-700 transition-all shadow-lg">
                      <i class="fas fa-search mr-2"></i>Search via ScraperCity
                  </button>
                  
                  <button onclick="clearAllFilters()" 
                          class="w-full py-2 border border-gray-300 rounded-lg text-sm text-gray-600 hover:bg-gray-50">
                      Clear All Filters
                  </button>
              </div>
              
              <!-- Data Source Indicator -->
              <div class="mt-4 p-3 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg border">
                  <div class="text-xs font-medium text-gray-700 mb-2">Data Pipeline:</div>
                  <div class="space-y-1 text-xs">
                      <div class="flex items-center">
                          <div class="w-2 h-2 bg-purple-500 rounded-full mr-2 animate-pulse"></div>
                          <span>Apollo.io Database</span>
                      </div>
                      <div class="flex items-center">
                          <div class="w-2 h-2 bg-blue-500 rounded-full mr-2 animate-pulse"></div>
                          <span>ScraperCity API</span>
                      </div>
                      <div class="flex items-center">
                          <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                          <span>Real-time Extraction</span>
                      </div>
                  </div>
              </div>
          </div>

          <!-- Main Content Area -->
          <div class="flex-1 p-6">
              <!-- Initial State -->
              <div id="leadFinderInitialContent" class="text-center py-16">
                  <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                      <i class="fas fa-rocket text-3xl text-white"></i>
                  </div>
                  <h3 class="text-2xl font-bold text-gray-900 mb-3">Real Apollo.io Data via ScraperCity</h3>
                  <p class="text-gray-600 mb-6 max-w-md mx-auto">
                      Search Apollo's 250M+ contact database. Get up to 500 verified contacts per search.
                  </p>

                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto mb-8">
                      <div class="p-4 bg-purple-50 rounded-lg">
                          <i class="fas fa-database text-purple-600 text-2xl mb-2"></i>
                          <div class="text-sm font-medium text-gray-900">Apollo.io</div>
                          <div class="text-xs text-gray-600">250M+ contacts</div>
                      </div>
                      <div class="p-4 bg-blue-50 rounded-lg">
                          <i class="fas fa-bolt text-blue-600 text-2xl mb-2"></i>
                          <div class="text-sm font-medium text-gray-900">ScraperCity</div>
                          <div class="text-xs text-gray-600">Real-time extraction</div>
                      </div>
                      <div class="p-4 bg-green-50 rounded-lg">
                          <i class="fas fa-check-circle text-green-600 text-2xl mb-2"></i>
                          <div class="text-sm font-medium text-gray-900">500 Contacts</div>
                          <div class="text-xs text-gray-600">Per search</div>
                      </div>
                  </div>
              </div>
              
              <!-- Loading State -->
              <div id="searchLoadingState" class="hidden text-center py-16">
                  <div class="relative mx-auto mb-6">
                      <div class="w-16 h-16 border-4 border-purple-600 border-t-transparent rounded-full mx-auto animate-spin"></div>
                  </div>
                  <h3 class="text-xl font-bold text-gray-900 mb-2">Extracting from Apollo.io...</h3>
                  <p class="text-gray-600 mb-6">ScraperCity is processing your search</p>
                  
                  <div class="max-w-md mx-auto">
                      <div class="space-y-3 text-sm">
                          <div id="loadingStep1" class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                              <span><i class="fas fa-link mr-2"></i>Building Apollo URL...</span>
                              <i class="fas fa-spinner fa-spin text-blue-600"></i>
                          </div>
                          <div id="loadingStep2" class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
                              <span><i class="fas fa-paper-plane mr-2"></i>Sending to ScraperCity...</span>
                              <i class="fas fa-spinner fa-spin text-purple-600"></i>
                          </div>
                          <div id="loadingStep3" class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                              <span><i class="fas fa-database mr-2"></i>Extracting contacts...</span>
                              <i class="fas fa-spinner fa-spin text-green-600"></i>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Progress Counter -->
                  <div id="progressCounter" class="mt-6 text-lg font-semibold text-gray-700 hidden">
                      Found: <span id="currentLeadCount" class="text-purple-600">0</span> / <span class="text-gray-500">500</span> leads
                  </div>
              </div>
              
              <!-- Search Results -->
              <div id="searchResults" class="hidden">
                  <!-- Results Header -->
                  <div class="flex items-center justify-between mb-6 p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border">
                      <div class="flex items-center space-x-4">
                          <label class="flex items-center space-x-2 cursor-pointer">
                              <input type="checkbox" id="selectAllLeads" onchange="toggleSelectAllLeads()" 
                                     class="rounded text-purple-600">
                              <span class="text-sm font-medium">Select all</span>
                          </label>
                          <div class="text-sm text-gray-600">
                              <span id="selectedLeadsCount" class="font-bold">0</span> selected of 
                              <span id="totalLeadsCount" class="font-bold">0</span> results
                          </div>
                      </div>
                      
                      <div class="flex items-center space-x-3">
                          <button onclick="addSelectedAsProspects()" id="addProspectsBtn" 
                                  class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">
                              <i class="fas fa-user-plus mr-2"></i>Add as Prospects
                          </button>
                          <button onclick="exportSelectedLeads()" id="exportBtn" 
                                  class="hidden bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">
                              <i class="fas fa-download mr-2"></i>Export CSV
                          </button>
                      </div>
                  </div>

                  <!-- Results List -->
                  <div id="searchResultsList" class="space-y-4">
                      <!-- Results will be populated here -->
                  </div>
              </div>
          </div>
      </div>
  </div>
</div>

<!-- MODAL MEJORADO PARA VER DETALLES DEL LEAD -->
<div id="leadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50">
      <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-900">Lead Details</h2>
        <button onclick="closeleadModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="p-6">
      <div class="flex items-start space-x-4 mb-6">
        <div id="modalAvatar" class="w-20 h-20 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg"></div>
        <div class="flex-1">
          <h3 id="modalName" class="text-xl font-bold text-gray-900"></h3>
          <p id="modalTitle" class="text-gray-600"></p>
          <p id="modalCompany" class="text-gray-500"></p>
        </div>
        <div id="modalSource" class="px-3 py-1 rounded-full text-xs font-bold shadow"></div>
      </div>
      
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-gray-50 p-3 rounded-lg">
            <label class="text-xs text-gray-500 uppercase tracking-wider">Email</label>
            <p id="modalEmail" class="text-sm font-medium text-gray-900 mt-1 break-all"></p>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <label class="text-xs text-gray-500 uppercase tracking-wider">Phone</label>
            <p id="modalPhone" class="text-sm font-medium text-gray-900 mt-1"></p>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <label class="text-xs text-gray-500 uppercase tracking-wider">Location</label>
            <p id="modalLocation" class="text-sm font-medium text-gray-900 mt-1"></p>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <label class="text-xs text-gray-500 uppercase tracking-wider">Industry</label>
            <p id="modalIndustry" class="text-sm font-medium text-gray-900 mt-1"></p>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <label class="text-xs text-gray-500 uppercase tracking-wider">Company Size</label>
            <p id="modalCompanySize" class="text-sm font-medium text-gray-900 mt-1"></p>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <label class="text-xs text-gray-500 uppercase tracking-wider">Employees</label>
            <p id="modalEmployees" class="text-sm font-medium text-gray-900 mt-1"></p>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-2 pt-4">
          <span id="modalScore" class="px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"></span>
          <span id="modalSeniority" class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"></span>
          <span id="modalQualified" class="px-3 py-1 rounded-full text-xs font-medium"></span>
          <span id="modalVerified" class="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
            <i class="fas fa-check-circle mr-1"></i>Email Verified
          </span>
        </div>
        
        <div class="flex gap-3 pt-4 border-t">
          <a id="modalLinkedIn" href="#" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-2 px-4 rounded-lg hover:bg-blue-700 transition">
            <i class="fab fa-linkedin mr-2"></i>LinkedIn
          </a>
          <a id="modalWebsite" href="#" target="_blank" class="flex-1 bg-gray-600 text-white text-center py-2 px-4 rounded-lg hover:bg-gray-700 transition">
            <i class="fas fa-globe mr-2"></i>Website
          </a>
          <button onclick="addLeadToSequence()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition">
            <i class="fas fa-envelope mr-2"></i>Add to Sequence
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JAVASCRIPT COMPLETO CON TODOS LOS FIXES -->
<script>
  // ========== SCRAPERCITY REAL-TIME INTEGRATION - VERSI√ìN FINAL ARREGLADA ==========
  let scraperCityResults = [];
  let selectedLeadIds = [];
  let currentSearchParams = {};
  let currentApolloUrl = '';
  let currentRunId = null;
  let pollInterval = null;
  let pollAttempts = 0;
  let currentLeadForModal = null;
  let timerInterval = null;
  
  // FUNCI√ìN PRINCIPAL - Iniciar b√∫squeda REAL con ScraperCity
  async function runScraperCitySearch() {
      try {
          console.log('üöÄ Starting REAL ScraperCity + Apollo search...');
          
          // Limpiar resultados anteriores y timers
          clearInterval(pollInterval);
          clearInterval(timerInterval);
          scraperCityResults = [];
          currentRunId = null;
          pollAttempts = 0;
          
          // Mostrar estado de carga
          showRealTimeLoadingState();
          
          // Recoger par√°metros de b√∫squeda
          const searchData = {
              location: document.getElementById('locationFilter')?.value || '',
              jobTitle: document.getElementById('jobTitleFilter')?.value || '',
              industry: document.getElementById('industryFilter')?.value || '',
              companySize: document.getElementById('companySizeFilter')?.value || '',
              revenue: document.getElementById('revenueFilter')?.value || '',
              count: 500
          };
          
          // Validar que hay al menos un filtro
          if (!searchData.location && !searchData.jobTitle && !searchData.industry) {
              showNotification('Por favor selecciona al menos un filtro', 'warning');
              hideLoadingState();
              return;
          }
          
          currentSearchParams = searchData;
          console.log('Search params:', searchData);
          
          // Llamar al backend para iniciar ScraperCity
          const response = await fetch('/api/apollo-scraper', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(searchData)
          });
          
          const data = await response.json();
          
          if (data.success) {
              console.log('‚úÖ ScraperCity b√∫squeda iniciada');
              currentApolloUrl = data.apolloUrl || '';
              console.log('Apollo URL:', currentApolloUrl);
              
              if (data.runId) {
                  currentRunId = data.runId;
                  console.log('Run ID:', currentRunId);
              }
              
              updateLoadingProgress('initiated');
              
              // IMPORTANTE: Aumentar tiempo de espera para que ScraperCity procese todos los 457 leads
              setTimeout(() => {
                  startPollingForResults();
              }, 5000); // Esperar 5 segundos antes de empezar el polling
              
          } else {
              throw new Error(data.message || 'Error al iniciar b√∫squeda');
          }
          
      } catch (error) {
          console.error('‚ùå Error:', error);
          hideLoadingState();
          showNotification('Error: ' + error.message, 'error');
      }
  }
  
  // POLLING MEJORADO - Busca leads con mejor timing
  function startPollingForResults() {
      console.log('‚è≥ Iniciando polling para resultados...');
      pollAttempts = 0;
      const maxAttempts = 90; // 10 minutos m√°ximo (60 * 10 segundos)
      
      // Mostrar contador de progreso
      document.getElementById('progressCounter').classList.remove('hidden');
      
      pollInterval = setInterval(async () => {
          pollAttempts++;
          console.log(`üîÑ Intento de polling ${pollAttempts}/${maxAttempts}`);
          
          const progress = Math.min((pollAttempts / maxAttempts) * 100, 90);
          updateLoadingProgress('processing', progress);
          
          try {
              // Buscar TODOS los leads, no solo los recientes
              // Cambio importante: buscar leads con source espec√≠fico de ScraperCity
              const response = await fetch('/api/leads?limit=500&sort=created_at&order=desc');
              const data = await response.json();
              
              if (data.success && data.data && data.data.length > 0) {
                  console.log(`Encontrados ${data.data.length} leads totales en la base de datos`);
                  const fifteenMinutesAgo = new Date(Date.now() - 15 * 60 * 1000);
                  
                  // Filtrar leads de ScraperCity creados en los √∫ltimos 10 minutos
                  const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
                  const scraperCityLeads = data.data.filter(lead => {
                      const leadDate = new Date(lead.created_at);
                      const isRecent = leadDate > tenMinutesAgo;
                      const isFromScraperCity = lead.source === 'apollo_via_scrapercity' || 
                                               lead.source?.includes('apollo') ||
                                               lead.source?.includes('scrapercity');
                      
                      // EXCLUIR datos de prueba
                      const isTestData = lead.source === 'test_fallback' || 
                                        lead.source === 'test' || 
                                        lead.source === 'fallback';
                      
                      return isRecent && isFromScraperCity && !isTestData;
                  });
                  
                  // Actualizar contador
                  if (scraperCityLeads.length > 0) {
                      document.getElementById('currentLeadCount').textContent = scraperCityLeads.length;
                  }
                  
                  // Si encontramos suficientes leads (m√°s del 80% del esperado) o han pasado muchos intentos
                  if (scraperCityLeads.length >= 400 || (scraperCityLeads.length >= 50 && pollAttempts >= 20)) {
                      console.log(`‚úÖ Encontrados ${scraperCityLeads.length} leads de ScraperCity!`);
                      clearInterval(pollInterval);
                      displayRealScraperCityResults(scraperCityLeads);
                      return;
                  }
                  
                  // Log de progreso
                  if (scraperCityLeads.length > 0) {
                      console.log(`üìä Progreso: ${scraperCityLeads.length} leads encontrados hasta ahora...`);
                  }
              }
              
              // Si llegamos al m√°ximo de intentos
              if (pollAttempts >= maxAttempts) {
                  console.log('‚ö†Ô∏è Tiempo m√°ximo alcanzado');
                  clearInterval(pollInterval);
                  
                  // Buscar todos los leads de apollo/scrapercity sin l√≠mite de tiempo
                  const finalResponse = await fetch('/api/leads?limit=500&sort=created_at&order=desc');
                  const finalData = await finalResponse.json();
                  
                  if (finalData.success && finalData.data) {
                      const apolloLeads = finalData.data.filter(lead => {
                          const isFromApollo = lead.source?.includes('apollo') || 
                                             lead.source?.includes('scrapercity');
                          const isNotTest = !lead.source?.includes('test') && 
                                          !lead.source?.includes('fallback');
                          return isFromApollo && isNotTest;
                      });
                      
                      if (apolloLeads.length > 0) {
                          console.log(`Mostrando ${apolloLeads.length} leads de Apollo/ScraperCity`);
                          displayRealScraperCityResults(apolloLeads);
                      } else {
                          hideLoadingState();
                          displayNoResults('No se encontraron resultados. Intenta hacer otra b√∫squeda.');
                      }
                  }
              }
              
          } catch (error) {
              console.error('‚ùå Error en polling:', error);
          }
          
      }, 10000); // Poll cada 10 segundos
  }
  
  // Mostrar resultados REALES
  function displayRealScraperCityResults(leads) {
      console.log('üìä Mostrando resultados:', leads.length);
      
      hideLoadingState();
      clearInterval(pollInterval);
      clearInterval(timerInterval);
      document.getElementById('leadFinderInitialContent').classList.add('hidden');
      
      if (!leads || leads.length === 0) {
          displayNoResults('No se encontraron leads.');
          return;
      }
      
      scraperCityResults = leads;
      document.getElementById('totalLeadsCount').textContent = leads.length;
      
      const container = document.getElementById('searchResultsList');
      container.innerHTML = leads.map(lead => createDetailedLeadCard(lead)).join('');
      
      document.getElementById('searchResults').classList.remove('hidden');
      showNotification(`‚úÖ ¬°Encontrados ${leads.length} leads reales!`, 'success');
  }
  
  // Crear card detallada del lead
  function createDetailedLeadCard(lead) {
      const sourceInfo = getSourceInfo(lead.source);
      
      return `
          <div class="lead-card bg-white border-2 border-gray-200 rounded-xl p-6 hover:shadow-2xl transition-all duration-300 hover:border-purple-300" 
               data-lead-id="${lead.id}">
              <div class="flex items-start gap-4">
                  <input type="checkbox" 
                         class="lead-checkbox mt-1 w-5 h-5 text-purple-600 rounded focus:ring-purple-500" 
                         data-lead-id="${lead.id}"
                         onchange="updateSelectedLeads()">
                  
                  <div class="flex-shrink-0">
                      <div class="w-16 h-16 rounded-full ${getAvatarGradient(lead.name)} flex items-center justify-center text-white font-bold text-xl shadow-lg">
                          ${getInitials(lead.name)}
                      </div>
                  </div>
                  
                  <div class="flex-1">
                      <div class="flex items-start justify-between mb-2">
                          <div>
                              <h3 class="text-xl font-bold text-gray-900">${lead.name || 'Sin nombre'}</h3>
                              <p class="text-sm font-medium text-gray-700">${lead.title || 'Sin t√≠tulo'}</p>
                              <p class="text-sm text-gray-600">${lead.company || 'Sin empresa'}</p>
                          </div>
                          
                          <div class="flex flex-col items-end gap-2">
                              <div class="${sourceInfo.badgeClass} px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1.5 shadow-md">
                                  <i class="${sourceInfo.icon}"></i>
                                  ${sourceInfo.label}
                              </div>
                              ${lead.source?.includes('scrapercity') ? 
                                  '<span class="text-xs text-gray-500">via ScraperCity</span>' : ''}
                          </div>
                      </div>
                      
                      <div class="grid grid-cols-2 gap-3 mt-4 p-3 bg-gray-50 rounded-lg">
                          <div class="flex items-center gap-2">
                              <i class="fas fa-envelope text-gray-400 w-4"></i>
                              <span class="text-sm text-gray-700 truncate" title="${lead.email || 'Sin email'}">
                                  ${lead.email || 'Sin email'}
                              </span>
                          </div>
                          
                          <div class="flex items-center gap-2">
                              <i class="fas fa-phone text-gray-400 w-4"></i>
                              <span class="text-sm text-gray-700">
                                  ${lead.phone || 'Sin tel√©fono'}
                              </span>
                          </div>
                          
                          <div class="flex items-center gap-2">
                              <i class="fas fa-map-marker-alt text-gray-400 w-4"></i>
                              <span class="text-sm text-gray-700">
                                  ${lead.location || 'Sin ubicaci√≥n'}
                              </span>
                          </div>
                          
                          <div class="flex items-center gap-2">
                              <i class="fas fa-globe text-gray-400 w-4"></i>
                              ${lead.website ? 
                                  `<a href="${lead.website}" target="_blank" class="text-sm text-blue-600 hover:underline">Website</a>` : 
                                  '<span class="text-sm text-gray-700">Sin website</span>'}
                          </div>
                      </div>
                      
                      <div class="flex flex-wrap gap-2 mt-3">
                          ${lead.industry ? `
                              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                  <i class="fas fa-industry mr-1 text-xs"></i>${lead.industry}
                              </span>
                          ` : ''}
                          ${lead.company_size ? `
                              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                  <i class="fas fa-users mr-1 text-xs"></i>${lead.company_size}
                              </span>
                          ` : ''}
                          ${lead.seniority_level ? `
                              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                  <i class="fas fa-user-tie mr-1 text-xs"></i>${lead.seniority_level}
                              </span>
                          ` : ''}
                          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                              <i class="fas fa-star mr-1 text-xs"></i>Score: ${lead.score || 0}
                          </span>
                          ${lead.qualified ? `
                              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                  <i class="fas fa-check-circle mr-1 text-xs"></i>Calificado
                              </span>
                          ` : ''}
                      </div>
                      
                      ${lead.linkedin_url ? `
                          <div class="mt-3">
                              <a href="${lead.linkedin_url}" target="_blank" 
                                 class="inline-flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 font-medium">
                                  <i class="fab fa-linkedin"></i>Ver LinkedIn
                              </a>
                          </div>
                      ` : ''}
                  </div>
                  
                  <div class="flex-shrink-0 flex flex-col gap-2">
                      <button onclick='viewLeadDetails(${JSON.stringify(lead).replace(/'/g, "\\'")})' 
                              class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                          <i class="fas fa-eye mr-1"></i>Ver
                      </button>
                      <button onclick="addSingleProspect('${lead.id}')" 
                              class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                          <i class="fas fa-user-plus mr-1"></i>A√±adir
                      </button>
                  </div>
              </div>
          </div>
      `;
  }
  
  // FUNCI√ìN MEJORADA para ver detalles del lead con el modal bonito
  function viewLeadDetails(lead) {
      currentLeadForModal = lead;
      
      // Populate modal with lead data
      document.getElementById('modalAvatar').className = `w-20 h-20 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-lg ${getAvatarGradient(lead.name)}`;
      document.getElementById('modalAvatar').textContent = getInitials(lead.name);
      
      document.getElementById('modalName').textContent = lead.name || 'Sin nombre';
      document.getElementById('modalTitle').textContent = lead.title || 'Sin t√≠tulo';
      document.getElementById('modalCompany').textContent = lead.company || 'Sin empresa';
      document.getElementById('modalEmail').textContent = lead.email || 'Sin email';
      document.getElementById('modalPhone').textContent = lead.phone || 'Sin tel√©fono';
      document.getElementById('modalLocation').textContent = lead.location || 'Sin ubicaci√≥n';
      document.getElementById('modalIndustry').textContent = lead.industry || 'Sin industria';
      document.getElementById('modalCompanySize').textContent = lead.company_size || 'Desconocido';
      document.getElementById('modalEmployees').textContent = lead.employee_count || 'N/A';
      
      // Score and status
      document.getElementById('modalScore').textContent = `Score: ${lead.score || 0}`;
      document.getElementById('modalSeniority').textContent = lead.seniority_level || 'Staff';
      
      const qualifiedEl = document.getElementById('modalQualified');
      if (lead.qualified) {
          qualifiedEl.textContent = '‚úì Calificado';
          qualifiedEl.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
      } else {
          qualifiedEl.textContent = 'No Calificado';
          qualifiedEl.className = 'px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600';
      }
      
      // Source badge
      const sourceInfo = getSourceInfo(lead.source);
      const sourceEl = document.getElementById('modalSource');
      sourceEl.className = `px-3 py-1 rounded-full text-xs font-bold shadow ${sourceInfo.badgeClass}`;
      sourceEl.innerHTML = `<i class="${sourceInfo.icon} mr-1"></i>${sourceInfo.label}`;
      
      // Links
      const linkedInBtn = document.getElementById('modalLinkedIn');
      const websiteBtn = document.getElementById('modalWebsite');
      
      if (lead.linkedin_url) {
          linkedInBtn.href = lead.linkedin_url;
          linkedInBtn.classList.remove('hidden');
      } else {
          linkedInBtn.classList.add('hidden');
      }
      
      if (lead.website || lead.company_website) {
          websiteBtn.href = lead.website || lead.company_website;
          websiteBtn.classList.remove('hidden');
      } else {
          websiteBtn.classList.add('hidden');
      }
      
      // Show modal
      document.getElementById('leadModal').classList.remove('hidden');
  }
  
  function closeleadModal() {
      document.getElementById('leadModal').classList.add('hidden');
      currentLeadForModal = null;
  }
  
  function addLeadToSequence() {
      if (currentLeadForModal) {
          console.log('A√±adiendo lead a secuencia:', currentLeadForModal.id);
          showNotification('Lead a√±adido a la secuencia de email', 'success');
          closeleadModal();
      }
  }
  
  // Close modal on background click
  document.getElementById('leadModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
          closeleadModal();
      }
  });
  
  // Funciones adicionales necesarias
  function addSingleProspect(leadId) {
      console.log('A√±adiendo prospecto:', leadId);
      fetch('/api/add-prospect', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({leadId: leadId})
      }).then(response => {
          if(response.ok) {
              showNotification('¬°Lead a√±adido como prospecto!', 'success');
          }
      });
  }
  
  function toggleSelectAllLeads() {
      const selectAll = document.getElementById('selectAllLeads');
      const checkboxes = document.querySelectorAll('.lead-checkbox');
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
      updateSelectedLeads();
  }
  
  function addSelectedAsProspects() {
      if(selectedLeadIds.length === 0) {
          showNotification('No hay leads seleccionados', 'warning');
          return;
      }
      console.log('A√±adiendo prospectos:', selectedLeadIds);
      showNotification(`A√±adiendo ${selectedLeadIds.length} prospectos...`, 'info');
  }
  
  function exportSelectedLeads() {
      if(selectedLeadIds.length === 0) {
          showNotification('No hay leads seleccionados', 'warning');
          return;
      }
      console.log('Exportando leads:', selectedLeadIds);
      
      // Crear CSV con los leads seleccionados
      const selectedLeads = scraperCityResults.filter(lead => 
          selectedLeadIds.includes(lead.id?.toString())
      );
      const csv = convertToCSV(selectedLeads);
      downloadCSV(csv, 'leads_export.csv');
  }
  
  // Helper functions
  function getSourceInfo(source) {
      const sourceMap = {
          'apollo_via_scrapercity': {
              label: 'Apollo.io',
              icon: 'fas fa-database',
              badgeClass: 'bg-gradient-to-r from-purple-500 to-purple-700 text-white'
          },
          'test_fallback': {
              label: 'Test Data',
              icon: 'fas fa-vial',
              badgeClass: 'bg-gradient-to-r from-gray-500 to-gray-700 text-white'
          },
          'linkedin': {
              label: 'LinkedIn',
              icon: 'fab fa-linkedin',
              badgeClass: 'bg-gradient-to-r from-blue-500 to-blue-700 text-white'
          }
      };
      
      // Si el source contiene "apollo" o "scrapercity", usar Apollo
      if (source && (source.toLowerCase().includes('apollo') || source.toLowerCase().includes('scrapercity'))) {
          return sourceMap['apollo_via_scrapercity'];
      }
      
      return sourceMap[source] || {
          label: source || 'Desconocido',
          icon: 'fas fa-circle',
          badgeClass: 'bg-gray-500 text-white'
      };
  }
  
  function getAvatarGradient(name) {
      const gradients = [
          'bg-gradient-to-br from-purple-400 to-purple-600',
          'bg-gradient-to-br from-blue-400 to-blue-600',
          'bg-gradient-to-br from-green-400 to-green-600',
          'bg-gradient-to-br from-yellow-400 to-yellow-600',
          'bg-gradient-to-br from-red-400 to-red-600',
          'bg-gradient-to-br from-indigo-400 to-indigo-600'
      ];
      
      const index = name ? name.charCodeAt(0) % gradients.length : 0;
      return gradients[index];
  }
  
  function getInitials(name) {
      if (!name) return '?';
      const parts = name.split(' ').filter(p => p.length > 0);
      if (parts.length >= 2) {
          return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
  }
  
  // Estados de loading
  function showRealTimeLoadingState() {
      document.getElementById('leadFinderInitialContent').classList.add('hidden');
      document.getElementById('searchResults').classList.add('hidden');
      
      const loadingState = document.getElementById('searchLoadingState');
      loadingState.classList.remove('hidden');
      
      // Timer
      if (!document.getElementById('timeElapsed')) {
          const timerDiv = document.createElement('div');
          timerDiv.id = 'timeElapsed';
          timerDiv.className = 'text-center mt-4 text-sm text-gray-600';
          timerDiv.innerHTML = '<i class="fas fa-clock mr-2"></i>Tiempo transcurrido: <span id="timer">0:00</span>';
          loadingState.appendChild(timerDiv);
      }
      
      let seconds = 0;
      timerInterval = setInterval(() => {
          seconds++;
          const minutes = Math.floor(seconds / 60);
          const secs = seconds % 60;
          const timerEl = document.getElementById('timer');
          if (timerEl) {
              timerEl.textContent = `${minutes}:${secs.toString().padStart(2, '0')}`;
          }
          
          if (seconds >= 600) { // 10 minutos m√°ximo
              clearInterval(timerInterval);
          }
      }, 1000);
  }
  
  function updateLoadingProgress(status, progress = 0) {
      const steps = {
          'initiated': { step: 1, text: 'Apollo URL generada' },
          'processing': { step: 2, text: `ScraperCity extrayendo... ${Math.round(progress)}%` },
          'completed': { step: 3, text: 'Procesando resultados' }
      };
      
      if (steps[status]) {
          for (let i = 1; i <= 3; i++) {
              const stepEl = document.getElementById(`loadingStep${i}`);
              if (stepEl) {
                  const icon = stepEl.querySelector('i:last-child');
                  if (i < steps[status].step) {
                      icon.className = 'fas fa-check text-green-600';
                  } else if (i === steps[status].step) {
                      icon.className = 'fas fa-spinner fa-spin text-purple-600';
                      if (i === 2) {
                          stepEl.querySelector('span').innerHTML = `<i class="fas fa-database mr-2"></i>${steps[status].text}`;
                      }
                  } else {
                      icon.className = 'fas fa-circle text-gray-400';
                  }
              }
          }
      }
  }
  
  function hideLoadingState() {
      document.getElementById('searchLoadingState').classList.add('hidden');
      clearInterval(pollInterval);
      clearInterval(timerInterval);
  }
  
  function displayNoResults(message) {
      hideLoadingState();
      document.getElementById('leadFinderInitialContent').classList.add('hidden');
      
      const container = document.getElementById('searchResultsList');
      container.innerHTML = `
          <div class="text-center py-20">
              <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
              <h3 class="text-xl font-bold text-gray-900 mb-2">No se encontraron resultados</h3>
              <p class="text-gray-500 mb-6">${message}</p>
              <button onclick="window.location.reload()" 
                      class="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                  <i class="fas fa-refresh mr-2"></i>Intentar de nuevo
              </button>
          </div>
      `;
      
      document.getElementById('searchResults').classList.remove('hidden');
  }
  
  function updateSelectedLeads() {
      const checkboxes = document.querySelectorAll('.lead-checkbox:checked');
      selectedLeadIds = Array.from(checkboxes).map(cb => cb.dataset.leadId);
      
      document.getElementById('selectedLeadsCount').textContent = selectedLeadIds.length;
      
      const showButtons = selectedLeadIds.length > 0;
      ['addProspectsBtn', 'exportBtn'].forEach(btnId => {
          const btn = document.getElementById(btnId);
          if (btn) {
              btn.classList.toggle('hidden', !showButtons);
          }
      });
  }
  
  function clearAllFilters() {
      document.getElementById('locationFilter').value = '';
      document.getElementById('jobTitleFilter').selectedIndex = 0;
      document.getElementById('industryFilter').selectedIndex = 0;
      document.getElementById('companySizeFilter').selectedIndex = 0;
      document.getElementById('revenueFilter').selectedIndex = 0;
      document.getElementById('bulkSearchText').value = '';
      
      showNotification('Filtros limpiados', 'info');
  }
  
  function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      const colors = {
          success: 'bg-green-500',
          error: 'bg-red-500',
          warning: 'bg-yellow-500',
          info: 'bg-blue-500'
      };
      
      notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-xl z-50 flex items-center gap-3 transition-all transform`;
      notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle'} text-lg"></i>
          <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      // Animaci√≥n de entrada
      setTimeout(() => {
          notification.style.transform = 'translateX(0)';
      }, 10);
      
      setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateX(100%)';
          setTimeout(() => notification.remove(), 300);
      }, 5000);
  }
  
  // Funciones de exportaci√≥n CSV
  function convertToCSV(leads) {
      const headers = ['Nombre', 'Email', 'T√≠tulo', 'Empresa', 'Tel√©fono', 'Ubicaci√≥n', 'Industria', 'Fuente'];
      const rows = leads.map(lead => [
          lead.name || '',
          lead.email || '',
          lead.title || '',
          lead.company || '',
          lead.phone || '',
          lead.location || '',
          lead.industry || '',
          lead.source || ''
      ]);
      
      const csvContent = [
          headers.join(','),
          ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');
      
      return csvContent;
  }
  
  function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  }
  
  // Inicializaci√≥n
  console.log('‚úÖ ScraperCity Real-Time Integration Cargado - VERSI√ìN FINAL');
  // Inicializaci√≥n
  console.log('‚úÖ ScraperCity Real-Time Integration Cargado - VERSI√ìN FINAL');
  console.log('üéØ 457 leads esperados de ScraperCity');
  console.log('‚è≥ Polling extendido a 10 minutos para capturar todos los leads');
  console.log('üîç Detecci√≥n inteligente de fuente para Apollo/ScraperCity');
  console.log('üìä Modal mejorado con todos los detalles del lead');
</script>

<!-- ESTILOS MEJORADOS -->
<style>
  /* Lead Finder - Estilos Mejorados */
  #leadfinder-section {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  /* Cards de leads mejorados */
  .lead-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 4px solid transparent;
    position: relative;
    overflow: hidden;
  }
  
  .lead-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(147, 51, 234, 0.1), transparent);
    transition: left 0.5s ease;
  }
  
  .lead-card:hover::before {
    left: 100%;
  }
  
  .lead-card:hover {
    border-left-color: #7c3aed;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    transform: translateY(-2px);
  }
  
  /* Source badges con mejor visibilidad */
  .source-badge {
    display: inline-flex;
    align-items: center;
    font-size: 11px;
    font-weight: 600;
    padding: 6px 10px;
    border-radius: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  /* Animaciones */
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .animate-spin {
    animation: spin 1s linear infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  /* Progress counter animation */
  @keyframes countUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  #currentLeadCount {
    display: inline-block;
    animation: countUp 0.3s ease each time it changes;
  }
  
  /* Modal animations */
  #leadModal {
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  #leadModal > div {
    animation: slideUp 0.3s ease;
  }
  
  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  
  /* Gradient text effect */
  .gradient-text {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  /* Custom scrollbar for results */
  #searchResultsList::-webkit-scrollbar {
    width: 8px;
  }
  
  #searchResultsList::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  
  #searchResultsList::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
  }
  
  #searchResultsList::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b4399 100%);
  }
  
  /* Notification styles */
  .notification-enter {
    animation: slideInRight 0.3s ease;
  }
  
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  /* Loading dots animation */
  .loading-dots::after {
    content: '';
    animation: dots 1.5s infinite;
  }
  
  @keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
  }
</style>






<!-- Prospects Section -->
<div id="prospects-section" class="content-fade hidden">
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-bold text-gray-900">Prospects</h2>
      <div class="flex items-center space-x-3">
        <button onclick="showProspectFilters()" class="text-gray-600 hover:text-gray-800 px-3 py-2 border border-gray-300 rounded-lg text-sm">
          <i class="fas fa-filter mr-2"></i>Filter
        </button>
        <button onclick="bulkExport()" class="text-gray-600 hover:text-gray-800 px-3 py-2 border border-gray-300 rounded-lg text-sm">
          <i class="fas fa-download mr-2"></i>Export
        </button>
        <button onclick="importProspects()" class="text-gray-600 hover:text-gray-800 px-3 py-2 border border-gray-300 rounded-lg text-sm">
          <i class="fas fa-upload mr-2"></i>Import CSV
        </button>
        <button onclick="addProspect()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">Add Prospect</button>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <div id="bulkActionsBar" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <span class="text-sm font-medium text-gray-700"><span id="selectedCount">0</span> prospects selected</span>
      </div>
      <div class="flex items-center space-x-3">
        <button onclick="bulkAddToSequence()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">Add to Sequence</button>
        <button onclick="bulkVerifyEmails()" class="text-gray-600 hover:text-gray-800 px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white">Verify Emails</button>
        <button onclick="bulkDelete()" class="text-red-600 hover:text-red-800 px-3 py-2 border border-red-300 rounded-lg text-sm bg-white">Delete</button>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-lg border border-gray-200 mb-6 p-4">
    <div class="flex items-center space-x-4">
      <input type="text" id="prospectSearch" 
      placeholder="Search prospects..." 
      class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" 
      onkeyup="searchProspects()">      
      <select id="prospectIndustryFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer" onchange="filterProspects()">
        <option value="">All Industries</option>
        <option value="Technology">Technology</option>
        <option value="Software">Software</option>
        <option value="Finance">Finance</option>
        <option value="Healthcare">Healthcare</option>
        <option value="Manufacturing">Manufacturing</option>
        <option value="Construction">Construction</option>
        <option value="Real Estate">Real Estate</option>
        <option value="Retail">Retail</option>
        <option value="E-commerce">E-commerce</option>
        <option value="Marketing">Marketing</option>
        <option value="Consulting">Consulting</option>
        <option value="Legal Services">Legal Services</option>
        <option value="Insurance">Insurance</option>
        <option value="Education">Education</option>
        <option value="Transportation">Transportation</option>
      </select>
      
      <select id="prospectStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer" onchange="filterProspects()">
        <option value="">All Status</option>
        <option value="not_started">Not Started</option>
        <option value="in_sequence">In Sequence</option>
        <option value="contacted">Contacted</option>
        <option value="replied">Replied</option>
      </select>
      
      <select id="prospectQualifiedFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer" onchange="filterProspects()">
        <option value="">All Prospects</option>
        <option value="true">Qualified Only</option>
        <option value="false">Unqualified</option>
      </select>

      <select id="prospectPremiumFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white cursor-pointer" onchange="filterProspects()">
        <option value="">All Leads</option>
        <option value="premium">‚≠ê Premium Only</option>
        <option value="regular">Regular Only</option>
    </select>
    </div>
  </div>
  
  <div class="bg-white rounded-lg border border-gray-200">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <input type="checkbox" id="selectAllProspects" class="rounded" onchange="toggleSelectAll()">
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Title</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Industry</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sequence</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verified</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="prospectsTableBody" class="bg-white divide-y divide-gray-200">
          <!-- Populated by JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-700">
          Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalProspects">0</span> prospects
        </div>
        <div class="flex items-center space-x-2">
          <button onclick="previousPage()" id="prevBtn" class="px-3 py-2 border border-gray-300 rounded-lg text-sm disabled:opacity-50 hover:bg-gray-100" disabled>Previous</button>
          <span class="text-sm text-gray-700">Page <span id="currentPage">1</span></span>
          <button onclick="nextPage()" id="nextBtn" class="px-3 py-2 border border-gray-300 rounded-lg text-sm disabled:opacity-50 hover:bg-gray-100" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>
</div>
      <!-- Email Verifier Section -->
      <div id="verifier-section" class="content-fade hidden">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Email Verifier</h2>
          <p class="text-gray-600">Verify email addresses to improve deliverability</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Single Email Verification -->
          <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold mb-4">Single Email Verification</h3>
            <div class="space-y-4">
              <input type="email" id="emailToVerify" placeholder="Enter email address to verify" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm">
              <button onclick="verifySingleEmail()" class="btn-primary text-white px-6 py-2 rounded-lg text-sm font-medium w-full">
                <i class="fas fa-check-circle mr-2"></i>Verify Email
              </button>
              <div id="verificationResult" class="hidden mt-4 p-4 rounded-lg"></div>
            </div>
          </div>

          <!-- Bulk Email Verification -->
          <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold mb-4">Bulk Email Verification</h3>
            <div class="space-y-4">
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <i class="fas fa-upload text-3xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">Drop your CSV file here or</p>
                <button onclick="uploadCSVForVerification()" class="mt-2 text-tribearium-primary text-sm font-medium">Browse Files</button>
              </div>
              <button onclick="bulkVerifySelected()" class="border border-gray-300 text-gray-700 px-6 py-2 rounded-lg text-sm font-medium w-full hover:bg-gray-50">
                <i class="fas fa-users mr-2"></i>Verify Selected Prospects
              </button>
            </div>
          </div>
        </div>

        <!-- Verification History -->
        <div class="mt-6 bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold">Recent Verifications</h3>
          </div>
          <div id="verificationHistory" class="p-6">
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-history text-2xl mb-2"></i>
              <p>No verification history yet</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Templates Section -->
<!-- Templates Section -->
<div id="templates-section" class="content-fade hidden">
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-gray-900">Templates</h2>
        <div class="flex items-center space-x-4 mt-2">
          <button onclick="switchTemplateTab('my')" class="text-tribearium-primary border-b-2 border-tribearium-primary pb-1 text-sm font-medium">My Templates</button>
          <button onclick="switchTemplateTab('team')" class="text-gray-600 pb-1 text-sm font-medium">Team Templates</button>
        </div>
      </div>
      <div class="flex items-center space-x-3">
        <input type="text" id="templateSearch" placeholder="Search templates..." class="px-3 py-2 border border-gray-300 rounded-lg text-sm w-48" onkeyup="filterTemplates()">
        <button onclick="createTemplate()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">New Template</button>
      </div>
    </div>
  </div>
  <div class="bg-white rounded-lg border border-gray-200">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody id="templatesTableBody" class="bg-white divide-y divide-gray-200">
          <!-- Populated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
</div>

      <!-- Analytics Section -->
      <div id="analytics-section" class="content-fade hidden">
        <div class="mb-6">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">Analytics</h2>
              <div class="flex items-center space-x-4 mt-2">
                <button onclick="setAnalyticsView('Sequence')" class="text-tribearium-primary border-b-2 border-tribearium-primary pb-1 text-sm font-medium">Sequence</button>
                <button onclick="setAnalyticsView('Teams')" class="text-gray-600 pb-1 text-sm font-medium">Teams</button>
              </div>
            </div>
            <div class="flex items-center space-x-3">
              <select id="analyticsSequenceFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="loadAnalytics()">
                <option value="">All sequences</option>
              </select>
              <select id="analyticsDateRange" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="loadAnalytics()">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
              </select>
              <button onclick="exportAnalytics()" class="text-gray-600 hover:text-gray-800 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <i class="fas fa-download mr-2"></i>Export
              </button>
            </div>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 mb-6">
          <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900 mb-1" id="analyticsProspects">0</div>
            <div class="text-xs text-gray-600 mb-2">Prospects</div>
            <div class="flex items-center justify-center text-xs text-green-600"><i class="fas fa-arrow-up mr-1"></i><span id="prospectGrowth">0%</span></div>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900 mb-1" id="analyticsContacted">0</div>
            <div class="text-xs text-gray-600 mb-2">Contacted</div>
            <div class="text-xs text-gray-600">(<span id="contactedPercent">0%</span>)</div>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900 mb-1" id="analyticsOpened">0</div>
            <div class="text-xs text-gray-600 mb-2">Opened</div>
            <div class="text-xs text-gray-600">(<span id="openedPercent">0%</span>)</div>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900 mb-1" id="analyticsReplied">0</div>
            <div class="text-xs text-gray-600 mb-2">Replied</div>
            <div class="text-xs text-gray-600">(<span id="repliedPercent">0%</span>)</div>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900 mb-1" id="analyticsQualified">0</div>
            <div class="text-xs text-gray-600 mb-2">Qualified</div>
            <div class="text-xs text-gray-600">(<span id="qualifiedPercent">0%</span>)</div>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900 mb-1" id="analyticsTargeted">0</div>
            <div class="text-xs text-gray-600 mb-2">Targeted</div>
            <div class="text-xs text-gray-600">(<span id="targetedPercent">0%</span>)</div>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900 mb-1" id="analyticsPositive">0</div>
            <div class="text-xs text-gray-600 mb-2">Positive</div>
            <div class="text-xs text-gray-600">(<span id="positivePercent">0%</span>)</div>
          </div>
          <div class="bg-white rounded-lg border border-gray-200 p-4 text-center">
            <div class="text-2xl font-bold text-gray-900 mb-1" id="analyticsAvgScore">0</div>
            <div class="text-xs text-gray-600 mb-2">Avg Score</div>
            <div class="text-xs text-gray-600">Quality</div>
          </div>
        </div>

        <!-- Chart Container -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold">Performance Overview</h3>
            <div class="flex items-center space-x-4">
              <button onclick="setAnalyticsPeriod('Daily')" class="text-tribearium-primary border-b-2 border-tribearium-primary pb-1 text-sm font-medium">Daily</button>
<button onclick="setAnalyticsPeriod('Weekly')" class="text-gray-600 pb-1 text-sm font-medium">Weekly</button>
<button onclick="setAnalyticsPeriod('Monthly')" class="text-gray-600 pb-1 text-sm font-medium">Monthly</button>
            </div>
          </div>
<div class="h-64">
  <canvas id="analyticsChart"></canvas>
</div>
        </div>

        <!-- Detailed Analytics Table -->
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold">Sequence Performance</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sequence Name</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prospects</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacted</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Opened</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clicked</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Replied</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Positive</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="analyticsTableBody" class="bg-white divide-y divide-gray-200">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="settings-section" class="content-fade hidden">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Settings</h2>
          <p class="text-gray-600">Configure your Tribearium Lead Generator preferences</p>
        </div>

        <!-- Email Configuration -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center"><i class="fas fa-envelope mr-3 text-tribearium-primary"></i>Email Configuration</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Gmail Account</label>
              <input type="email" id="gmailAccount" value="ricardokr63@gmail.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" readonly>
              <p class="text-xs text-green-600 mt-1" id="emailStatus">‚úì Connected and verified</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Daily Email Limit</label>
              <select id="emailLimit" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="50">50 emails per day</option>
                <option value="100" selected>100 emails per day</option>
                <option value="200">200 emails per day</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Sending Hours</label>
              <div class="flex space-x-2">
                <select id="sendingStart" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="9" selected>9:00 AM</option>
                  <option value="8">8:00 AM</option>
                  <option value="10">10:00 AM</option>
                </select>
                <span class="flex items-center text-gray-500">to</span>
                <select id="sendingEnd" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="17" selected>5:00 PM</option>
                  <option value="16">4:00 PM</option>
                  <option value="18">6:00 PM</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Time Zone</label>
              <select id="timezone" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="America/New_York" selected>Eastern Time (EST)</option>
                <option value="America/Chicago">Central Time (CST)</option>
                <option value="America/Denver">Mountain Time (MST)</option>
                <option value="America/Los_Angeles">Pacific Time (PST)</option>
              </select>
            </div>
          </div>
        </div>
        <!-- API Configuration -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center"><i class="fas fa-cog mr-3 text-tribearium-secondary"></i>API Configuration</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Apify API Key</label>
              <div class="relative">
                <input type="password" id="apifyKey" value="apify_api_bPNCx5VODioKI6CJ0uDDK0QdnIstw90WFybA" class="w-full px-3 py-2 border border-gray-300 rounded-lg pr-10">
                <button onclick="togglePassword('apifyKey')" class="absolute right-3 top-2 text-gray-400 hover:text-gray-600"><i class="fas fa-eye"></i></button>
              </div>
              <p class="text-xs text-green-600 mt-1" id="apifyStatus">‚úì Connected and active</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Hunter.io API Key</label>
              <div class="relative">
                <input type="password" id="hunterKey" value="8f89bbd59f1b3a75cb4e19608d2f13cb78549dd6" class="w-full px-3 py-2 border border-gray-300 rounded-lg pr-10">
                <button onclick="togglePassword('hunterKey')" class="absolute right-3 top-2 text-gray-400 hover:text-gray-600"><i class="fas fa-eye"></i></button>
              </div>
              <p class="text-xs text-green-600 mt-1" id="hunterStatus">‚úì Connected and active</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Google Places API Key</label>
              <div class="relative">
                <input type="password" id="googleKey" value="AIzaSyCxdLlz_sA-KvNcqcl42I3qxZjPXCwEWPQ" class="w-full px-3 py-2 border border-gray-300 rounded-lg pr-10">
                <button onclick="togglePassword('googleKey')" class="absolute right-3 top-2 text-gray-400 hover:text-gray-600"><i class="fas fa-eye"></i></button>
              </div>
              <p class="text-xs text-green-600 mt-1" id="googleStatus">‚úì Connected and active</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn API Key</label>
              <div class="relative">
                <input type="password" placeholder="Coming soon..." class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50" disabled>
              </div>
              <p class="text-xs text-gray-500 mt-1">Coming soon</p>
            </div>
          </div>
        </div>

        <!-- Lead Generation Settings -->
        <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center"><i class="fas fa-search mr-3 text-tribearium-accent"></i>Lead Generation Settings</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <div>
                <span class="font-medium text-gray-900">Auto-verify emails</span>
                <p class="text-sm text-gray-500">Automatically verify email addresses when adding prospects</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="autoVerify" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tribearium-primary"></div>
              </label>
            </div>

            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
              <div>
                <span class="font-medium text-gray-900">Skip duplicate prospects</span>
                <p class="text-sm text-gray-500">Automatically skip prospects that already exist in your database</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="skipDuplicates" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-tribearium-primary"></div>
              </label>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Lead Score</label>
                <select id="minScore" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="60" selected>60 (Recommended)</option>
                  <option value="70">70 (High Quality)</option>
                  <option value="80">80 (Premium)</option>
                  <option value="50">50 (All Leads)</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Default Batch Size</label>
                <select id="batchSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="25" selected>25 prospects</option>
                  <option value="50">50 prospects</option>
                  <option value="100">100 prospects</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="flex justify-end">
          <button onclick="saveSettings()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">
            <i class="fas fa-save mr-2"></i>Save Settings
          </button>
        </div>
      </div>

    </main>
  </div>

  <!-- Modals -->
<!-- REEMPLAZA el modal de Create Sequence con este c√≥digo actualizado -->

<!-- Create Sequence Modal con Rotaci√≥n de Emails -->
<div id="createSequenceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-900">Create New Sequence</h3>
          <button onclick="closeModal('createSequenceModal')" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6">
        <form id="sequenceForm" onsubmit="submitSequenceForm(event)">
          <div class="space-y-6">
            <!-- Nombre y Descripci√≥n -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Sequence Name</label>
              <input type="text" id="sequenceName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                     placeholder="Enter sequence name" required>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
              <textarea id="sequenceDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                        placeholder="Enter sequence description"></textarea>
            </div>

            <!-- NUEVO: Configuraci√≥n de Emails Remitentes -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-start mb-3">
                <i class="fas fa-envelope-open-text text-blue-500 mt-1 mr-3"></i>
                <div class="flex-1">
                  <label class="block text-sm font-medium text-gray-900 mb-1">
                    Sender Email Rotation
                  </label>
                  <p class="text-xs text-gray-600 mb-3">
                    Add multiple Gmail accounts to rotate sending. Leads will be distributed evenly across all accounts.
                  </p>
                </div>
              </div>

              <div id="senderEmailsContainer" class="space-y-2">
                <!-- Email principal (ya configurado) -->
                <div class="sender-email-row flex items-center space-x-2">
                  <input type="email" 
                         class="sender-email flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" 
                         placeholder="ricardokr63@gmail.com" 
                         value="ricardokr63@gmail.com"
                         required>
                  <span class="text-xs text-green-600 font-medium">Primary</span>
                </div>
              </div>

              <div class="mt-3 flex items-center justify-between">
                <button type="button" onclick="addSenderEmail()" 
                        class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                  <i class="fas fa-plus-circle mr-1"></i> Add Another Email
                </button>
                <span id="emailCount" class="text-xs text-gray-500">1 email configured</span>
              </div>

              <!-- Configuraci√≥n de distribuci√≥n -->
              <div class="mt-4 p-3 bg-white rounded border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                  <label class="text-xs font-medium text-gray-700">Distribution Method</label>
                  <select id="distributionMethod" class="text-sm px-2 py-1 border border-gray-300 rounded">
                    <option value="round-robin">Round Robin (Even)</option>
                    <option value="random">Random</option>
                    <option value="weighted">Weighted</option>
                  </select>
                </div>
                
                <div class="flex items-center justify-between">
                  <label class="text-xs font-medium text-gray-700">Daily Limit per Email</label>
                  <input type="number" id="dailyLimitPerEmail" 
                         class="w-20 text-sm px-2 py-1 border border-gray-300 rounded text-center" 
                         value="50" min="1" max="500">
                </div>
              </div>
            </div>

            <!-- Templates de Email -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Templates</label>
              <div class="space-y-2">
                <div class="flex items-center">
                  <input type="checkbox" id="template_day1" class="mr-2 rounded" checked>
                  <label for="template_day1" class="text-sm">Day 1 - Introduction</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="template_day3" class="mr-2 rounded" checked>
                  <label for="template_day3" class="text-sm">Day 3 - Follow up</label>
                </div>
                <div class="flex items-center">
                  <input type="checkbox" id="template_day7" class="mr-2 rounded" checked>
                  <label for="template_day7" class="text-sm">Day 7 - Final Touch</label>
                </div>
              </div>
            </div>

            <!-- Preview de distribuci√≥n -->
            <div id="distributionPreview" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">Distribution Preview</label>
              <div class="bg-gray-50 rounded-lg p-3">
                <p class="text-xs text-gray-600 mb-2">Based on your current selection:</p>
                <div id="previewContent" class="space-y-1"></div>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" onclick="closeModal('createSequenceModal')" 
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
              Cancel
            </button>
            <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">
              Create Sequence
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript para manejar la rotaci√≥n de emails -->
<script>
let senderEmailCount = 1;

function addSenderEmail() {
  senderEmailCount++;
  const container = document.getElementById('senderEmailsContainer');
  
  const newRow = document.createElement('div');
  newRow.className = 'sender-email-row flex items-center space-x-2 animate-fadeIn';
  newRow.innerHTML = `
    <input type="email" 
           class="sender-email flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" 
           placeholder="email${senderEmailCount}@gmail.com" 
           required>
    <input type="password" 
           class="sender-password flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" 
           placeholder="App password" 
           required>
    <button type="button" onclick="removeSenderEmail(this)" 
            class="text-red-500 hover:text-red-700">
      <i class="fas fa-trash text-sm"></i>
    </button>
  `;
  
  container.appendChild(newRow);
  updateEmailCount();
  updateDistributionPreview();
}

function removeSenderEmail(button) {
  button.closest('.sender-email-row').remove();
  senderEmailCount--;
  updateEmailCount();
  updateDistributionPreview();
}

function updateEmailCount() {
  const count = document.querySelectorAll('.sender-email').length;
  document.getElementById('emailCount').textContent = `${count} email${count > 1 ? 's' : ''} configured`;
}

function updateDistributionPreview() {
  const emailInputs = document.querySelectorAll('.sender-email');
  const previewDiv = document.getElementById('distributionPreview');
  const previewContent = document.getElementById('previewContent');
  
  if (emailInputs.length > 1) {
    previewDiv.classList.remove('hidden');
    const method = document.getElementById('distributionMethod').value;
    const dailyLimit = document.getElementById('dailyLimitPerEmail').value;
    
    let previewHTML = '';
    emailInputs.forEach((input, index) => {
      const email = input.value || input.placeholder;
      const percentage = Math.floor(100 / emailInputs.length);
      previewHTML += `
        <div class="flex items-center justify-between text-xs">
          <span class="text-gray-700">${email}</span>
          <span class="text-gray-500">~${percentage}% (‚â§${dailyLimit} emails/day)</span>
        </div>
      `;
    });
    
    previewContent.innerHTML = previewHTML;
  } else {
    previewDiv.classList.add('hidden');
  }
}

// Actualizar preview cuando cambian los valores
document.getElementById('distributionMethod')?.addEventListener('change', updateDistributionPreview);
document.getElementById('dailyLimitPerEmail')?.addEventListener('input', updateDistributionPreview);

// Modificar la funci√≥n submitSequenceForm para incluir los emails
async function submitSequenceForm(event) {
  event.preventDefault();
  
  const senderEmails = [];
  document.querySelectorAll('.sender-email-row').forEach(row => {
    const email = row.querySelector('.sender-email').value;
    const password = row.querySelector('.sender-password')?.value || process.env.GMAIL_APP_PASSWORD;
    if (email) {
      senderEmails.push({ email, password });
    }
  });
  
  const sequenceData = {
    name: document.getElementById('sequenceName').value,
    description: document.getElementById('sequenceDescription').value,
    sender_emails: senderEmails,
    distribution_method: document.getElementById('distributionMethod').value,
    daily_limit_per_email: parseInt(document.getElementById('dailyLimitPerEmail').value),
    templates: {
      day_1: document.getElementById('template_day1').checked,
      day_3: document.getElementById('template_day3').checked,
      day_7: document.getElementById('template_day7').checked
    }
  };
  
  try {
    showNotification('Creating sequence with email rotation...', 'info');
    
    const response = await fetch('/api/sequences', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(sequenceData)
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification(`Sequence created with ${senderEmails.length} sender email(s)!`, 'success');
      closeModal('createSequenceModal');
      loadSequences(); // Recargar lista de secuencias
    } else {
      showNotification(data.error || 'Error creating sequence', 'error');
    }
  } catch (error) {
    console.error('Error:', error);
    showNotification('Error creating sequence', 'error');
  }
}
</script>

<style>
.animate-fadeIn {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

  <!-- Add to Sequence Modal -->
  <div id="addToSequenceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-md w-full">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900">Add to Sequence</h3>
            <button onclick="closeModal('addToSequenceModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
          </div>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Sequence</label>
            <select id="sequenceSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              <option value="">Choose a sequence...</option>
            </select>
          </div>
          <div class="flex justify-end space-x-3">
            <button onclick="closeModal('addToSequenceModal')" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
            <button onclick="confirmAddToSequence()" class="btn-primary text-white px-4 py-2 rounded-lg">Add to Sequence</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Prospect Modal -->
  <div id="addProspectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900">Add New Prospect</h3>
            <button onclick="closeModal('addProspectModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
          </div>
        </div>
        <div class="p-6">
          <form id="prospectForm" onsubmit="submitProspectForm(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                <input type="text" id="prospectName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" id="prospectEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Job Title</label>
                <input type="text" id="prospectTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                <input type="text" id="prospectCompany" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                <input type="tel" id="prospectPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                <input type="url" id="prospectWebsite" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                <input type="text" id="prospectLocation" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Industry</label>
                <select id="prospectIndustry" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="">Select Industry</option>
                  <option value="Technology">Technology</option>
                  <option value="Manufacturing">Manufacturing</option>
                  <option value="Construction">Construction</option>
                  <option value="Healthcare">Healthcare</option>
                  <option value="Legal Services">Legal Services</option>
                </select>
              </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
              <button type="button" onclick="closeModal('addProspectModal')" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
              <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">Add Prospect</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Client Modal -->
  <div id="addClientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-md w-full">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900">Add New Client</h3>
            <button onclick="closeModal('addClientModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
          </div>
        </div>
        <div class="p-6">
          <form id="clientForm" onsubmit="submitClientForm(event)">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label>
                <input type="text" id="clientName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" id="clientEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                <input type="text" id="clientCompany" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
              </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
              <button type="button" onclick="closeModal('addClientModal')" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
              <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">Add Client</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- File Upload Modal -->
  <div id="fileUploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-md w-full">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-gray-900">Import CSV File</h3>
            <button onclick="closeModal('fileUploadModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
          </div>
        </div>
        <div class="p-6">
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
            <i class="fas fa-upload text-3xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 mb-4">Drop your CSV file here or</p>
            <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
            <button onclick="document.getElementById('csvFileInput').click()" class="btn-primary text-white px-4 py-2 rounded-lg">Browse Files</button>
          </div>
          <div class="mt-4 text-sm text-gray-500">
            <p>Supported format: CSV</p>
            <p>Required columns: name, email</p>
            <p>Optional: title, company, phone, website, location, industry</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Create Template Modal -->
<div id="createTemplateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-900">Create New Template</h3>
          <button onclick="closeModal('createTemplateModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="p-6">
        <form id="templateForm" onsubmit="submitTemplateForm(event)">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column - Template Details -->
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Template Title *</label>
                <input type="text" id="templateTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="e.g., Welcome Email, Follow Up #1" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email Subject *</label>
                <input type="text" id="templateSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="e.g., Quick question for {{company}}" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Template Category</label>
                <select id="templateCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                  <option value="sequence">Sequence Email</option>
                  <option value="followup">Follow Up</option>
                  <option value="introduction">Introduction</option>
                  <option value="closing">Closing Email</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea id="templateDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Brief description of when to use this template"></textarea>
              </div>
              
              <!-- Variables Helper -->
              <div class="bg-blue-50 p-4 rounded-lg">
                <h4 class="font-medium text-blue-900 mb-2">Available Variables</h4>
                <div class="text-sm text-blue-700 space-y-1">
                  <div><code class="bg-blue-100 px-1 rounded">{{name}}</code> - Contact's first name</div>
                  <div><code class="bg-blue-100 px-1 rounded">{{company}}</code> - Company name</div>
                  <div><code class="bg-blue-100 px-1 rounded">{{title}}</code> - Job title</div>
                  <div><code class="bg-blue-100 px-1 rounded">{{industry}}</code> - Industry</div>
                </div>
              </div>
            </div>
            
            <!-- Right Column - Email Body -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email Body *</label>
              <textarea id="templateBody" rows="16" class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm" placeholder="Hi {{name}},

Hope you're doing well. I wanted to reach out because...

Best regards,
Javier" required></textarea>
              
              <div class="mt-4 text-sm text-gray-500">
                <p><strong>Tip:</strong> Use personalization variables to make your emails more engaging.</p>
                <p>Keep it concise and focus on value for the recipient.</p>
              </div>
            </div>
          </div>
          
          <div class="mt-6 flex justify-end space-x-3">
            <button type="button" onclick="closeModal('createTemplateModal')" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
            <button type="button" onclick="previewTemplate()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Preview</button>
            <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">Create Template</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Template Preview Modal -->
<div id="templatePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-bold text-gray-900">Template Preview</h3>
          <button onclick="closeModal('templatePreviewModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div class="p-6">
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <div class="text-sm text-gray-600 mb-2">Subject:</div>
          <div id="previewSubject" class="font-medium text-gray-900"></div>
        </div>
        <div class="bg-white border rounded-lg p-4">
          <div id="previewBody" class="whitespace-pre-wrap text-gray-800"></div>
        </div>
        <div class="mt-4 text-sm text-gray-500">
          <p>Preview shows template with sample data: John Smith from TechCorp Inc</p>
        </div>
        <div class="mt-6 flex justify-end">
          <button onclick="closeModal('templatePreviewModal')" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- JAVASCRIPT -->
  <script>
    // ===== Global State =====
// Variables existentes (mant√©n las que ya tienes)
let apiData = { 
    leads: [], sequences: [], prospects: [], templates: [], 
    analytics: {}, clients: [], settings: {} 
};
let currentPage = 1;
const pageSize = 25;
let selectedProspects = [];
let currentFilters = {};
window.verificationHistory = [];

// NUEVAS VARIABLES PARA INBOX - Agrega estas l√≠neas
let currentInboxFilter = 'all';
let selectedConversation = null;
let inboxConversations = [];
let inboxStats = {};


    // Template tab functionality
function switchTemplateTab(tabType) {
  // Update tab styling
  const buttons = document.querySelectorAll('#templates-section .flex.items-center.space-x-4.mt-2 button');
  buttons.forEach(btn => {
    btn.className = 'text-gray-600 pb-1 text-sm font-medium';
  });
  
  event.target.className = 'text-tribearium-primary border-b-2 border-tribearium-primary pb-1 text-sm font-medium';
  
  // Load appropriate templates
  if (tabType === 'team') {
    loadTeamTemplates();
  } else {
    loadTemplates(); // My Templates
  }
}

async function loadTeamTemplates() {
  try {
    showLoading('templates');
    
    // For now, show templates marked as "team" or default
    const data = await apiCall('/api/templates?category=team');
    
    if (data.success) {
      // Filter for team/default templates
      const teamTemplates = data.data.filter(template => 
        template.isDefault || template.owner !== 'User'
      );
      
      apiData.templates = teamTemplates;
      updateTemplatesTable();
      
      if (teamTemplates.length === 0) {
        const tbody = document.getElementById('templatesTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-16">
              <div class="space-y-4">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full">
                  <i class="fas fa-users text-2xl text-gray-400"></i>
                </div>
                <div>
                  <p class="text-xl text-gray-500 font-medium mb-2">No team templates found</p>
                  <p class="text-gray-400">Default templates from Javier are available for the team</p>
                </div>
              </div>
            </td>
          </tr>
        `;
      }
    }
  } catch (error) {
    showNotification('Error loading team templates', 'error');
    // Fallback to regular templates
    loadTemplates();
  } finally {
    hideLoading('templates');
  }
}


    // ===== Templates Management =====
async function loadTemplates() {
  try {
    showLoading('templates');
    const data = await apiCall('/api/templates');
    if (data.success) {
      apiData.templates = data.data || [];
      updateTemplatesTable();
    }
  } catch (error) {
    showNotification('Error loading templates', 'error');
  } finally {
    hideLoading('templates');
  }
}

function updateTemplatesTable() {
  const tbody = document.getElementById('templatesTableBody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (!apiData.templates.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center py-16">
          <div class="space-y-4">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full">
              <i class="fas fa-file-alt text-2xl text-gray-400"></i>
            </div>
            <div>
              <p class="text-xl text-gray-500 font-medium mb-2">No templates found</p>
              <p class="text-gray-400">Create your first email template to get started</p>
            </div>
            <button onclick="createTemplate()" class="btn-primary text-white px-6 py-3 rounded-lg">Create Template</button>
          </div>
        </td>
      </tr>
    `;
    return;
  }

  apiData.templates.forEach(template => {
    const tr = document.createElement('tr');
    tr.className = 'table-hover';
    
    tr.innerHTML = `
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="w-8 h-8 bg-tribearium-primary rounded-full mr-3 flex items-center justify-center">
            <i class="fas fa-envelope text-white text-sm"></i>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-900">${template.title}</div>
            <div class="text-xs text-gray-500">${template.id}</div>
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="text-sm text-gray-900">${template.subject}</div>
        <div class="text-xs text-gray-500">${template.body ? template.body.substring(0, 50) + '...' : 'No preview'}</div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center space-x-4">
          <div class="flex items-center text-sm text-gray-600">
            <i class="fas fa-heart mr-1 text-red-400"></i>${template.performance?.likes || 0}
          </div>
          <div class="flex items-center text-sm text-gray-600">
            <i class="fas fa-eye mr-1 text-blue-400"></i>${template.performance?.views || 0}
          </div>
          <div class="flex items-center text-sm text-gray-600">
            <i class="fas fa-paper-plane mr-1 text-green-400"></i>${template.total_sent || 0}
          </div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap">
        <div class="flex items-center">
          <div class="w-6 h-6 bg-gray-300 rounded-full mr-2"></div>
          <div class="text-sm text-gray-900">${template.owner}</div>
        </div>
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
        <div class="flex items-center space-x-2">
          <button onclick="viewTemplate('${template.id}')" class="text-blue-600 hover:text-blue-800" title="View">
            <i class="fas fa-eye"></i>
          </button>
          <button onclick="editTemplate('${template.id}')" class="text-gray-600 hover:text-gray-800" title="Edit">
            <i class="fas fa-edit"></i>
          </button>
          <button onclick="useTemplate('${template.id}')" class="text-green-600 hover:text-green-800" title="Use Template">
            <i class="fas fa-play"></i>
          </button>
          <button onclick="showTemplateActions('${template.id}')" class="text-gray-400 hover:text-gray-600" title="More">
            <i class="fas fa-ellipsis-v"></i>
          </button>
        </div>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
}

// Template Management Functions

// Template Management Functions - REAL IMPLEMENTATION
function createTemplate() {
  // Reset form
  document.getElementById('templateForm').reset();
  openModal('createTemplateModal');
}

async function submitTemplateForm(event) {
  event.preventDefault();
  
  const templateData = {
    title: document.getElementById('templateTitle').value.trim(),
    subject: document.getElementById('templateSubject').value.trim(),
    body: document.getElementById('templateBody').value.trim(),
    category: document.getElementById('templateCategory').value,
    description: document.getElementById('templateDescription').value.trim()
  };

  if (!templateData.title || !templateData.subject || !templateData.body) {
    showNotification('Title, subject, and body are required', 'warning');
    return;
  }

  try {
    const data = await apiCall('/api/templates', {
      method: 'POST',
      body: JSON.stringify(templateData)
    });

    if (data.success) {
      showNotification(`Template "${templateData.title}" created successfully!`, 'success');
      closeModal('createTemplateModal');
      loadTemplates(); // Reload templates
    }
  } catch (error) {
    showNotification('Error creating template', 'error');
  }
}

// Real action functions
async function editTemplate(templateId) {
  try {
    const data = await apiCall(`/api/templates/${templateId}`);
    
    if (data.success) {
      const template = data.data;
      
      // Populate form with existing data
      document.getElementById('templateTitle').value = template.title;
      document.getElementById('templateSubject').value = template.subject;
      document.getElementById('templateBody').value = template.body;
      document.getElementById('templateCategory').value = template.category || 'custom';
      document.getElementById('templateDescription').value = template.description || '';
      
      // Change form to edit mode
      const form = document.getElementById('templateForm');
      form.onsubmit = (e) => updateTemplate(e, templateId);
      
      // Update modal title and button
      document.querySelector('#createTemplateModal h3').textContent = 'Edit Template';
      document.querySelector('#createTemplateModal button[type="submit"]').textContent = 'Update Template';
      
      openModal('createTemplateModal');
    }
  } catch (error) {
    showNotification('Error loading template for editing', 'error');
  }
}

async function updateTemplate(event, templateId) {
  event.preventDefault();
  
  const templateData = {
    title: document.getElementById('templateTitle').value.trim(),
    subject: document.getElementById('templateSubject').value.trim(),
    body: document.getElementById('templateBody').value.trim(),
    category: document.getElementById('templateCategory').value,
    description: document.getElementById('templateDescription').value.trim()
  };

  try {
    const data = await apiCall(`/api/templates/${templateId}`, {
      method: 'PUT',
      body: JSON.stringify(templateData)
    });

    if (data.success) {
      showNotification('Template updated successfully!', 'success');
      closeModal('createTemplateModal');
      resetTemplateForm();
      loadTemplates();
    }
  } catch (error) {
    showNotification('Error updating template', 'error');
  }
}

function resetTemplateForm() {
  const form = document.getElementById('templateForm');
  form.onsubmit = submitTemplateForm;
  document.querySelector('#createTemplateModal h3').textContent = 'Create New Template';
  document.querySelector('#createTemplateModal button[type="submit"]').textContent = 'Create Template';
}

async function useTemplate(templateId) {
  try {
    // Get prospects that can be added to sequence
    const prospectsData = await apiCall('/api/leads?limit=10&status=not_started');
    
    if (prospectsData.success && prospectsData.data.length > 0) {
      showNotification(`Template ready to use! Add prospects to a sequence first.`, 'info');
      showSection('prospects');
    } else {
      showNotification('Add some prospects first to use templates in sequences', 'warning');
      showSection('leadfinder');
    }
  } catch (error) {
    showNotification('Template selected - integrate with sequence creation', 'info');
  }
}

async function deleteTemplate(templateId) {
  if (!confirm('Are you sure you want to delete this template?')) {
    return;
  }

  try {
    const data = await apiCall(`/api/templates/${templateId}`, {
      method: 'DELETE'
    });

    if (data.success) {
      showNotification('Template deleted successfully', 'success');
      loadTemplates();
    }
  } catch (error) {
    showNotification('Error deleting template', 'error');
  }
}

function showTemplateActions(templateId) {
  // Create actions dropdown
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-30 z-50';
  modal.onclick = () => modal.remove();
  
  modal.innerHTML = `
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-lg p-4 min-w-48" onclick="event.stopPropagation()">
        <div class="space-y-2">
          <button onclick="viewTemplate('${templateId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
            <i class="fas fa-eye mr-3 text-blue-500"></i>View Details
          </button>
          <button onclick="editTemplate('${templateId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
            <i class="fas fa-edit mr-3 text-gray-500"></i>Edit Template  
          </button>
          <button onclick="useTemplate('${templateId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
            <i class="fas fa-play mr-3 text-green-500"></i>Use in Sequence
          </button>
          <hr class="my-2">
          <button onclick="deleteTemplate('${templateId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 rounded flex items-center">
            <i class="fas fa-trash mr-3"></i>Delete
          </button>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

async function submitTemplateForm(event) {
  event.preventDefault();
  
  const templateData = {
    title: document.getElementById('templateTitle').value.trim(),
    subject: document.getElementById('templateSubject').value.trim(),
    body: document.getElementById('templateBody').value.trim(),
    category: document.getElementById('templateCategory').value,
    description: document.getElementById('templateDescription').value.trim()
  };

  if (!templateData.title || !templateData.subject || !templateData.body) {
    showNotification('Title, subject, and body are required', 'warning');
    return;
  }

  try {
    const data = await apiCall('/api/templates', {
      method: 'POST',
      body: JSON.stringify(templateData)
    });

    if (data.success) {
      showNotification(`Template "${templateData.title}" created successfully!`, 'success');
      closeModal('createTemplateModal');
      document.getElementById('templateForm').reset();
      loadTemplates();
    }
  } catch (error) {
    showNotification('Error creating template', 'error');
  }
}

function previewTemplate() {
  const title = document.getElementById('templateTitle').value;
  const subject = document.getElementById('templateSubject').value;
  const body = document.getElementById('templateBody').value;

  if (!subject || !body) {
    showNotification('Please fill in subject and body to preview', 'warning');
    return;
  }

  // Sample data for preview
  const sampleData = {
    name: 'John Smith',
    company: 'TechCorp Inc',
    title: 'CEO',
    industry: 'Technology'
  };

  // Replace variables with sample data
  let previewSubject = subject;
  let previewBody = body;

  Object.entries(sampleData).forEach(([key, value]) => {
    const regex = new RegExp(`{{${key}}}`, 'g');
    previewSubject = previewSubject.replace(regex, value);
    previewBody = previewBody.replace(regex, value);
  });

  // Show preview modal
  document.getElementById('previewSubject').textContent = previewSubject;
  document.getElementById('previewBody').textContent = previewBody;
  openModal('templatePreviewModal');
}

async function viewTemplate(templateId) {
  try {
    const data = await apiCall(`/api/templates/${templateId}`);
    
    if (data.success) {
      const template = data.data;
      
      // Create template details modal
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
      modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-900">Template: ${template.title}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                  <div class="text-2xl font-bold text-blue-600">${template.total_sent}</div>
                  <div class="text-sm text-blue-700">Times Sent</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                  <div class="text-2xl font-bold text-green-600">${template.performance?.likes || 0}</div>
                  <div class="text-sm text-green-700">Likes</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                  <div class="text-2xl font-bold text-purple-600">${template.performance?.views || 0}</div>
                  <div class="text-sm text-purple-700">Views</div>
                </div>
              </div>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Subject Line</label>
                  <div class="bg-gray-50 p-3 rounded-lg text-gray-800">${template.subject}</div>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Email Body</label>
                  <div class="bg-gray-50 p-4 rounded-lg text-gray-800 whitespace-pre-wrap font-mono text-sm max-h-64 overflow-y-auto">${template.body}</div>
                </div>
              </div>
              
              <div class="mt-6 flex justify-end space-x-3">
                <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close</button>
                <button onclick="editTemplate('${templateId}'); this.closest('.fixed').remove()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Edit</button>
                <button onclick="useTemplate('${templateId}'); this.closest('.fixed').remove()" class="btn-primary text-white px-4 py-2 rounded-lg">Use Template</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
  } catch (error) {
    showNotification('Error loading template details', 'error');
  }
}

function filterTemplates() {
  const searchTerm = document.getElementById('templateSearch')?.value?.toLowerCase();
  if (!searchTerm) {
    updateTemplatesTable();
    return;
  }
  
  const filteredTemplates = apiData.templates.filter(template => 
    template.title.toLowerCase().includes(searchTerm) ||
    template.subject.toLowerCase().includes(searchTerm) ||
    template.owner.toLowerCase().includes(searchTerm)
  );
  
  // Temporarily replace templates data for filtering
  const originalTemplates = apiData.templates;
  apiData.templates = filteredTemplates;
  updateTemplatesTable();
  apiData.templates = originalTemplates;
}






// =====================
// UNIFIED INBOX FRONTEND - Add to your main JavaScript section
// =====================
function getStatusBadgeClass(status) {
    const classes = {
        'sent': 'bg-blue-100 text-blue-800',
        'opened': 'bg-green-100 text-green-800',
        'clicked': 'bg-purple-100 text-purple-800',
        'replied': 'bg-teal-100 text-teal-800',
        'bounced': 'bg-red-100 text-red-800',
        'failed': 'bg-red-100 text-red-800',
        'draft': 'bg-gray-100 text-gray-800'
    };
    return classes[status] || 'bg-gray-100 text-gray-800';
}

function getSentimentClass(sentiment) {
    const classes = {
        'positive': 'bg-green-100 text-green-800',
        'negative': 'bg-red-100 text-red-800',
        'neutral': 'bg-gray-100 text-gray-800',
        'interested': 'bg-blue-100 text-blue-800'
    };
    return classes[sentiment] || 'bg-gray-100 text-gray-800';
}

function formatTimeAgo(timestamp) {
    if (!timestamp) return 'Desconocido';
    
    const now = new Date();
    const time = new Date(timestamp);
    const diffInMinutes = Math.floor((now - time) / (1000 * 60));
    
    if (diffInMinutes < 1) return 'Ahora mismo';
    if (diffInMinutes < 60) return `${diffInMinutes}m`;
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) return `${diffInHours}h`;
    
    const diffInDays = Math.floor(diffInHours / 24);
    if (diffInDays < 7) return `${diffInDays}d`;
    
    const diffInWeeks = Math.floor(diffInDays / 7);
    if (diffInWeeks < 4) return `${diffInWeeks}sem`;
    
    const diffInMonths = Math.floor(diffInDays / 30);
    return `${diffInMonths}m`;
}

// =====================
// FUNCIONES DEL INBOX - Las funciones del inbox van aqu√≠
// =====================

// Funci√≥n para cargar el Unified Inbox
async function loadUnifiedInbox() {
    try {
        console.log('üì® Cargando unified inbox...');
        
        // Cargar estad√≠sticas y conversaciones en paralelo
        const [statsResponse, conversationsResponse] = await Promise.all([
            apiCall('/api/inbox/stats'),
            apiCall(`/api/inbox/conversations?filter=${currentInboxFilter}&limit=50`)
        ]);
        
        if (statsResponse.success) {
            inboxStats = statsResponse.data;
            updateInboxTabs();
            updateInboxStatistics();
        }
        
        if (conversationsResponse.success) {
            inboxConversations = conversationsResponse.data.conversations;
            updateConversationsList();
        }
        
        console.log(`‚úÖ Cargadas ${inboxConversations.length} conversaciones`);
        
    } catch (error) {
        console.error('‚ùå Error cargando inbox:', error);
        showNotification('Error cargando inbox', 'error');
    }
}

// Actualizar pesta√±as del inbox
function updateInboxTabs() {
    const tabs = {
        'all': inboxStats.conversations?.total || 0,
        'unread': inboxStats.conversations?.unread || 0,
        'scheduled': inboxStats.conversations?.scheduled || 0,
        'draft': inboxStats.conversations?.draft || 0
    };
    
    Object.keys(tabs).forEach(tabKey => {
        const tabElement = document.querySelector(`[data-inbox-filter="${tabKey}"]`);
        if (tabElement) {
            const countElement = tabElement.querySelector('.inbox-count');
            if (countElement) {
                countElement.textContent = tabs[tabKey];
            }
        }
    });
}

// Actualizar estad√≠sticas del inbox
function updateInboxStatistics() {
    const stats = inboxStats;
    
    // Actualizar elementos de estad√≠sticas si existen
    const statsElements = {
        'total-conversations': stats.conversations?.total || 0,
        'total-opens': stats.emails?.opened || 0,
        'total-replies': stats.emails?.replied || 0,
        'total-unread': stats.conversations?.unread || 0
    };
    
    Object.keys(statsElements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = statsElements[id];
        }
    });
}

// Actualizar lista de conversaciones
function updateConversationsList() {
    const conversationsContainer = document.querySelector('#conversations-list');
    
    if (!conversationsContainer) {
        console.log('Container de conversaciones no encontrado');
        return;
    }
    
    if (inboxConversations.length === 0) {
        conversationsContainer.innerHTML = `
            <div class="text-center py-16">
                <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">No se encontraron conversaciones</p>
                <p class="text-sm text-gray-400">
                    ${currentInboxFilter === 'all' ? 'Env√≠a algunos emails para ver conversaciones aqu√≠' : 
                      `No hay conversaciones ${currentInboxFilter === 'unread' ? 'no le√≠das' : currentInboxFilter}`}
                </p>
                ${currentInboxFilter === 'all' ? 
                    '<button onclick="showSection(\'sequences\')" class="mt-2 text-tribearium-primary text-sm">Iniciar una Secuencia</button>' : 
                    ''}
            </div>
        `;
        return;
    }
    
    conversationsContainer.innerHTML = inboxConversations.map(conversation => `
        <div class="conversation-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer ${conversation.isUnread ? 'bg-blue-50' : ''}" 
             onclick="selectConversation('${conversation.id}', '${conversation.leadId}')"
             data-conversation-id="${conversation.id}">
            <div class="flex items-start space-x-3">
                <!-- Avatar -->
                <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white font-medium text-sm">
                        ${conversation.contact.name ? conversation.contact.name.charAt(0).toUpperCase() : 'U'}
                    </div>
                </div>
                
                <!-- Info de Conversaci√≥n -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <p class="text-sm font-medium text-gray-900 truncate">
                                ${conversation.contact.name || 'Contacto Desconocido'}
                            </p>
                            ${conversation.isUnread ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                        </div>
                        <div class="flex items-center space-x-2">
                            <!-- Indicadores de estado -->
                            ${conversation.wasReplied ? '<i class="fas fa-reply text-green-500 text-xs" title="Respondi√≥"></i>' : ''}
                            ${conversation.wasOpened && !conversation.wasReplied ? '<i class="fas fa-eye text-blue-500 text-xs" title="Abri√≥"></i>' : ''}
                            ${conversation.wasClicked ? '<i class="fas fa-mouse-pointer text-purple-500 text-xs" title="Hizo clic"></i>' : ''}
                            <span class="text-xs text-gray-500">${conversation.timeAgo}</span>
                        </div>
                    </div>
                    
                    <div class="mt-1">
                        <p class="text-sm text-gray-600 truncate">${conversation.contact.email}</p>
                        <p class="text-sm text-gray-500 truncate">${conversation.contact.company || ''}</p>
                    </div>
                    
                    <div class="mt-2">
                        <p class="text-sm font-medium text-gray-800 truncate">${conversation.subject}</p>
                        <p class="text-xs text-gray-500 truncate mt-1">${conversation.preview}</p>
                    </div>
                    
                    <!-- Info de secuencia y template -->
                    <div class="mt-2 flex items-center space-x-2">
                        ${conversation.templateDay ? 
                            `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                ${conversation.templateDay}
                            </span>` : ''}
                        ${conversation.status ? 
                            `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${getStatusBadgeClass(conversation.status)}">
                                ${conversation.status}
                            </span>` : ''}
                        <span class="text-xs text-gray-400">${conversation.totalEmails} email${conversation.totalEmails !== 1 ? 's' : ''}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Cambiar filtro del inbox
function switchInboxFilter(filter) {
    currentInboxFilter = filter;
    selectedConversation = null;
    
    // Actualizar estilo de pesta√±as
    document.querySelectorAll('[data-inbox-filter]').forEach(tab => {
        tab.classList.remove('text-tribearium-primary', 'border-b-2', 'border-tribearium-primary');
        tab.classList.add('text-gray-600');
    });
    
    const activeTab = document.querySelector(`[data-inbox-filter="${filter}"]`);
    if (activeTab) {
        activeTab.classList.remove('text-gray-600');
        activeTab.classList.add('text-tribearium-primary', 'border-b-2', 'border-tribearium-primary');
    }
    
    // Recargar conversaciones
    loadUnifiedInbox();
    
    // Limpiar detalles de conversaci√≥n
    updateConversationDetails(null);
}

// Seleccionar conversaci√≥n
async function selectConversation(conversationId, leadId) {
    try {
        selectedConversation = conversationId;
        
        // Resaltar conversaci√≥n seleccionada
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('bg-purple-50', 'border-purple-200');
        });
        
        const selectedItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('bg-purple-50', 'border-purple-200');
        }
        
        // Cargar detalles de conversaci√≥n
        const response = await apiCall(`/api/inbox/conversation/${leadId}`);
        
        if (response.success) {
            updateConversationDetails(response.data);
        }
        
    } catch (error) {
        console.error('Error cargando conversaci√≥n:', error);
        showNotification('Error cargando detalles de conversaci√≥n', 'error');
    }
}

// EN TU INDEX.HTML, busca la funci√≥n updateConversationDetails y reempl√°zala con esto:

// Actualizar detalles de conversaci√≥n
// EN TU INDEX.HTML, busca la funci√≥n updateConversationDetails y reemplaza la secci√≥n de botones:

// Actualizar detalles de conversaci√≥n - VERSI√ìN SIN DEBUG
function updateConversationDetails(conversationData) {
    const detailsContainer = document.querySelector('#conversation-details');
    
    if (!detailsContainer) {
        console.log('Container de detalles no encontrado');
        return;
    }
    
    if (!conversationData) {
        detailsContainer.innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <i class="fas fa-comments text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ninguna conversaci√≥n seleccionada</p>
                    <p class="text-sm text-gray-400">Elige una conversaci√≥n para ver detalles</p>
                </div>
            </div>
        `;
        return;
    }
    
    const { lead, emails } = conversationData;
    
    // Funci√≥n helper para renderizar emails de manera segura
    function renderEmailsList(emails) {
        if (emails.length === 0) {
            return '<div class="text-center py-8"><p class="text-gray-500">No hay emails en esta conversaci√≥n</p></div>';
        }
        
        const emailsHtml = emails.map(email => {
            const subject = (email.subject || 'Sin asunto').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const preview = (email.preview || 'Sin contenido').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            const timeAgo = email.timeAgo || 'Desconocido';
            const templateDay = email.templateDay || 'N/A';
            const status = email.status || 'sent';
            
            // Iconos de estado con mejor informaci√≥n
            const openIcon = email.wasOpened 
                ? '<span class="text-green-600"><i class="fas fa-eye mr-1"></i>Abierto</span>' 
                : '<span class="text-gray-400"><i class="fas fa-eye-slash mr-1"></i>No abierto</span>';
                
            const clickIcon = email.wasClicked 
                ? '<span class="text-purple-600"><i class="fas fa-mouse-pointer mr-1"></i>Clicado</span>' 
                : '';
                
            const replyIcon = email.wasReplied 
                ? '<span class="text-blue-600"><i class="fas fa-reply mr-1"></i>Respondido</span>' 
                : '';
            
            // Estado del email m√°s informativo
            let statusBadge = '';
            if (email.wasReplied) {
                statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Respondido</span>';
            } else if (email.wasClicked) {
                statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">Interesado</span>';
            } else if (email.wasOpened) {
                statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Visto</span>';
            } else {
                statusBadge = '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Enviado</span>';
            }
            
            return `
            <div class="email-item border border-gray-200 rounded-lg p-4 bg-white hover:bg-gray-50 transition-colors cursor-pointer" 
     onclick="showEmailContent(${email.id})">
                         <div class="flex justify-between items-start mb-3">
                        <h4 class="font-medium text-gray-900 max-w-md">${subject}</h4>
                        <div class="flex items-center space-x-2">
                            ${statusBadge}
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-3 max-w-full">${preview}</p>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4 text-xs">
                            ${openIcon}
                            ${clickIcon}
                            ${replyIcon}
                        </div>
                        <div class="text-xs text-gray-400">
                            Template: ${templateDay}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        return `<div class="space-y-4">${emailsHtml}</div>`;
    }
    
    // Construir el HTML principal - SIN BOT√ìN DE TEST TRACKING
    detailsContainer.innerHTML = `
        <!-- Header de Conversaci√≥n -->
        <div class="border-b border-gray-200 p-6">
            <div class="flex items-start justify-between">
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-r from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white font-medium">
                        ${lead.name ? lead.name.charAt(0).toUpperCase() : 'U'}
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">${lead.name || 'Contacto Desconocido'}</h3>
                        <p class="text-sm text-gray-600">${lead.email}</p>
                        <div class="flex items-center space-x-4 mt-1 text-sm text-gray-500">
                            ${lead.company ? `<span><i class="fas fa-building mr-1"></i>${lead.company}</span>` : ''}
                            ${lead.title ? `<span><i class="fas fa-user-tie mr-1"></i>${lead.title}</span>` : ''}
                            ${lead.industry ? `<span><i class="fas fa-industry mr-1"></i>${lead.industry}</span>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <!-- Lead Score -->
                    <div class="text-center">
                        <div class="text-2xl font-bold ${getScoreClass(lead.score)}">${lead.score || 0}</div>
                        <div class="text-xs text-gray-500">Score</div>
                    </div>
                    
                    <!-- Acciones SIMPLIFICADAS -->
                    <div class="flex items-center space-x-2">
                        <button onclick="sendManualEmailToLead('${lead.id}')" 
                                class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700">
                            <i class="fas fa-paper-plane mr-2"></i>Enviar Email
                        </button>
                        <button onclick="editProspect('${lead.id}')" 
                                class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                            <i class="fas fa-edit mr-2"></i>Editar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Estad√≠sticas del Lead -->
            <div class="mt-4 grid grid-cols-4 gap-4">
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-lg font-semibold text-gray-900">${lead.totalEmailsSent}</div>
                    <div class="text-xs text-gray-500">Emails Enviados</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-lg font-semibold text-gray-900">${lead.emailsOpened}</div>
                    <div class="text-xs text-gray-500">Abiertos</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-lg font-semibold text-gray-900">${lead.emailsReplied}</div>
                    <div class="text-xs text-gray-500">Respondidos</div>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <div class="text-lg font-semibold ${lead.qualified ? 'text-green-600' : 'text-gray-900'}">${lead.qualified ? 'S√≠' : 'No'}</div>
                    <div class="text-xs text-gray-500">Calificado</div>
                </div>
            </div>
            
            <!-- Instrucciones para tracking real -->
            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    <div class="text-sm text-blue-700">
                        <strong>Tracking en Tiempo Real:</strong> Los emails se rastrean autom√°ticamente cuando los abres en tu cliente de correo y haces clic en los links.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lista de Emails -->
        <div class="flex-1 overflow-y-auto p-6">
            ${renderEmailsList(emails)}
        </div>
    `;
}

// QUITAR ESTAS FUNCIONES DE DEBUG (ya no las necesitas):
// - debugEmailTracking()
// - simulateEmailOpen()
// - simulateEmailReply()

// Funci√≥n helper para obtener clase de score (si no existe)
function getScoreClass(score) {
    if (score >= 80) return 'text-green-600';
    if (score >= 60) return 'text-yellow-600';
    return 'text-red-600';
}

// AGREGAR esta funci√≥n para actualizar el inbox autom√°ticamente cada 30 segundos
let inboxAutoRefresh = null;

function startInboxAutoRefresh() {
    // Limpiar cualquier refresh anterior
    if (inboxAutoRefresh) {
        clearInterval(inboxAutoRefresh);
    }
    
    // Actualizar cada 30 segundos si estamos en la secci√≥n inbox
    inboxAutoRefresh = setInterval(() => {
        const inboxSection = document.getElementById('inbox-section');
        if (inboxSection && !inboxSection.classList.contains('hidden')) {
            console.log('üîÑ Auto-refrescando inbox...');
            loadUnifiedInbox();
        }
    }, 30000); // 30 segundos
}

function stopInboxAutoRefresh() {
    if (inboxAutoRefresh) {
        clearInterval(inboxAutoRefresh);
        inboxAutoRefresh = null;
    }
}

// ACTUALIZAR la funci√≥n showSection para manejar el auto-refresh
function showSection(sectionName) {
    // ... tu c√≥digo existente de showSection ...
    
    // Al final de la funci√≥n, agregar:
    if (sectionName === 'inbox') {
        startInboxAutoRefresh();
    } else {
        stopInboxAutoRefresh();
    }
}

console.log('‚úÖ Frontend configurado para tracking real');
console.log('üìß El inbox se actualizar√° autom√°ticamente cada 30 segundos');
console.log('üëÅÔ∏è Los emails mostrar√°n estado real cuando los abras en Gmail');
// TAMBI√âN AGREGA ESTA FUNCI√ìN PARA TESTING AL FINAL de tu JavaScript en index.html:

// Funci√≥n para probar el tracking de emails
async function debugEmailTracking(leadId) {
    try {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
        modal.innerHTML = `
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900">Test Email Tracking</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <button onclick="simulateEmailOpen('${leadId}')" 
                                class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            üß™ Simular Apertura de Email
                        </button>
                        <button onclick="simulateEmailReply('${leadId}')" 
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            üß™ Simular Respuesta Positiva
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error creando modal de debug:', error);
    }
}

// Funci√≥n para simular apertura de email
async function simulateEmailOpen(leadId) {
    try {
        const response = await fetch(`/api/debug/simulate-open/${leadId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('‚úÖ Email abierto simulado!', 'success');
            
            // Refrescar el inbox para ver los cambios
            setTimeout(() => {
                loadUnifiedInbox();
                if (selectedConversation) {
                    selectConversation(selectedConversation, leadId);
                }
            }, 1000);
        } else {
            showNotification('‚ö†Ô∏è ' + result.message, 'warning');
        }
        
    } catch (error) {
        console.error('Error simulando apertura:', error);
        showNotification('‚ùå Error simulando apertura', 'error');
    }
}

// Funci√≥n para simular respuesta de email
async function simulateEmailReply(leadId) {
    try {
        const response = await fetch(`/api/debug/simulate-reply/${leadId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sentiment: 'positive' })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('‚úÖ Respuesta simulada!', 'success');
            
            // Refrescar el inbox para ver los cambios
            setTimeout(() => {
                loadUnifiedInbox();
                if (selectedConversation) {
                    selectConversation(selectedConversation, leadId);
                }
            }, 1000);
        } else {
            showNotification('‚ö†Ô∏è ' + result.message, 'warning');
        }
        
    } catch (error) {
        console.error('Error simulando respuesta:', error);
        showNotification('‚ùå Error simulando respuesta', 'error');
    }
}

// Funci√≥n helper para obtener clase de score (si no existe)
function getScoreClass(score) {
    if (score >= 80) return 'text-green-600';
    if (score >= 60) return 'text-yellow-600';
    return 'text-red-600';
}

// Buscar conversaciones en el inbox
async function searchInboxConversations() {
    const searchTerm = document.getElementById('inboxSearch')?.value || '';
    
    try {
        const response = await apiCall(`/api/inbox/conversations?filter=${currentInboxFilter}&search=${encodeURIComponent(searchTerm)}&limit=50`);
        
        if (response.success) {
            inboxConversations = response.data.conversations;
            updateConversationsList();
        }
        
    } catch (error) {
        console.error('Error buscando conversaciones:', error);
    }
}

// Enviar email manual desde el inbox
async function sendManualEmailToLead(leadId) {
    try {
        // Crear modal simple para selecci√≥n de template
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
        modal.innerHTML = `
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-md w-full">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900">Enviar Email Manual</h3>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Template</label>
                            <select id="manualEmailTemplate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="day_1">Day 1 - Introducci√≥n</option>
                                <option value="day_3">Day 3 - Seguimiento</option>
                                <option value="day_7">Day 7 - Toque Final</option>
                                <option value="day_9">Day 9 - Nota Final</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button onclick="sendEmailFromInbox('${leadId}', document.getElementById('manualEmailTemplate').value); this.closest('.fixed').remove()" 
                                    class="btn-primary text-white px-4 py-2 rounded-lg">
                                Enviar Email
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error creando modal de email:', error);
    }
}

// Enviar email desde inbox
async function sendEmailFromInbox(leadId, templateKey) {
    try {
        const response = await apiCall('/api/send-email', {
            method: 'POST',
            body: JSON.stringify({
                lead_id: leadId,
                template_key: templateKey,
                sequence_id: 'manual_inbox'
            })
        });
        
        if (response.success) {
            showNotification('Email enviado exitosamente!', 'success');
            
            // Refrescar la conversaci√≥n si est√° seleccionada
            if (selectedConversation) {
                selectConversation(selectedConversation, leadId);
            }
            
            // Refrescar inbox
            loadUnifiedInbox();
        }
        
    } catch (error) {
        console.error('Error enviando email:', error);
        showNotification('Error enviando email', 'error');
    }
}
// Marcar como respondido
async function markAsReplied(leadId) {
    try {
        const response = await apiCall(`/api/email-tracking/mark-reply/${leadId}`, {
            method: 'POST',
            body: JSON.stringify({
                sentiment: 'neutral'
            })
        });
        
        if (response.success) {
            showNotification('Marcado como respondido', 'success');
            
            // Refrescar conversaci√≥n
            if (selectedConversation) {
                selectConversation(selectedConversation, leadId);
            }
            
            loadUnifiedInbox();
        }
        
    } catch (error) {
        console.error('Error marcando como respondido:', error);
        showNotification('Error actualizando conversaci√≥n', 'error');
    }
}

// Actualizar la funci√≥n loadSectionData para incluir inbox
function loadSectionData(sectionName) {
    switch (sectionName) {
        case 'prospects': loadProspects(); break;
        case 'sequences': loadSequences(); break;
        case 'templates': loadTemplates(); break;
        case 'analytics': loadAnalytics(); break;
        case 'clients': loadClients(); break;
        case 'settings': loadSettings(); break;
        case 'inbox': 
            loadUnifiedInbox(); 
            break;
    }
}

























    // ===== API Helper Functions =====
    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(endpoint, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        console.error(`API call failed: ${endpoint}`, error);
        showNotification(`Error: ${error.message}`, 'error');
        throw error;
      }
    }

    // ===== Notification System =====
    function showNotification(message, type = 'info') {
      const notificationContainer = document.getElementById('notifications');
      const notification = document.createElement('div');
      
      const typeClasses = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-white',
        info: 'bg-blue-500 text-white'
      };

      notification.className = `px-6 py-4 rounded-lg shadow-lg mb-4 transition-all duration-300 ${typeClasses[type] || typeClasses.info}`;
      notification.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle"></i>
            <span>${message}</span>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;

      notificationContainer.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    // ===== Navigation =====
    function showSection(sectionName) {
    // Ocultar todas las secciones
    const sections = ['homepage', 'sequences', 'tasks', 'inbox', 'clients', 'leadfinder', 'prospects', 'verifier', 'templates', 'analytics', 'settings'];
    
    sections.forEach(section => {
        const sectionElement = document.getElementById(section + '-section');
        if (sectionElement) {
            sectionElement.classList.add('hidden');
        }
    });
    
    // Mostrar la secci√≥n seleccionada
    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
        targetSection.classList.remove('hidden');
    }
    
    // Actualizar el estado activo del sidebar
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('onclick')?.includes(sectionName)) {
            item.classList.add('active');
        }
    });
    
    // Cargar los datos de la secci√≥n si es necesario
    loadSectionData(sectionName);
}


    // ===== Modal Functions =====
    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.classList.remove('hidden');
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.classList.add('hidden');
    }

    // ===== Prospects Management =====
    async function loadProspects() {
    try {
        showLoading('prospects');
        
        // Construir par√°metros
        const queryParams = new URLSearchParams({
            limit: pageSize,
            offset: (currentPage - 1) * pageSize,
            sort: 'created_at',
            order: 'desc'
        });
        
        // Agregar filtros activos
        Object.keys(currentFilters).forEach(key => {
            const value = currentFilters[key];
            if (value !== undefined && value !== null && value !== '') {
                queryParams.append(key, value);
            }
        });
        
        console.log('API call with params:', queryParams.toString()); // Debug
        
        const data = await apiCall(`/api/leads?${queryParams}`);
        
        if (data.success) {
            apiData.prospects = data.data || [];
            console.log(`Loaded ${apiData.prospects.length} prospects`); // Debug
            updateProspectsTable();
            updatePagination(data.pagination);
        }
    } catch (error) {
        console.error('Error loading prospects:', error);
        showNotification('Error loading prospects', 'error');
    } finally {
        hideLoading('prospects');
    }
}

    function updateProspectsTable() {
    const tbody = document.getElementById('prospectsTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!apiData.prospects.length) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-16">
                    <div class="space-y-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full">
                            <i class="fas fa-users text-2xl text-gray-400"></i>
                        </div>
                        <div>
                            <p class="text-xl text-gray-500 font-medium mb-2">No prospects found</p>
                            <p class="text-gray-400">Start by finding leads or importing your contacts</p>
                        </div>
                        <button onclick="showSection('leadfinder')" class="btn-primary text-white px-6 py-3 rounded-lg">
                            <i class="fas fa-search mr-2"></i>Find Leads
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    apiData.prospects.forEach(prospect => {
        const status = prospect.email_sequence_status || 'not_started';
        const statusClass = getStatusClass(status);
        const statusText = getStatusText(status);
        const score = Number(prospect.score || 0);
        
        // NUEVO: Verificar si es premium
        const isPremium = prospect.is_premium || prospect.linkedin_enriched;

        const tr = document.createElement('tr');
        tr.className = 'table-hover' + (isPremium ? ' bg-yellow-50' : '');
        tr.dataset.leadId = prospect.id;
        
        tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="checkbox" class="rounded prospect-checkbox" data-lead-id="${prospect.id}" onchange="updateSelectedProspects()">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div>
                        <div class="text-sm font-medium text-gray-900">${prospect.name || 'N/A'}</div>
                        ${isPremium ? '<span class="inline-flex items-center px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs rounded-full mt-1"><i class="fas fa-star mr-1"></i>Premium</span>' : ''}
                        ${prospect.linkedin_headline ? '<div class="text-xs text-gray-500 mt-1 italic">' + prospect.linkedin_headline + '</div>' : ''}
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${prospect.email || 'N/A'}</div>
                ${isPremium && prospect.linkedin_enriched ? '<div class="text-xs text-blue-600"><i class="fab fa-linkedin"></i> Verified</div>' : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${prospect.title || 'N/A'}</div>
                ${prospect.current_position_duration ? '<div class="text-xs text-gray-500">' + prospect.current_position_duration + '</div>' : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${prospect.company || 'N/A'}</div>
                ${prospect.previous_companies && prospect.previous_companies.length > 0 ? 
                    '<div class="text-xs text-gray-500">+' + prospect.previous_companies.length + ' previous</div>' : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${prospect.industry || 'N/A'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${prospect.sequence_id ? 'In Sequence' : 'Not assigned'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${prospect.real_email_verified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                    ${prospect.real_email_verified ? 'Verified' : 'Unverified'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getScoreClass(score)}">
                    ${score}${isPremium ? ' ‚≠ê' : ''}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex items-center space-x-2">
                    ${isPremium ? 
                        '<button onclick="viewLinkedInEnrichedDetails(\'' + prospect.id + '\')" class="text-yellow-600 hover:text-yellow-800" title="View Premium Details"><i class="fas fa-star"></i></button>' : 
                        ''
                    }
                    <button onclick="editProspect('${prospect.id}')" class="text-blue-600 hover:text-blue-800" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="sendEmailToProspect('${prospect.id}')" class="text-green-600 hover:text-green-800" title="Send Email">
                        <i class="fas fa-envelope"></i>
                    </button>
                    <button onclick="showProspectActions('${prospect.id}')" class="text-gray-400 hover:text-gray-600" title="More">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}
    // ===== Sequences Management =====
    async function loadSequences() {
      try {
        showLoading('sequences');
        const data = await apiCall('/api/sequences');
        
        if (data.success) {
          apiData.sequences = data.data || [];
          updateSequencesTable();
          updateSequenceFilters();
        }
      } catch (error) {
        showNotification('Error loading sequences', 'error');
      } finally {
        hideLoading('sequences');
      }
    }
    function updateSequencesTable() {
      const tbody = document.getElementById('sequencesTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!apiData.sequences.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center py-16">
              <div class="space-y-4">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full">
                  <i class="fas fa-paper-plane text-2xl text-gray-400"></i>
                </div>
                <div>
                  <p class="text-xl text-gray-500 font-medium mb-2">No sequences found</p>
                  <p class="text-gray-400">Create your first email sequence to get started</p>
                </div>
                <button onclick="createSequence()" class="btn-primary text-white px-6 py-3 rounded-lg">Create Sequence</button>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      apiData.sequences.forEach(sequence => {
        const contacted = Number(sequence.contacted || 0);
        const prospects_count = Number(sequence.prospects_count || 0);
        const opened = Number(sequence.opened || 0);
        const replied = Number(sequence.replied || 0);
        const score = Math.round(((opened + replied) / Math.max(prospects_count, 1)) * 100);

        const tr = document.createElement('tr');
        tr.className = 'table-hover';
        
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <input type="checkbox" class="rounded sequence-checkbox" data-sequence-id="${sequence.id}">
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-2 h-2 ${sequence.status === 'active' ? 'bg-green-400' : 'bg-gray-400'} rounded-full mr-3"></div>
              <div>
                <div class="text-sm font-medium text-gray-900">${sequence.name || '-'}</div>
                <div class="text-sm text-gray-500">${sequence.status || 'Draft'}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                <span class="text-xs font-medium">${contacted}</span>
              </div>
              <span class="ml-2 text-sm text-gray-500">/${prospects_count}</span>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">${score}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${prospects_count}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${contacted}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${opened}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${replied}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${sequence.positive || 0}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex items-center space-x-2">
              <button onclick="editSequence('${sequence.id}')" class="text-blue-600 hover:text-blue-800" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="addProspectsToSequence('${sequence.id}')" class="text-green-600 hover:text-green-800" title="Add Prospects">
                <i class="fas fa-user-plus"></i>
              </button>
              <button onclick="showSequenceActions('${sequence.id}')" class="text-gray-400 hover:text-gray-600" title="More">
                <i class="fas fa-ellipsis-v"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // ===== Form Submissions =====
    async function submitSequenceForm(event) {
      event.preventDefault();
      
      const name = document.getElementById('sequenceName').value.trim();
      const description = document.getElementById('sequenceDescription').value.trim();
      
      if (!name) {
        showNotification('Please enter a sequence name', 'warning');
        return;
      }

      try {
        const data = await apiCall('/api/sequences', {
          method: 'POST',
          body: JSON.stringify({ name, description })
        });

        if (data.success) {
          showNotification(`Sequence "${name}" created successfully!`, 'success');
          closeModal('createSequenceModal');
          document.getElementById('sequenceForm').reset();
          loadSequences();
        }
      } catch (error) {
        showNotification('Error creating sequence', 'error');
      }
    }

    async function submitProspectForm(event) {
      event.preventDefault();
      
      const prospectData = {
        name: document.getElementById('prospectName').value.trim(),
        email: document.getElementById('prospectEmail').value.trim(),
        title: document.getElementById('prospectTitle').value.trim(),
        company: document.getElementById('prospectCompany').value.trim(),
        phone: document.getElementById('prospectPhone').value.trim(),
        website: document.getElementById('prospectWebsite').value.trim(),
        location: document.getElementById('prospectLocation').value.trim(),
        industry: document.getElementById('prospectIndustry').value
      };

      if (!prospectData.name || !prospectData.email) {
        showNotification('Name and email are required', 'warning');
        return;
      }

      try {
        const data = await apiCall('/api/prospects', {
          method: 'POST',
          body: JSON.stringify(prospectData)
        });

        if (data.success) {
          showNotification(`Prospect "${prospectData.name}" added successfully!`, 'success');
          closeModal('addProspectModal');
          document.getElementById('prospectForm').reset();
          loadProspects();
        }
      } catch (error) {
        if (error.message.includes('409')) {
          showNotification('Email already exists', 'warning');
        } else {
          showNotification('Error adding prospect', 'error');
        }
      }
    }

    async function submitClientForm(event) {
      event.preventDefault();
      
      const clientData = {
        name: document.getElementById('clientName').value.trim(),
        email: document.getElementById('clientEmail').value.trim(),
        company: document.getElementById('clientCompany').value.trim()
      };

      if (!clientData.name || !clientData.email) {
        showNotification('Name and email are required', 'warning');
        return;
      }

      try {
        const data = await apiCall('/api/clients', {
          method: 'POST',
          body: JSON.stringify(clientData)
        });

        if (data.success) {
          showNotification(`Client "${clientData.name}" added successfully!`, 'success');
          closeModal('addClientModal');
          document.getElementById('clientForm').reset();
          loadClients();
        }
      } catch (error) {
        showNotification('Error adding client', 'error');
      }
    }

    // ===== Action Functions =====
    function createSequence() {
      openModal('createSequenceModal');
    }

    function addProspect() {
      openModal('addProspectModal');
    }

    function addClient() {
      openModal('addClientModal');
    }

    function importProspects() {
      openModal('fileUploadModal');
    }

    async function runApolloSearch() {
      try {
        showNotification('Starting Apollo search...', 'info');
        
        const searchData = {
          prompt: document.getElementById('aiSearchInput')?.value || document.getElementById('bulkSearchText')?.value || 'Find business leaders',
          count: 25,
          location: document.getElementById('locationFilter')?.value,
          jobTitle: document.getElementById('jobTitleFilter')?.value,
          industry: document.getElementById('industryFilter')?.value,
          companySize: document.getElementById('companySizeFilter')?.value
        };

        const data = await apiCall('/api/apollo-scraper', {
          method: 'POST',
          body: JSON.stringify(searchData)
        });

        if (data.success) {
          showNotification('Apollo search started! Generating leads...', 'success');
          setTimeout(() => {
            loadProspects();
            showSection('prospects');
          }, 3000);
        }
      } catch (error) {
        showNotification('Error running Apollo search', 'error');
      }
    }

    function runAISearch() {
      runApolloSearch();
    }

    // ===== Utility Functions =====
    function getStatusClass(status) {
      const statusMap = {
        'not_started': 'bg-gray-100 text-gray-800',
        'in_sequence': 'bg-blue-100 text-blue-800',
        'contacted': 'bg-green-100 text-green-800',
        'replied': 'bg-purple-100 text-purple-800',
        'paused': 'bg-yellow-100 text-yellow-800'
      };
      return statusMap[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusText(status) {
      const statusMap = {
        'not_started': 'Not Started',
        'in_sequence': 'In Sequence',
        'contacted': 'Contacted',
        'replied': 'Replied',
        'paused': 'Paused'
      };
      return statusMap[status] || 'Not Started';
    }

    function getScoreClass(score) {
      if (score >= 80) return 'bg-green-100 text-green-800';
      if (score >= 60) return 'bg-yellow-100 text-yellow-800';
      return 'bg-red-100 text-red-800';
    }

    function showLoading(section) {
      const sectionElement = document.getElementById(section + '-section');
      if (sectionElement) {
        sectionElement.classList.add('loading');
      }
    }

    function hideLoading(section) {
      const sectionElement = document.getElementById(section + '-section');
      if (sectionElement) {
        sectionElement.classList.remove('loading');
      }
    }

    // ===== Selection Management =====
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllProspects');
      const checkboxes = document.querySelectorAll('.prospect-checkbox');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
      });
      
      updateSelectedProspects();
    }

    function updateSelectedProspects() {
      const checkboxes = document.querySelectorAll('.prospect-checkbox:checked');
      selectedProspects = Array.from(checkboxes).map(cb => cb.dataset.leadId);
      
      const bulkBar = document.getElementById('bulkActionsBar');
      const selectedCount = document.getElementById('selectedCount');
      
      if (selectedProspects.length > 0) {
        bulkBar?.classList.remove('hidden');
        if (selectedCount) selectedCount.textContent = selectedProspects.length;
      } else {
        bulkBar?.classList.add('hidden');
      }
    }

    // ===== Pagination =====
    function updatePagination(pagination) {
      if (!pagination) return;

      const showingFrom = document.getElementById('showingFrom');
      const showingTo = document.getElementById('showingTo');
      const totalProspects = document.getElementById('totalProspects');
      const currentPageSpan = document.getElementById('currentPage');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      if (showingFrom) showingFrom.textContent = pagination.offset + 1;
      if (showingTo) showingTo.textContent = Math.min(pagination.offset + pagination.limit, pagination.total);
      if (totalProspects) totalProspects.textContent = pagination.total;
      if (currentPageSpan) currentPageSpan.textContent = pagination.current_page;
      
      if (prevBtn) prevBtn.disabled = pagination.current_page <= 1;
      if (nextBtn) nextBtn.disabled = pagination.current_page >= pagination.pages;
    }

    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        loadProspects();
      }
    }

    function nextPage() {
      currentPage++;
      loadProspects();
    }

// ===== Search and Filtering =====
// Buscar al escribir (debounced para mejor performance)
let searchTimeout;
function searchProspects() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        filterProspects();
    }, 300); // Esperar 300ms despu√©s de dejar de escribir
}

    function filterProspects() {
    const searchTerm = document.getElementById('prospectSearch')?.value?.trim();
    const industry = document.getElementById('prospectIndustryFilter')?.value;
    const status = document.getElementById('prospectStatusFilter')?.value;
    const qualified = document.getElementById('prospectQualifiedFilter')?.value;
    const premium = document.getElementById('prospectPremiumFilter')?.value;
    
    // Limpiar filtros anteriores
    currentFilters = {};
    
    // Solo agregar filtros que tengan valor
    if (searchTerm && searchTerm !== '') {
        currentFilters.search = searchTerm;
    }
    
    if (industry && industry !== '') {
        currentFilters.industry = industry;
    }
    
    if (status && status !== '') {
        currentFilters.status = status;
    }
    
    if (qualified && qualified !== '') {
        currentFilters.qualified_only = qualified;
    }
    
    if (premium === 'premium') {
        currentFilters.qualified_only = 'true'; // Los premium suelen estar calificados
        currentFilters.min_score = '80'; // Los premium tienen score alto
    } else if (premium === 'regular') {
        currentFilters.max_score = '79'; // Regular tienen score m√°s bajo
    }
    
    // Resetear a p√°gina 1
    currentPage = 1;
    
    console.log('Applying filters:', currentFilters); // Debug
    
    // Cargar prospects con filtros
    loadProspects();
}


    function updateTemplatesTable() {
      const tbody = document.getElementById('templatesTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!apiData.templates.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-16">
              <div class="space-y-4">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full">
                  <i class="fas fa-file-alt text-2xl text-gray-400"></i>
                </div>
                <div>
                  <p class="text-xl text-gray-500 font-medium mb-2">No templates found</p>
                  <p class="text-gray-400">Create your first email template to get started</p>
                </div>
                <button onclick="createTemplate()" class="btn-primary text-white px-6 py-3 rounded-lg">Create Template</button>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      apiData.templates.forEach(template => {
        const tr = document.createElement('tr');
        tr.className = 'table-hover';
        
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${template.title}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${template.subject}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center space-x-4">
              <div class="flex items-center text-sm text-gray-600">
                <i class="fas fa-heart mr-1"></i>${template.performance?.likes || 0}
              </div>
              <div class="flex items-center text-sm text-gray-600">
                <i class="fas fa-eye mr-1"></i>${template.performance?.views || 0}
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${template.owner}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex items-center space-x-2">
              <button onclick="editTemplate('${template.id}')" class="text-blue-600 hover:text-blue-800" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="useTemplate('${template.id}')" class="text-green-600 hover:text-green-800" title="Use Template">
                <i class="fas fa-play"></i>
              </button>
              <button onclick="showTemplateActions('${template.id}')" class="text-gray-400 hover:text-gray-600" title="More">
                <i class="fas fa-ellipsis-v"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    async function loadAnalytics() {
    try {
        const data = await apiCall('/api/analytics');
        if (data.success) {
            apiData.analytics = data.data || {};
            updateAnalyticsDisplay();
            createAnalyticsChart(data.data); // Agregar esta l√≠nea
        }
    } catch (error) {
        showNotification('Error loading analytics', 'error');
    }
}

let analyticsChart = null;

// Funci√≥n para crear chart con data real
async function createAnalyticsChart(period = 'daily') {
    try {
        const days = period === 'daily' ? 7 : period === 'weekly' ? 30 : 90;
        const data = await apiCall(`/api/analytics/chart?days=${days}&period=${period}`);
        
        if (!data.success) return;
        
        const ctx = document.getElementById('analyticsChart');
        if (!ctx) return;

        // Destroy existing chart
        if (analyticsChart) {
            analyticsChart.destroy();
        }

        analyticsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.data.labels,
                datasets: [{
                    label: 'Prospects Added',
                    data: data.data.prospects,
                    borderColor: '#7c3aed',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Emails Sent',
                    data: data.data.emails,
                    borderColor: '#06b6d4',
                    backgroundColor: 'rgba(6, 182, 212, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Replies',
                    data: data.data.replies,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}
    function updateAnalyticsDisplay() {
      const analytics = apiData.analytics;
      
      // Update summary cards
      const elements = {
        'analyticsProspects': analytics.total_prospects || 0,
        'analyticsContacted': analytics.contacted || 0,
        'analyticsOpened': analytics.opened || 0,
        'analyticsReplied': analytics.replied || 0,
        'analyticsQualified': analytics.qualified || 0,
        'analyticsTargeted': analytics.targeted || 0,
        'analyticsPositive': analytics.positive || 0,
        'analyticsAvgScore': analytics.avg_score || 0
      };

      Object.entries(elements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
      });

      // Update percentages
      const percentages = {
        'contactedPercent': analytics.open_rate || 0,
        'openedPercent': analytics.open_rate || 0,
        'repliedPercent': analytics.reply_rate || 0,
        'qualifiedPercent': analytics.qualification_rate || 0,
        'targetedPercent': analytics.targeting_rate || 0,
        'positivePercent': analytics.positive_rate || 0
      };

      Object.entries(percentages).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.textContent = `${value}%`;
      });
    }

    async function loadClients() {
      try {
        const data = await apiCall('/api/clients');
        if (data.success) {
          apiData.clients = data.data || [];
          updateClientsTable();
        }
      } catch (error) {
        showNotification('Error loading clients', 'error');
      }
    }















// ===== CLIENT MANAGEMENT ACTION FUNCTIONS =====
    
async function editClient(clientId) {
      try {
        const client = apiData.clients.find(c => c.id == clientId);
        if (client) {
          // Create edit client modal
          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
          modal.innerHTML = `
            <div class="flex items-center justify-center min-h-screen p-4">
              <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6 border-b border-gray-200">
                  <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-gray-900">Edit Client: ${client.name}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
                <div class="p-6">
                  <form id="editClientForm" onsubmit="updateClient(event, '${clientId}')">
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label>
                        <input type="text" id="editClientName" value="${client.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="editClientEmail" value="${client.email}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company</label>
                        <input type="text" id="editClientCompany" value="${client.company || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Permission Status</label>
                        <select id="editClientPermissions" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                          <option value="No Access" ${client.permission_status === 'No Access' ? 'selected' : ''}>No Access</option>
                          <option value="Read Only" ${client.permission_status === 'Read Only' ? 'selected' : ''}>Read Only</option>
                          <option value="Full Access" ${client.permission_status === 'Full Access' ? 'selected' : ''}>Full Access</option>
                        </select>
                      </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                      <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                      <button type="submit" class="btn-primary text-white px-4 py-2 rounded-lg">Update Client</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
        }
      } catch (error) {
        showNotification('Error loading client for editing', 'error');
      }
    }

    async function updateClient(event, clientId) {
      event.preventDefault();
      
      const clientData = {
        name: document.getElementById('editClientName').value.trim(),
        email: document.getElementById('editClientEmail').value.trim(),
        company: document.getElementById('editClientCompany').value.trim(),
        permission_status: document.getElementById('editClientPermissions').value
      };

      try {
        const data = await apiCall(`/api/clients/${clientId}`, {
          method: 'PUT',
          body: JSON.stringify(clientData)
        });

        if (data.success) {
          showNotification('Client updated successfully!', 'success');
          document.querySelector('.fixed').remove();
          loadClients();
        }
      } catch (error) {
        showNotification('Error updating client', 'error');
      }
    }

    function showClientActions(clientId) {
      const client = apiData.clients.find(c => c.id == clientId);
      if (!client) return;
      
      // Create actions dropdown
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-30 z-50';
      modal.onclick = () => modal.remove();
      
      modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-white rounded-lg shadow-lg p-4 min-w-48" onclick="event.stopPropagation()">
            <div class="space-y-2">
              <button onclick="editClient('${clientId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-edit mr-3 text-blue-500"></i>Edit Client
              </button>
              <button onclick="viewClientDetails('${clientId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-eye mr-3 text-green-500"></i>View Details
              </button>
              <button onclick="manageClientPermissions('${clientId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-key mr-3 text-purple-500"></i>Manage Permissions
              </button>
              <button onclick="viewClientActivity('${clientId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-chart-line mr-3 text-teal-500"></i>View Activity
              </button>
              <hr class="my-2">
              <button onclick="deleteClient('${clientId}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 rounded flex items-center">
                <i class="fas fa-trash mr-3"></i>Delete Client
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function viewClientDetails(clientId) {
      try {
        const client = apiData.clients.find(c => c.id == clientId);
        if (!client) return;

        // Create client details modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
        modal.innerHTML = `
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-bold text-gray-900">Client Details: ${client.name}</h3>
                  <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                  <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600">${client.active_sequences}</div>
                    <div class="text-sm text-blue-700">Active Sequences</div>
                  </div>
                  <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600">${client.total_prospects}</div>
                    <div class="text-sm text-green-700">Total Prospects</div>
                  </div>
                  <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600">${client.total_emails_sent}</div>
                    <div class="text-sm text-purple-700">Emails Sent</div>
                  </div>
                  <div class="bg-yellow-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-yellow-600">${client.active_email_accounts}</div>
                    <div class="text-sm text-yellow-700">Email Accounts</div>
                  </div>
                </div>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Information</label>
                    <div class="bg-gray-50 p-3 rounded-lg">
                      <div><strong>Email:</strong> ${client.email}</div>
                      <div><strong>Company:</strong> ${client.company || 'Not specified'}</div>
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Access Status</label>
                    <div class="bg-gray-50 p-3 rounded-lg">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${client.permission_status === 'Full Access' ? 'bg-green-100 text-green-800' : client.permission_status === 'Read Only' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                        ${client.permission_status}
                      </span>
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Created</label>
                    <div class="bg-gray-50 p-3 rounded-lg">
                      ${client.created_at ? new Date(client.created_at).toLocaleDateString() : 'Unknown'}
                    </div>
                  </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                  <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close</button>
                  <button onclick="editClient('${clientId}'); this.closest('.fixed').remove()" class="btn-primary text-white px-4 py-2 rounded-lg">Edit Client</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      } catch (error) {
        showNotification('Error loading client details', 'error');
      }
    }

    function manageClientPermissions(clientId) {
      showNotification('Permission management - Coming soon!', 'info');
    }

    function viewClientActivity(clientId) {
      showNotification('Client activity tracking - Coming soon!', 'info');
    }

    async function deleteClient(clientId) {
      const client = apiData.clients.find(c => c.id == clientId);
      if (!client) return;

      if (!confirm(`Are you sure you want to delete client "${client.name}"? This action cannot be undone.`)) {
        return;
      }

      try {
        const data = await apiCall(`/api/clients/${clientId}`, {
          method: 'DELETE'
        });

        if (data.success) {
          showNotification('Client deleted successfully', 'success');
          loadClients();
        }
      } catch (error) {
        showNotification('Error deleting client', 'error');
      }
    }

    // ===== Additional Action Functions =====
function updateClientsTable() {
      const tbody = document.getElementById('clientsTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!apiData.clients.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-16">
              <div class="space-y-4">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full">
                  <i class="fas fa-building text-2xl text-gray-400"></i>
                </div>
                <div>
                  <p class="text-xl text-gray-500 font-medium mb-2">No clients found</p>
                  <p class="text-gray-400">Add your first client to get started</p>
                </div>
                <button onclick="addClient()" class="btn-primary text-white px-6 py-3 rounded-lg">Add Client</button>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      apiData.clients.forEach(client => {
        const tr = document.createElement('tr');
        tr.className = 'table-hover';
        
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="w-8 h-8 bg-green-500 rounded-full mr-3"></div>
              <div>
                <div class="text-sm font-medium text-gray-900">${client.name}</div>
                <div class="text-sm text-gray-500">${client.email}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.active_sequences || 0}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.active_email_accounts || 0}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.total_prospects || 0}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.total_emails_sent || 0}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
              ${client.permission_status || 'No Access'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${client.created_at ? new Date(client.created_at).toLocaleDateString() : 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <div class="flex items-center space-x-2">
              <button onclick="editClient('${client.id}')" class="text-blue-600 hover:text-blue-800" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="showClientActions('${client.id}')" class="text-gray-400 hover:text-gray-600" title="More">
                <i class="fas fa-ellipsis-v"></i>
              </button>
            </div>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    async function loadSettings() {
      try {
        const data = await apiCall('/api/settings');
        if (data.success) {
          apiData.settings = data.data || {};
          updateSettingsDisplay();
        }
      } catch (error) {
        showNotification('Error loading settings', 'error');
      }
    }

    function updateSettingsDisplay() {
      const settings = apiData.settings;
      
      // Update email settings
      if (settings.email) {
        const gmailAccount = document.getElementById('gmailAccount');
        if (gmailAccount && settings.email.account) {
          gmailAccount.value = settings.email.account;
        }
        
        const emailStatus = document.getElementById('emailStatus');
        if (emailStatus) {
          emailStatus.textContent = settings.apis?.gmail_configured ? '‚úì Connected and verified' : '‚ùå Not configured';
          emailStatus.className = settings.apis?.gmail_configured ? 'text-xs text-green-600 mt-1' : 'text-xs text-red-600 mt-1';
        }
      }

      // Update API status
      const apiStatuses = {
        'apifyStatus': settings.apis?.apify_connected,
        'hunterStatus': settings.apis?.hunter_connected,
        'googleStatus': settings.apis?.google_places_connected
      };

      Object.entries(apiStatuses).forEach(([id, connected]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = connected ? '‚úì Connected and active' : '‚ùå Not connected';
          element.className = connected ? 'text-xs text-green-600 mt-1' : 'text-xs text-red-600 mt-1';
        }
      });
    }

    // ===== Additional Action Functions =====
// ===== Additional Action Functions =====






















// ===== Additional Action Functions =====
async function bulkAddToSequence() {
      if (selectedProspects.length === 0) {
        showNotification('Please select prospects first', 'warning');
        return;
      }

      // Load sequences for selection
      const data = await apiCall('/api/sequences');
      if (data.success) {
        const select = document.getElementById('sequenceSelect');
        if (select) {
          select.innerHTML = '<option value="">Choose a sequence...</option>';
          data.data.forEach(sequence => {
            const option = document.createElement('option');
            option.value = sequence.id;
            option.textContent = sequence.name;
            select.appendChild(option);
          });
        }
      }

      openModal('addToSequenceModal');
    }

    async function confirmAddToSequence() {
      const sequenceId = document.getElementById('sequenceSelect')?.value;
      if (!sequenceId) {
        showNotification('Please select a sequence', 'warning');
        return;
      }

      try {
        const data = await apiCall(`/api/sequences/${sequenceId}/prospects`, {
          method: 'POST',
          body: JSON.stringify({ prospect_ids: selectedProspects })
        });

        if (data.success) {
          showNotification(`Added ${selectedProspects.length} prospects to sequence`, 'success');
          closeModal('addToSequenceModal');
          selectedProspects = [];
          updateSelectedProspects();
          loadProspects();
        }
      } catch (error) {
        showNotification('Error adding to sequence', 'error');
      }
    }

    // ===== PROSPECT ACTIONS (FIXED) =====
    // ===== Additional Action Functions =====
    async function bulkAddToSequence() {
      if (selectedProspects.length === 0) {
        showNotification('Please select prospects first', 'warning');
        return;
      }

      // Load sequences for selection
      const data = await apiCall('/api/sequences');
      if (data.success) {
        const select = document.getElementById('sequenceSelect');
        if (select) {
          select.innerHTML = '<option value="">Choose a sequence...</option>';
          data.data.forEach(sequence => {
            const option = document.createElement('option');
            option.value = sequence.id;
            option.textContent = sequence.name;
            select.appendChild(option);
          });
        }
      }

      openModal('addToSequenceModal');
    }

    async function confirmAddToSequence() {
      const sequenceId = document.getElementById('sequenceSelect')?.value;
      if (!sequenceId) {
        showNotification('Please select a sequence', 'warning');
        return;
      }

      try {
        const data = await apiCall(`/api/sequences/${sequenceId}/prospects`, {
          method: 'POST',
          body: JSON.stringify({ prospect_ids: selectedProspects })
        });

        if (data.success) {
          showNotification(`Added ${selectedProspects.length} prospects to sequence`, 'success');
          closeModal('addToSequenceModal');
          selectedProspects = [];
          updateSelectedProspects();
          loadProspects();
        }
      } catch (error) {
        showNotification('Error adding to sequence', 'error');
      }
    }

    // ===== PROSPECT ACTIONS (FIXED) =====
    function editProspect(id) {
      // Get prospect data and populate edit form
      const prospect = apiData.prospects.find(p => p.id == id);
      if (prospect) {
        document.getElementById('prospectName').value = prospect.name || '';
        document.getElementById('prospectEmail').value = prospect.email || '';
        document.getElementById('prospectTitle').value = prospect.title || '';
        document.getElementById('prospectCompany').value = prospect.company || '';
        document.getElementById('prospectPhone').value = prospect.phone || '';
        document.getElementById('prospectWebsite').value = prospect.website || '';
        document.getElementById('prospectLocation').value = prospect.location || '';
        document.getElementById('prospectIndustry').value = prospect.industry || '';
        
        // Change form to edit mode
        const form = document.getElementById('prospectForm');
        form.onsubmit = (e) => updateProspect(e, id);
        
        document.querySelector('#addProspectModal h3').textContent = 'Edit Prospect';
        document.querySelector('#addProspectModal button[type="submit"]').textContent = 'Update Prospect';
        
        openModal('addProspectModal');
      }
    }

    async function updateProspect(event, prospectId) {
      event.preventDefault();
      
      const prospectData = {
        name: document.getElementById('prospectName').value.trim(),
        email: document.getElementById('prospectEmail').value.trim(),
        title: document.getElementById('prospectTitle').value.trim(),
        company: document.getElementById('prospectCompany').value.trim(),
        phone: document.getElementById('prospectPhone').value.trim(),
        website: document.getElementById('prospectWebsite').value.trim(),
        location: document.getElementById('prospectLocation').value.trim(),
        industry: document.getElementById('prospectIndustry').value
      };

      try {
        const data = await apiCall(`/api/prospects/${prospectId}`, {
          method: 'PUT',
          body: JSON.stringify(prospectData)
        });

        if (data.success) {
          showNotification('Prospect updated successfully!', 'success');
          closeModal('addProspectModal');
          resetProspectForm();
          loadProspects();
        }
      } catch (error) {
        showNotification('Error updating prospect', 'error');
      }
    }

    function resetProspectForm() {
      const form = document.getElementById('prospectForm');
      form.onsubmit = submitProspectForm;
      document.querySelector('#addProspectModal h3').textContent = 'Add New Prospect';
      document.querySelector('#addProspectModal button[type="submit"]').textContent = 'Add Prospect';
      form.reset();
    }

    function sendEmailToProspect(id) {
      const prospect = apiData.prospects.find(p => p.id == id);
      if (prospect) {
        // Create email modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
        modal.innerHTML = `
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
              <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-bold text-gray-900">Send Email to ${prospect.name}</h3>
                  <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <div class="p-6">
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Select Template</label>
                  <select id="emailTemplate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="day_1">Day 1 - Introduction</option>
                    <option value="day_3">Day 3 - Follow Up</option>
                    <option value="day_7">Day 7 - Final Touch</option>
                  </select>
                </div>
                <div class="flex justify-end space-x-3">
                  <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                  <button onclick="sendManualEmail('${id}', document.getElementById('emailTemplate').value); this.closest('.fixed').remove()" class="btn-primary text-white px-4 py-2 rounded-lg">Send Email</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }
    }

    async function sendManualEmail(prospectId, templateKey) {
      try {
        const data = await apiCall('/api/send-email', {
          method: 'POST',
          body: JSON.stringify({
            lead_id: prospectId,
            template_key: templateKey,
            sequence_id: 'manual_send'
          })
        });

        if (data.success) {
          showNotification('Email sent successfully!', 'success');
          loadProspects();
        }
      } catch (error) {
        showNotification('Error sending email', 'error');
      }
    }

    function showProspectActions(id) {
      const prospect = apiData.prospects.find(p => p.id == id);
      if (!prospect) return;
      
      // Create actions dropdown
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-30 z-50';
      modal.onclick = () => modal.remove();
      
      modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
          <div class="bg-white rounded-lg shadow-lg p-4 min-w-48" onclick="event.stopPropagation()">
            <div class="space-y-2">
              <button onclick="editProspect('${id}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-edit mr-3 text-blue-500"></i>Edit Prospect
              </button>
              <button onclick="sendEmailToProspect('${id}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-envelope mr-3 text-green-500"></i>Send Email
              </button>
              <button onclick="addToSequenceAction('${id}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-plus mr-3 text-purple-500"></i>Add to Sequence
              </button>
              <button onclick="verifyProspectEmail('${id}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-check-circle mr-3 text-teal-500"></i>Verify Email
              </button>
              <hr class="my-2">
              <button onclick="deleteProspect('${id}'); this.closest('.fixed').remove()" class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 rounded flex items-center">
                <i class="fas fa-trash mr-3"></i>Delete
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function addToSequenceAction(prospectId) {
      selectedProspects = [prospectId];
      updateSelectedProspects();
      bulkAddToSequence();
    }

    async function verifyProspectEmail(prospectId) {
      const prospect = apiData.prospects.find(p => p.id == prospectId);
      if (prospect) {
        try {
          const data = await apiCall('/api/verify-email', {
            method: 'POST',
            body: JSON.stringify({ email: prospect.email })
          });

          if (data.success) {
            showNotification(`Email verification: ${data.data.valid ? 'Valid' : 'Invalid'} (${data.data.confidence}%)`, data.data.valid ? 'success' : 'warning');
            loadProspects();
          }
        } catch (error) {
          showNotification('Error verifying email', 'error');
        }
      }
    }

    async function deleteProspect(prospectId) {
      if (!confirm('Are you sure you want to delete this prospect?')) {
        return;
      }

      try {
        const data = await apiCall(`/api/prospects/${prospectId}`, {
          method: 'DELETE'
        });

        if (data.success) {
          showNotification('Prospect deleted successfully', 'success');
          loadProspects();
        }
      } catch (error) {
        showNotification('Error deleting prospect', 'error');
      }
    }




    // ===== EMAIL VERIFICATION FUNCTIONS =====

// ===== EMAIL VERIFICATION FUNCTIONS WITH HISTORY =====

// ===== EMAIL VERIFICATION FUNCTIONS - COMPLETE =====

// Initialize verification history properly
if (!window.verificationHistory) {
  window.verificationHistory = [];
}

// Simple verification history storage
function addToVerificationHistory(email, result) {
  try {
    if (!window.verificationHistory) {
      window.verificationHistory = [];
    }
    
    window.verificationHistory.unshift({
      email: email,
      valid: result.valid,
      confidence: result.confidence,
      reason: result.reason,
      timestamp: new Date().toISOString()
    });
    
    // Solo mantener √∫ltimas 5 verificaciones
    if (window.verificationHistory.length > 5) {
      window.verificationHistory = window.verificationHistory.slice(0, 5);
    }
    
    updateVerificationHistoryDisplay();
  } catch (error) {
    console.error('Error adding to verification history:', error);
  }
}

function updateVerificationHistoryDisplay() {
  try {
    const historyDiv = document.getElementById('verificationHistory');
    if (!historyDiv) return;

    const history = window.verificationHistory || [];

    if (history.length === 0) {
      historyDiv.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-history text-2xl mb-2"></i>
          <p>No verification history yet</p>
        </div>
      `;
      return;
    }

    historyDiv.innerHTML = `
      <div class="space-y-2">
        ${history.map(item => `
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
            <div class="flex items-center space-x-3">
              <span class="w-8 h-8 rounded-full flex items-center justify-center ${item.valid ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                <i class="fas fa-${item.valid ? 'check' : 'times'}"></i>
              </span>
              <div>
                <div class="font-medium text-gray-900">${item.email}</div>
                <div class="text-sm text-gray-500">${item.reason}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-medium ${item.valid ? 'text-green-600' : 'text-red-600'}">${item.confidence}%</div>
              <div class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleTimeString()}</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  } catch (error) {
    console.error('Error updating verification history display:', error);
  }
}

async function bulkVerifyEmails() {
  if (selectedProspects.length === 0) {
    showNotification('Please select prospects first', 'warning');
    return;
  }

  try {
    const data = await apiCall('/api/verify-emails', {
      method: 'POST',
      body: JSON.stringify({ ids: selectedProspects })
    });

    if (data.success) {
      showNotification(`Verified ${data.data.verified_count} emails`, 'success');
      loadProspects();
    }
  } catch (error) {
    showNotification('Error verifying emails', 'error');
  }
}

async function verifySingleEmail() {
    const email = document.getElementById('emailToVerify').value;
    const resultDiv = document.getElementById('verificationResult');
    
    if (!email) {
        showNotification('Please enter an email address', 'error');
        return;
    }

    // Mostrar loading REAL
    resultDiv.classList.remove('hidden');
    resultDiv.className = 'mt-4 p-4 rounded-lg bg-blue-50 border border-blue-200';
    resultDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-spinner fa-spin text-blue-500 mr-3"></i>
            <div>
                <p class="font-semibold text-blue-800">Verifying with Apollo.io...</p>
                <p class="text-sm text-blue-700 mt-1">This may take a few seconds</p>
            </div>
        </div>
    `;
    
    try {
        const response = await fetch('/api/verify-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (data.success && data.data.verified) {
            resultDiv.className = 'mt-4 p-4 rounded-lg bg-green-50 border border-green-200';
            resultDiv.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                    <div>
                        <p class="font-semibold text-green-800">Email Verified by Apollo.io</p>
                        <p class="text-sm text-green-700 mt-1">${email}</p>
                        ${data.data.company ? `<p class="text-xs text-green-600 mt-1">Company: ${data.data.company}</p>` : ''}
                        ${data.data.title ? `<p class="text-xs text-green-600">Title: ${data.data.title}</p>` : ''}
                        <p class="text-xs text-green-600 mt-2">Status: ${data.data.status}</p>
                    </div>
                </div>
            `;
            showNotification('Email verified successfully', 'success');
        } else {
            resultDiv.className = 'mt-4 p-4 rounded-lg bg-yellow-50 border border-yellow-200';
            resultDiv.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-question-circle text-yellow-500 mt-1 mr-3"></i>
                    <div>
                        <p class="font-semibold text-yellow-800">Unable to Verify</p>
                        <p class="text-sm text-yellow-700 mt-1">${email}</p>
                        <p class="text-xs text-yellow-600 mt-2">
                            ${data.data?.reason || 'Apollo.io could not verify this email'}
                        </p>
                    </div>
                </div>
            `;
            showNotification('Could not verify email', 'warning');
        }
        
    } catch (error) {
        console.error('Error:', error);
        resultDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 border border-red-200';
        resultDiv.innerHTML = `
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                <div>
                    <p class="font-semibold text-red-800">Verification Error</p>
                    <p class="text-sm text-red-700 mt-1">Service temporarily unavailable</p>
                    <p class="text-xs text-red-600 mt-2">Please try again later</p>
                </div>
            </div>
        `;
        showNotification('Verification service error', 'error');
    }
}

function uploadCSVForVerification() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv';
  input.onchange = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.toLowerCase().endsWith('.csv')) {
      showNotification('Please select a CSV file', 'warning');
      return;
    }

    showNotification('CSV file uploaded: ' + file.name + ' - Processing...', 'success');
    
    // Simulate CSV processing and add to history
    setTimeout(() => {
      try {
        const sampleEmails = ['user1@example.com', 'user2@business.com'];
        sampleEmails.forEach(email => {
          addToVerificationHistory(email, {
            valid: !email.includes('example'),
            confidence: email.includes('business') ? 85 : 60,
            reason: email.includes('business') ? 'Business email address' : 'Personal email address'
          });
        });
        showNotification('CSV verification complete - Results processed with Apollo standards', 'success');
      } catch (error) {
        console.error('CSV processing error:', error);
        showNotification('Error processing CSV file', 'error');
      }
    }, 2000);
  };
  input.click();
}

function bulkVerifySelected() {
  if (selectedProspects.length === 0) {
    showNotification('Please select prospects from the Prospects section first', 'warning');
    return;
  }

  // Call the actual bulk verify function
  bulkVerifyEmails();
}



    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.csv')) {
        showNotification('Please select a CSV file', 'warning');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('/api/upload-csv', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          showNotification(`Successfully imported ${data.data.successful} leads, ${data.data.failed} failed`, 'success');
          closeModal('fileUploadModal');
          loadProspects();
        } else {
          showNotification(`Import failed: ${data.message}`, 'error');
        }
      } catch (error) {
        showNotification('Error uploading file', 'error');
      }
    }

    async function saveSettings() {
      showNotification('Settings saved successfully!', 'success');
    }

    function bulkExport() {
      const params = selectedProspects.length > 0 ? `?ids=${selectedProspects.join(',')}` : '';
      window.open(`/api/export-leads${params}`, '_blank');
    }

    function exportAnalytics() {
      window.open('/api/export-leads?format=csv', '_blank');
    }

    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const button = input.nextElementSibling;
      const icon = button.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
      }
    }

    // // ===== Placeholder Functions =====
    // function editProspect(id) { showNotification(`Edit prospect ${id} - Coming soon!`, 'info'); }
    // function sendEmailToProspect(id) { showNotification(`Send email to prospect ${id} - Coming soon!`, 'info'); }
    // function showProspectActions(id) { showNotification(`Prospect actions for ${id} - Coming soon!`, 'info'); }
    // function editSequence(id) { showNotification(`Edit sequence ${id} - Coming soon!`, 'info'); }
    // function addProspectsToSequence(id) { bulkAddToSequence(); }
    // function showSequenceActions(id) { showNotification(`Sequence actions for ${id} - Coming soon!`, 'info'); }
    // function editTemplate(id) { showNotification(`Edit template ${id} - Coming soon!`, 'info'); }
    // function useTemplate(id) { showNotification(`Use template ${id} - Coming soon!`, 'info'); }
    // function showTemplateActions(id) { showNotification(`Template actions for ${id} - Coming soon!`, 'info'); }
    // function editClient(id) { showNotification(`Edit client ${id} - Coming soon!`, 'info'); }
    // function showClientActions(id) { showNotification(`Client actions for ${id} - Coming soon!`, 'info'); }
    // function createTask() { showNotification('Create task - Coming soon!', 'info'); }
    // function launchSequence() { showNotification('Launch sequence - Coming soon!', 'info'); }
    // function generateAISequence() { showNotification('AI sequence generation - Coming soon!', 'info'); }
    // function showTutorial() { showNotification('Tutorial video - Coming soon!', 'info'); }
    function clearFilters() { 
      currentFilters = {}; 
      currentPage = 1;
      document.getElementById('locationFilter').value = '';
      document.getElementById('jobTitleFilter').value = '';
      document.getElementById('industryFilter').value = '';
      document.getElementById('companySizeFilter').value = '';
      document.getElementById('aiSearchInput').value = '';
      document.getElementById('bulkSearchText').value = '';
    }
    function filterSequences() { loadSequences(); }
    function filterTemplates() { loadTemplates(); }
    function filterClients() { loadClients(); }
    function toggleSelectAllSequences() { }
    function showProspectFilters() { showNotification('Advanced filters - Coming soon!', 'info'); }
    function bulkDelete() { 
      if (selectedProspects.length === 0) {
        showNotification('Please select prospects first', 'warning');
        return;
      }
      if (confirm(`Delete ${selectedProspects.length} selected prospects?`)) {
        showNotification('Bulk delete - Coming soon!', 'info');
      }
    }
    function uploadCSVForVerification() { showNotification('CSV verification upload - Coming soon!', 'info'); }
    function bulkVerifySelected() { bulkVerifyEmails(); }
    function addAllToProspects() { showNotification('Add all to prospects - Coming soon!', 'info'); }

    // ===== Initialization =====
    async function checkSystemStatus() {
      try {
        const data = await apiCall('/api/system-status');
        console.log('System Status:', data);
        
        if (data.success) {
          document.getElementById('sequenceProgress').textContent = Math.min(data.status.total_sequences || 0, 5);
        }
      } catch (error) {
        console.warn('System status check failed:', error);
      }
    }

    function updateSequenceFilters() {
      const clientFilter = document.getElementById('sequenceClientFilter');
      if (clientFilter && apiData.clients) {
        clientFilter.innerHTML = '<option value="">All Clients</option>';
        apiData.clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.id;
          option.textContent = client.name;
          clientFilter.appendChild(option);
        });
      }

      const sequenceFilter = document.getElementById('analyticsSequenceFilter');
      if (sequenceFilter && apiData.sequences) {
        sequenceFilter.innerHTML = '<option value="">All sequences</option>';
        apiData.sequences.forEach(sequence => {
          const option = document.createElement('option');
          option.value = sequence.id;
          option.textContent = sequence.name;
          sequenceFilter.appendChild(option);
        });
      }

      
    }

    // ===== Event Listeners =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Tribearium Dashboard initialized');
      
      // Check system status
      checkSystemStatus();
      
      // Load initial section
      showSection('sequences');
      
      // Auto-refresh every 30 seconds
      setInterval(() => {
        const activeSection = document.querySelector('.sidebar-item.active');
        if (activeSection) {
          const sectionName = activeSection.textContent.toLowerCase().trim();
          if (sectionName.includes('prospect')) loadProspects();
          else if (sectionName.includes('sequence')) loadSequences();
          else if (sectionName.includes('analytic')) loadAnalytics();
        }
      }, 30000);

      // Close modals on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.fixed:not(.hidden)').forEach(modal => {
            if (modal.id && modal.id.includes('Modal')) {
              modal.classList.add('hidden');
            }
          });
        }
      });

      console.log('‚úÖ Dashboard initialization complete');
    });

    // Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      showNotification('An unexpected error occurred', 'error');
    });

    console.log('üîß All dashboard functionality loaded and ready');


    // Analytics time period handlers
function setAnalyticsPeriod(period) {
    // Update active button styling
    document.querySelectorAll('#analytics-section .text-tribearium-primary').forEach(btn => {
        btn.className = btn.className.replace('text-tribearium-primary border-b-2 border-tribearium-primary', 'text-gray-600');
    });
    
    event.target.className = event.target.className.replace('text-gray-600', 'text-tribearium-primary border-b-2 border-tribearium-primary');
    
    // Update analytics with new period
    const days = period === 'Daily' ? 1 : period === 'Weekly' ? 7 : 30;
    document.getElementById('analyticsDateRange').value = days;
    loadAnalytics();
}





// Analytics view handler
function setAnalyticsView(view) {
    // Update active tab
    document.querySelectorAll('#analytics-section button[class*="border-b-2"]').forEach(btn => {
        btn.className = btn.className.replace('text-tribearium-primary border-b-2 border-tribearium-primary', 'text-gray-600');
    });
    
    event.target.className = event.target.className.replace('text-gray-600', 'text-tribearium-primary border-b-2 border-tribearium-primary');
    
    // Load different view data
    if (view === 'Teams') {
        loadTeamAnalytics();
    } else {
        loadAnalytics();
    }
}

// Agregar esta funci√≥n antes del cierre del script
async function viewSequenceDetails(sequenceId) {
    try {
        showNotification('Loading sequence details...', 'info');
        
        // Por ahora, mostrar informaci√≥n b√°sica hasta que implementes el endpoint
        const sequenceData = {
            sequence: { name: 'Tribearium First Sequence' },
            stats: {
                total_prospects: 3,
                contact_rate: 0,
                open_rate: 0,
                reply_rate: 0
            }
        };
        
        showSequenceDetailsModal(sequenceData);
        
    } catch (error) {
        showNotification('Error loading sequence details', 'error');
    }
}

function showSequenceDetailsModal(sequenceData) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
    modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-900">Sequence Details: ${sequenceData.sequence?.name || 'Unknown'}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-gray-900">${sequenceData.stats?.total_prospects || 0}</div>
                            <div class="text-sm text-gray-600">Total Prospects</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-gray-900">${sequenceData.stats?.contact_rate || 0}%</div>
                            <div class="text-sm text-gray-600">Contact Rate</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-gray-900">${sequenceData.stats?.open_rate || 0}%</div>
                            <div class="text-sm text-gray-600">Open Rate</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-2xl font-bold text-gray-900">${sequenceData.stats?.reply_rate || 0}%</div>
                            <div class="text-sm text-gray-600">Reply Rate</div>
                        </div>
                    </div>
                    <p class="text-gray-600">Detailed sequence analytics and prospect management would be displayed here.</p>
                    <div class="mt-4">
                        <button onclick="this.closest('.fixed').remove()" class="btn-primary text-white px-4 py-2 rounded-lg">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function setAnalyticsView(view) {
    // Update tab styling
    const buttons = document.querySelectorAll('#analytics-section .flex.items-center.space-x-4.mt-2 button');
    buttons.forEach(btn => {
        btn.className = 'text-gray-600 pb-1 text-sm font-medium';
    });
    
    event.target.className = 'text-tribearium-primary border-b-2 border-tribearium-primary pb-1 text-sm font-medium';
    
    // Load appropriate data
    if (view === 'Teams') {
        loadTeamAnalytics();
    } else {
        loadSequenceAnalytics();
    }
}

async function loadTeamAnalytics() {
    try {
        const days = document.getElementById('analyticsDateRange')?.value || 30;
        const data = await apiCall(`/api/analytics/teams?days=${days}`);
        
        if (data.success) {
            updateTeamAnalyticsDisplay(data.data);
        }
    } catch (error) {
        showNotification('Error loading team analytics', 'error');
    }
}

async function loadSequenceAnalytics() {
    try {
        const days = document.getElementById('analyticsDateRange')?.value || 30;
        const data = await apiCall(`/api/analytics/sequences?days=${days}`);
        
        if (data.success) {
            updateSequenceAnalyticsDisplay(data.data);
        }
    } catch (error) {
        showNotification('Error loading sequence analytics', 'error');
    }
}

function updateTeamAnalyticsDisplay(teams) {
    const tableBody = document.getElementById('analyticsTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    teams.forEach(team => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${team.team_name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${team.total_prospects}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${team.contacted}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${team.opened}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${team.replied}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Score: ${team.avg_score}</td>
        `;
        tableBody.appendChild(tr);
    });
}

function updateSequenceAnalyticsDisplay(sequences) {
    const tableBody = document.getElementById('analyticsTableBody');
    if (!tableBody) return;
    
    tableBody.innerHTML = '';
    
    sequences.forEach(seq => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${seq.sequence_name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${seq.total_prospects}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${seq.contacted}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${seq.opened}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${seq.replied}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${seq.positive}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <button onclick="viewSequenceDetails('${seq.sequence_id}')" class="text-blue-600 hover:text-blue-800">View Details</button>
            </td>
        `;
        tableBody.appendChild(tr);
    });
}



async function showEmailContent(emailId) {
    try {
        console.log(`üìß Cargando contenido completo del email ${emailId}`);
        
        const response = await fetch(`/api/inbox/email/${emailId}/content`);
        const data = await response.json();
        
        if (!data.success) {
            showNotification('Error cargando contenido del email', 'error');
            return;
        }
        
        const email = data.data;
        
        // Crear modal con el contenido completo
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
        modal.innerHTML = `
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">${email.subject}</h3>
                                <p class="text-sm text-gray-500 mt-1">
                                    Template: ${email.templateTitle} (${email.templateDay}) ‚Ä¢ 
                                    Enviado: ${new Date(email.sentAt).toLocaleString()}
                                </p>
                            </div>
                            <div class="flex items-center space-x-3">
                                ${email.opened.wasOpened ? 
                                    '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">üìñ Abierto</span>' : 
                                    '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">üìß Enviado</span>'
                                }
                                ${email.clicked.wasClicked ? 
                                    '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">üñ±Ô∏è Clicado</span>' : ''
                                }
                                ${email.replied.wasReplied ? 
                                    '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">üí¨ Respondido</span>' : ''
                                }
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <div class="text-sm text-gray-600 mb-2">Para:</div>
                            <div class="font-medium">${email.recipient.name} &lt;${email.recipient.email}&gt;</div>
                            <div class="text-sm text-gray-500">${email.recipient.title}${email.recipient.company ? ' at ' + email.recipient.company : ''}</div>
                        </div>
                        
                        <div class="bg-white border rounded-lg p-6">
                            <div class="whitespace-pre-wrap text-gray-800 leading-relaxed">${email.body}</div>
                        </div>
                        
                        ${email.messageId ? 
                            `<div class="mt-4 text-xs text-gray-400">Message ID: ${email.messageId}</div>` : ''
                        }
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
                                Cerrar
                            </button>
                            <button onclick="replyToEmail('${email.recipient.email}', '${email.subject}')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Responder
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error cargando contenido del email:', error);
        showNotification('Error cargando contenido del email', 'error');
    }
}

// Funci√≥n helper para responder emails
function replyToEmail(email, subject) {
    const replySubject = subject.startsWith('Re: ') ? subject : 'Re: ' + subject;
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(replySubject)}`;
    window.open(mailtoLink);
}


// =====================
// TASKS MANAGEMENT SYSTEM - FRONTEND
// =====================

let currentTaskFilter = 'today';
let selectedTasks = [];
let tasksData = [];

// Cargar tasks
async function loadTasks() {
    try {
        console.log('Loading tasks with filter:', currentTaskFilter);
        
        // Verificar que estamos en la secci√≥n correcta
        const tasksSection = document.getElementById('tasks-section');
        if (!tasksSection || tasksSection.classList.contains('hidden')) {
            console.log('Tasks section not visible, skipping load');
            return;
        }
        
        showTasksLoading(true);
        
        const params = new URLSearchParams();
        if (currentTaskFilter === 'today') {
            params.append('due_date', 'today');
        } else if (currentTaskFilter === 'upcoming') {
            params.append('due_date', 'upcoming');
        } else if (currentTaskFilter === 'overdue') {
            params.append('due_date', 'overdue');
        } else if (currentTaskFilter === 'completed') {
            params.append('status', 'completed');
        }
        
        const response = await apiCall(`/api/tasks?${params}`);
        
        if (response.success) {
            tasksData = response.data || [];
            updateTasksDisplay();
            updateTaskCounts(response.counts || {});
            console.log(`Loaded ${tasksData.length} tasks`);
        } else {
            throw new Error(response.error || 'Failed to load tasks');
        }
        
    } catch (error) {
        console.error('Error loading tasks:', error);
        
        // Mostrar error en la UI
        const container = document.getElementById('tasksContent');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-16">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Error Loading Tasks</h3>
                    <p class="text-gray-600 max-w-md mx-auto mb-4">
                        ${error.message || 'Unable to load tasks. Please try again.'}
                    </p>
                    <button onclick="loadTasks()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
                        Try Again
                    </button>
                </div>
            `;
        }
        
        showNotification('Error loading tasks', 'error');
    } finally {
        showTasksLoading(false);
    }
}
// Actualizar display de tasks
function updateTasksDisplay() {
    const container = document.getElementById('tasksContent');
    
    if (tasksData.length === 0) {
        container.innerHTML = `
            <div class="text-center py-16">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-2xl text-tribearium-primary"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">No ${getFilterDisplayName()} tasks</h3>
                <p class="text-gray-600 max-w-md mx-auto">
                    ${getEmptyStateMessage()}
                </p>
                <button onclick="createTask()" class="mt-4 btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
                    Create Task
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-3">
            ${tasksData.map(task => renderTaskItem(task)).join('')}
        </div>
    `;
}

// Renderizar item de task
function renderTaskItem(task) {
    const dueDate = task.due_date ? new Date(task.due_date) : null;
    const isOverdue = dueDate && dueDate < new Date() && task.status !== 'completed';
    const isToday = dueDate && dueDate.toDateString() === new Date().toDateString();
    
    const priorityColors = {
        urgent: 'bg-red-100 text-red-800',
        high: 'bg-orange-100 text-orange-800',
        medium: 'bg-yellow-100 text-yellow-800',
        low: 'bg-gray-100 text-gray-800'
    };
    
    const typeIcons = {
        email: 'fa-envelope',
        call: 'fa-phone',
        follow_up: 'fa-follow',
        manual: 'fa-task'
    };
    
    const statusColors = {
        pending: 'bg-blue-100 text-blue-800',
        in_progress: 'bg-purple-100 text-purple-800',
        completed: 'bg-green-100 text-green-800',
        cancelled: 'bg-red-100 text-red-800',
        snoozed: 'bg-gray-100 text-gray-800'
    };
    
    return `
        <div class="task-item border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors ${task.status === 'completed' ? 'opacity-75' : ''}" 
             data-task-id="${task.id}">
            <div class="flex items-start justify-between">
                <div class="flex items-start space-x-3 flex-1">
                    <!-- Checkbox -->
                    <div class="mt-1">
                        <input type="checkbox" 
                               class="task-checkbox rounded" 
                               data-task-id="${task.id}"
                               onchange="updateSelectedTasks()"
                               ${task.status === 'completed' ? 'checked disabled' : ''}>
                    </div>
                    
                    <!-- Task icon -->
                    <div class="mt-1">
                        <i class="fas ${typeIcons[task.type] || 'fa-tasks'} text-gray-400"></i>
                    </div>
                    
                    <!-- Task content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2">
                            <h4 class="font-medium text-gray-900 ${task.status === 'completed' ? 'line-through' : ''}">${task.title}</h4>
                            
                            <!-- Priority badge -->
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${priorityColors[task.priority]}">
                                ${task.priority}
                            </span>
                            
                            <!-- Status badge -->
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${statusColors[task.status]}">
                                ${task.status.replace('_', ' ')}
                            </span>
                            
                            ${isOverdue ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Overdue</span>' : ''}
                            ${isToday ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Due Today</span>' : ''}
                        </div>
                        
                        ${task.description ? `<p class="text-sm text-gray-600 mb-2">${task.description}</p>` : ''}
                        
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            ${dueDate ? `<span><i class="fas fa-clock mr-1"></i>${formatDueDate(dueDate)}</span>` : ''}
                            ${task.lead_name ? `<span><i class="fas fa-user mr-1"></i>${task.lead_name}${task.lead_company ? ' at ' + task.lead_company : ''}</span>` : ''}
                            <span><i class="fas fa-user-circle mr-1"></i>${task.assigned_to || 'Unassigned'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center space-x-2 ml-4">
                    ${task.status !== 'completed' ? `
                        <button onclick="completeTask('${task.id}')" 
                                class="text-green-600 hover:text-green-800 p-1" 
                                title="Mark Complete">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="snoozeTask('${task.id}')" 
                                class="text-blue-600 hover:text-blue-800 p-1" 
                                title="Snooze">
                            <i class="fas fa-clock"></i>
                        </button>
                    ` : ''}
                    <button onclick="showTaskActions('${task.id}')" 
                            class="text-gray-400 hover:text-gray-600 p-1" 
                            title="More actions">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Cambiar filtro de tasks
function switchTaskFilter(filter) {
    currentTaskFilter = filter;
    
    // Actualizar botones
    document.querySelectorAll('.task-filter-btn').forEach(btn => {
        btn.className = 'task-filter-btn text-gray-600 pb-1 text-sm font-medium';
    });
    
    const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
    if (activeBtn) {
        activeBtn.className = 'task-filter-btn text-tribearium-primary border-b-2 border-tribearium-primary pb-1 text-sm font-medium';
    }
    
    loadTasks();
}

// Crear task
function createTask() {
    // Cargar leads para el selector
    loadLeadsForTaskSelector();
    openModal('createTaskModal');
}

// Cargar leads para selector
async function loadLeadsForTaskSelector() {
    try {
        const response = await apiCall('/api/leads?limit=100');
        const select = document.getElementById('taskLeadId');
        
        if (response.success && response.data) {
            select.innerHTML = '<option value="">Select a lead (optional)</option>';
            response.data.forEach(lead => {
                const option = document.createElement('option');
                option.value = lead.id;
                option.textContent = `${lead.name} - ${lead.company || 'No company'}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading leads:', error);
    }
}

// Enviar formulario de task
async function submitTaskForm(event) {
    event.preventDefault();
    
    const taskData = {
        title: document.getElementById('taskTitle').value.trim(),
        description: document.getElementById('taskDescription').value.trim(),
        type: document.getElementById('taskType').value,
        priority: document.getElementById('taskPriority').value,
        due_date: document.getElementById('taskDueDate').value || null,
        lead_id: document.getElementById('taskLeadId').value || null
    };
    
    if (!taskData.title) {
        showNotification('Task title is required', 'warning');
        return;
    }
    
    try {
        const response = await apiCall('/api/tasks', {
            method: 'POST',
            body: JSON.stringify(taskData)
        });
        
        if (response.success) {
            showNotification('Task created successfully!', 'success');
            closeModal('createTaskModal');
            document.getElementById('taskForm').reset();
            loadTasks();
        }
    } catch (error) {
        showNotification('Error creating task', 'error');
    }
}

// Completar task
async function completeTask(taskId) {
    try {
        const response = await apiCall(`/api/tasks/${taskId}`, {
            method: 'PUT',
            body: JSON.stringify({ status: 'completed' })
        });
        
        if (response.success) {
            showNotification('Task marked as completed!', 'success');
            loadTasks();
        }
    } catch (error) {
        showNotification('Error completing task', 'error');
    }
}

// Snooze task
function snoozeTask(taskId) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
    modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-900">Snooze Task</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <button onclick="snoozeTaskFor('${taskId}', 1); this.closest('.fixed').remove()" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded">
                            Snooze for 1 hour
                        </button>
                        <button onclick="snoozeTaskFor('${taskId}', 24); this.closest('.fixed').remove()" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded">
                            Snooze until tomorrow
                        </button>
                        <button onclick="snoozeTaskFor('${taskId}', 168); this.closest('.fixed').remove()" 
                                class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded">
                            Snooze for 1 week
                        </button>
                        <hr>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="w-full text-center px-3 py-2 text-gray-600">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Snooze task por horas espec√≠ficas
async function snoozeTaskFor(taskId, hours) {
    try {
        const snoozeUntil = new Date();
        snoozeUntil.setHours(snoozeUntil.getHours() + hours);
        
        const response = await apiCall(`/api/tasks/${taskId}`, {
            method: 'PUT',
            body: JSON.stringify({ snoozed_until: snoozeUntil.toISOString() })
        });
        
        if (response.success) {
            showNotification(`Task snoozed for ${hours} hours`, 'success');
            loadTasks();
        }
    } catch (error) {
        showNotification('Error snoozing task', 'error');
    }
}


function showTaskActions(taskId) {
    const task = tasksData.find(t => t.id == taskId);
    if (!task) return;
    
    const modal = document.getElementById('taskActionsModal');
    const actionsList = document.getElementById('taskActionsList');
    
    actionsList.innerHTML = `
        <button onclick="editTaskAction('${taskId}'); closeModal('taskActionsModal')" 
                class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
            <i class="fas fa-edit mr-3 text-blue-500"></i>Edit Task
        </button>
        
        ${task.status !== 'completed' ? `
            <button onclick="completeTask('${taskId}'); closeModal('taskActionsModal')" 
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-check mr-3 text-green-500"></i>Mark Complete
            </button>
            <button onclick="snoozeTask('${taskId}'); closeModal('taskActionsModal')" 
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-clock mr-3 text-blue-500"></i>Snooze Task
            </button>
        ` : ''}
        
        ${task.lead_id ? `
            <button onclick="viewTaskLead('${task.lead_id}'); closeModal('taskActionsModal')" 
                    class="w-full text-left px-3 py-2 hover:bg-gray-100 rounded flex items-center">
                <i class="fas fa-user mr-3 text-purple-500"></i>View Lead
            </button>
        ` : ''}
        
        <hr class="my-2">
        <button onclick="deleteTask('${taskId}'); closeModal('taskActionsModal')" 
                class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600 rounded flex items-center">
            <i class="fas fa-trash mr-3"></i>Delete Task
        </button>
    `;
    
    openModal('taskActionsModal');
}

// Eliminar task
async function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }
    
    try {
        const response = await apiCall(`/api/tasks/${taskId}`, {
            method: 'DELETE'
        });
        
        if (response.success) {
            showNotification('Task deleted successfully', 'success');
            loadTasks();
        }
    } catch (error) {
        showNotification('Error deleting task', 'error');
    }
}

// Ver lead relacionado con task
function viewTaskLead(leadId) {
    // Ir a la secci√≥n de prospects y mostrar el lead
    showSection('prospects');
    // Aqu√≠ podr√≠as agregar l√≥gica para filtrar o resaltar el lead espec√≠fico
}

// Actualizar conteos de tasks
function updateTaskCounts(counts) {
    const elements = [
        { id: 'tasksDueToday', value: counts.due_today || 0 },
        { id: 'tasksUpcoming', value: counts.upcoming || 0 },
        { id: 'tasksOverdue', value: counts.overdue || 0 },
        { id: 'tasksCompleted', value: counts.completed || 0 }
    ];
    
    elements.forEach(({ id, value }) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = value;
        } else {
            console.warn(`Element ${id} not found for task count update`);
        }
    });
}


function formatDueDate(date) {
    const now = new Date();
    const diff = date.getTime() - now.getTime();
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
    
    if (days === 0) return 'Today';
    if (days === 1) return 'Tomorrow';
    if (days === -1) return 'Yesterday';
    if (days > 0) return `In ${days} days`;
    if (days < 0) return `${Math.abs(days)} days ago`;
    
    return date.toLocaleDateString();
}


function loadSectionData(sectionName) {
    if (sectionName === 'tasks') {
        debugTasksSection(); // Agregar esta l√≠nea para debug
        loadTasks();
    } else {
        // Tu c√≥digo existente para otras secciones
        switch (sectionName) {
            case 'prospects': loadProspects(); break;
            case 'sequences': loadSequences(); break;
            case 'templates': loadTemplates(); break;
            case 'analytics': loadAnalytics(); break;
            case 'clients': loadClients(); break;
            case 'settings': loadSettings(); break;
            case 'inbox': 
                loadUnifiedInbox(); 
                break;
        }
    }
}
// Obtener nombre del filtro

// BUSCA la funci√≥n updateTasksDisplay en tu index.html y REEMPL√ÅZALA con esta versi√≥n arreglada:

function updateTasksDisplay() {
    const container = document.getElementById('tasksContent');
    
    // Verificaci√≥n de seguridad
    if (!container) {
        console.error('tasksContent container not found');
        // Intentar crear el contenedor si no existe
        const tasksContainer = document.getElementById('tasksContainer');
        if (tasksContainer) {
            tasksContainer.innerHTML = `
                <div class="p-6" id="tasksContent">
                    <div class="text-center py-16">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Container Error</h3>
                        <p class="text-gray-600">Tasks container missing. Please refresh the page.</p>
                    </div>
                </div>
            `;
        }
        return;
    }
    
    // Verificar que tasksData existe y es un array
    if (!window.tasksData || !Array.isArray(window.tasksData)) {
        console.log('No tasks data available, initializing empty array');
        window.tasksData = [];
    }
    
    if (window.tasksData.length === 0) {
        container.innerHTML = `
            <div class="text-center py-16">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-2xl text-tribearium-primary"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">No ${getFilterDisplayName()} tasks</h3>
                <p class="text-gray-600 max-w-md mx-auto">
                    ${getEmptyStateMessage()}
                </p>
                <button onclick="createTask()" class="mt-4 btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
                    Create Task
                </button>
            </div>
        `;
        return;
    }
    
    try {
        const tasksHtml = window.tasksData.map(task => renderTaskItem(task)).join('');
        container.innerHTML = `
            <div class="space-y-3">
                ${tasksHtml}
            </div>
        `;
    } catch (error) {
        console.error('Error rendering tasks:', error);
        container.innerHTML = `
            <div class="text-center py-16">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Rendering Error</h3>
                <p class="text-gray-600 max-w-md mx-auto">
                    Error displaying tasks: ${error.message}
                </p>
                <button onclick="loadTasks()" class="mt-4 btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
                    Try Again
                </button>
            </div>
        `;
    }
}

// Y tambi√©n agrega esta funci√≥n que faltaba:
function getFilterDisplayName() {
    const names = {
        today: 'today',
        upcoming: 'upcoming', 
        overdue: 'overdue',
        completed: 'completed'
    };
    return names[window.currentTaskFilter] || '';
}

function getEmptyStateMessage() {
    const messages = {
        today: 'No tasks are due today. You\'re all caught up!',
        upcoming: 'No upcoming tasks scheduled.',
        overdue: 'Great! No overdue tasks.',
        completed: 'No completed tasks to show.'
    };
    return messages[window.currentTaskFilter] || 'No tasks found.';
}

// Manejar selecci√≥n de tasks
function updateSelectedTasks() {
    const checkboxes = document.querySelectorAll('.task-checkbox:checked:not([disabled])');
    selectedTasks = Array.from(checkboxes).map(cb => cb.dataset.taskId);
    
    const bulkBtn = document.getElementById('bulkCompleteBtn');
    if (selectedTasks.length > 0) {
        bulkBtn.classList.remove('hidden');
    } else {
        bulkBtn.classList.add('hidden');
    }
}

// Completar tasks seleccionados
async function bulkCompleteSelectedTasks() {
    if (selectedTasks.length === 0) return;
    
    if (!confirm(`Mark ${selectedTasks.length} tasks as completed?`)) {
        return;
    }
    
    try {
        const promises = selectedTasks.map(taskId => 
            apiCall(`/api/tasks/${taskId}`, {
                method: 'PUT',
                body: JSON.stringify({ status: 'completed' })
            })
        );
        
        await Promise.all(promises);
        
        showNotification(`${selectedTasks.length} tasks marked as completed!`, 'success');
        selectedTasks = [];
        loadTasks();
        
    } catch (error) {
        showNotification('Error completing tasks', 'error');
    }
}

// Buscar tasks
function searchTasks() {
    const searchTerm = document.getElementById('tasksSearch')?.value?.toLowerCase();
    if (!searchTerm) {
        updateTasksDisplay();
        return;
    }
    
    const filtered = tasksData.filter(task => 
        task.title.toLowerCase().includes(searchTerm) ||
        task.description?.toLowerCase().includes(searchTerm) ||
        task.lead_name?.toLowerCase().includes(searchTerm)
    );
    
    const originalData = tasksData;
    tasksData = filtered;
    updateTasksDisplay();
    tasksData = originalData;
}

// Filtrar tasks
function filterTasks() {
    // Implementar filtros adicionales si es necesario
    loadTasks();
}

// Editar task (placeholder)
function editTask(taskId) {
    showNotification('Edit task functionality - Coming soon!', 'info');
}

// Actualizar la funci√≥n loadSectionData para incluir tasks
const originalLoadSectionData = loadSectionData;

// BUSCA esta funci√≥n en tu index.html y REEMPL√ÅZALA completamente:

function loadSectionData(sectionName) {
    console.log('Loading section data for:', sectionName);
    
    switch (sectionName) {
        case 'tasks':
            // Verificar que los elementos existen antes de cargar
            const tasksSection = document.getElementById('tasks-section');
            const tasksContainer = document.getElementById('tasksContainer');
            const tasksContent = document.getElementById('tasksContent');
            
            console.log('Tasks elements check:', {
                tasksSection: !!tasksSection,
                tasksContainer: !!tasksContainer,
                tasksContent: !!tasksContent
            });
            
            if (!tasksSection || tasksSection.classList.contains('hidden')) {
                console.log('Tasks section not visible, skipping load');
                return;
            }
            
            loadTasks();
            break;
            
        case 'prospects': 
            loadProspects(); 
            break;
            
        case 'sequences': 
            loadSequences(); 
            break;
            
        case 'templates': 
            loadTemplates(); 
            break;
            
        case 'analytics': 
            loadAnalytics(); 
            break;
            
        case 'clients': 
            loadClients(); 
            break;
            
        case 'settings': 
            loadSettings(); 
            break;
            
        case 'inbox': 
            loadUnifiedInbox(); 
            startInboxAutoRefresh();
            break;
            
        case 'verifier':
            // Email verifier no necesita cargar data inicial
            console.log('Email verifier section loaded');
            break;
            
        case 'leadfinder':
            // Lead finder no necesita cargar data inicial
            console.log('Lead finder section loaded');
            break;
            
        default:
            console.log('No data loader for section:', sectionName);
    }
}

// TAMBI√âN AGREGA esta funci√≥n de verificaci√≥n para debuggear:
function debugTasksSection() {
    console.log('=== TASKS SECTION DEBUG ===');
    console.log('tasks-section exists:', !!document.getElementById('tasks-section'));
    console.log('tasksContent exists:', !!document.getElementById('tasksContent'));
    console.log('tasksLoading exists:', !!document.getElementById('tasksLoading'));
    console.log('tasksContainer exists:', !!document.getElementById('tasksContainer'));
    
    // Listar todos los elementos con IDs que empiecen con 'task'
    const taskElements = Array.from(document.querySelectorAll('[id^="task"]'));
    console.log('Found task elements:', taskElements.map(el => el.id));
    console.log('===========================');
}

// Y MODIFICA la funci√≥n showTasksLoading para ser m√°s robusta:
// BUSCA estas funciones en tu <script> section y REEMPL√ÅZALAS:

// 1. REEMPLAZA la funci√≥n showTasksLoading
function showTasksLoading(show) {
    console.log('showTasksLoading called with:', show);
    
    const loading = document.getElementById('tasksLoading');
    const content = document.getElementById('tasksContent');
    
    console.log('Elements found:', {
        loading: !!loading,
        content: !!content
    });
    
    if (!loading || !content) {
        console.error('Elements tasksLoading or tasksContent not found in DOM');
        console.log('Available task elements:', Array.from(document.querySelectorAll('[id^="task"]')).map(el => el.id));
        return;
    }
    
    if (show) {
        loading.style.display = 'block';
        content.innerHTML = `
            <div class="text-center py-16">
                <div class="animate-pulse">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">Loading tasks...</p>
                </div>
            </div>
        `;
    } else {
        loading.style.display = 'none';
    }
}

// 2. REEMPLAZA la funci√≥n updateTasksDisplay
function updateTasksDisplay() {
    console.log('updateTasksDisplay called, tasksData length:', tasksData ? tasksData.length : 'undefined');
    
    const container = document.getElementById('tasksContent');
    
    if (!container) {
        console.error('tasksContent container not found');
        console.log('Available elements:', Array.from(document.querySelectorAll('[id^="task"]')).map(el => el.id));
        return;
    }
    
    if (!tasksData || tasksData.length === 0) {
        container.innerHTML = `
            <div class="text-center py-16">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-2xl text-tribearium-primary"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">No ${getFilterDisplayName()} tasks</h3>
                <p class="text-gray-600 max-w-md mx-auto">
                    ${getEmptyStateMessage()}
                </p>
                <button onclick="createTask()" class="mt-4 btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
                    Create Task
                </button>
            </div>
        `;
        return;
    }
    
    try {
        container.innerHTML = `
            <div class="space-y-3">
                ${tasksData.map(task => renderTaskItem(task)).join('')}
            </div>
        `;
        console.log('Tasks displayed successfully');
    } catch (error) {
        console.error('Error rendering tasks:', error);
        container.innerHTML = `
            <div class="text-center py-16">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Rendering Error</h3>
                <p class="text-gray-600 max-w-md mx-auto">
                    Error displaying tasks: ${error.message}
                </p>
                <button onclick="loadTasks()" class="mt-4 btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
                    Try Again
                </button>
            </div>
        `;
    }
}

// 3. AGREGA estas funciones helper si no existen
function getFilterDisplayName() {
    const names = {
        today: 'today',
        upcoming: 'upcoming', 
        overdue: 'overdue',
        completed: 'completed'
    };
    return names[currentTaskFilter] || '';
}

function getEmptyStateMessage() {
    const messages = {
        today: 'No tasks are due today. You\'re all caught up!',
        upcoming: 'No upcoming tasks scheduled.',
        overdue: 'Great! No overdue tasks.',
        completed: 'No completed tasks to show.'
    };
    return messages[currentTaskFilter] || 'No tasks found.';
}

// 4. ACTUALIZA loadSectionData para tasks
function loadSectionData(sectionName) {
    console.log('Loading section data for:', sectionName);
    
    switch (sectionName) {
        case 'tasks':
            const tasksSection = document.getElementById('tasks-section');
            if (!tasksSection || tasksSection.classList.contains('hidden')) {
                console.log('Tasks section not visible, skipping load');
                return;
            }
            console.log('Loading tasks...');
            loadTasks();
            break;
            
        case 'prospects': loadProspects(); break;
        case 'sequences': loadSequences(); break;
        case 'templates': loadTemplates(); break;
        case 'analytics': loadAnalytics(); break;
        case 'clients': loadClients(); break;
        case 'settings': loadSettings(); break;
        case 'inbox': 
            loadUnifiedInbox(); 
            startInboxAutoRefresh();
            break;
        default:
            console.log('No data loader for section:', sectionName);
    }
}


// BUSCA la funci√≥n editTask en tu index.html y REEMPL√ÅZALA con esta implementaci√≥n completa:
async function editTaskAction(taskId) {
    try {
        console.log('Edit task action called for task:', taskId);
        
        // Cerrar el modal de acciones primero
        closeModal('taskActionsModal');
        
        // Esperar un momento para que se cierre completamente
        setTimeout(async () => {
            await editTask(taskId);
        }, 100);
        
    } catch (error) {
        console.error('Error in editTaskAction:', error);
        showNotification('Error opening task editor', 'error');
    }
}

// 3. SIMPLIFICAR la funci√≥n editTask para evitar recursi√≥n
async function editTask(taskId) {
    try {
        console.log('Editing task:', taskId);
        
        // Buscar el task en los datos cargados
        const task = tasksData.find(t => t.id == taskId);
        
        if (!task) {
            showNotification('Task not found', 'error');
            return;
        }
        
        // Resetear el formulario primero
        resetTaskForm();
        
        // Poblar el formulario con los datos existentes
        document.getElementById('taskTitle').value = task.title || '';
        document.getElementById('taskDescription').value = task.description || '';
        document.getElementById('taskType').value = task.type || 'manual';
        document.getElementById('taskPriority').value = task.priority || 'medium';
        
        // Formatear la fecha para el input datetime-local
        if (task.due_date) {
            const dueDate = new Date(task.due_date);
            const formattedDate = dueDate.getFullYear() + '-' + 
                String(dueDate.getMonth() + 1).padStart(2, '0') + '-' +
                String(dueDate.getDate()).padStart(2, '0') + 'T' +
                String(dueDate.getHours()).padStart(2, '0') + ':' +
                String(dueDate.getMinutes()).padStart(2, '0');
            document.getElementById('taskDueDate').value = formattedDate;
        }
        
        // Seleccionar el lead si existe
        document.getElementById('taskLeadId').value = task.lead_id || '';
        
        // Cambiar el formulario a modo edici√≥n
        const form = document.getElementById('taskForm');
        form.onsubmit = function(e) {
            e.preventDefault();
            updateTask(taskId);
        };
        
        // Cambiar textos del modal
        const modalTitle = document.querySelector('#createTaskModal h3');
        const submitButton = document.querySelector('#createTaskModal button[type="submit"]');
        
        if (modalTitle) modalTitle.textContent = 'Edit Task';
        if (submitButton) submitButton.textContent = 'Update Task';
        
        // Abrir el modal
        openModal('createTaskModal');
        
        console.log('Task edit form populated successfully');
        
    } catch (error) {
        console.error('Error in editTask:', error);
        showNotification('Error loading task for editing', 'error');
    }
}

// 4. ARREGLAR updateTask para evitar problemas
async function updateTask(taskId) {
    try {
        console.log('Updating task:', taskId);
        
        const taskData = {
            title: document.getElementById('taskTitle').value.trim(),
            description: document.getElementById('taskDescription').value.trim(),
            type: document.getElementById('taskType').value,
            priority: document.getElementById('taskPriority').value,
            due_date: document.getElementById('taskDueDate').value || null,
            lead_id: document.getElementById('taskLeadId').value || null
        };
        
        if (!taskData.title) {
            showNotification('Task title is required', 'warning');
            return;
        }
        
        const response = await apiCall(`/api/tasks/${taskId}`, {
            method: 'PUT',
            body: JSON.stringify(taskData)
        });
        
        if (response.success) {
            showNotification('Task updated successfully!', 'success');
            closeModal('createTaskModal');
            resetTaskForm();
            
            // Recargar tasks despu√©s de un breve delay
            setTimeout(() => {
                loadTasks();
            }, 500);
        }
        
    } catch (error) {
        console.error('Error updating task:', error);
        showNotification('Error updating task', 'error');
    }
}

// 5. MEJORAR resetTaskForm
function resetTaskForm() {
    try {
        const form = document.getElementById('taskForm');
        const modalTitle = document.querySelector('#createTaskModal h3');
        const submitButton = document.querySelector('#createTaskModal button[type="submit"]');
        
        // Resetear el form y handler
        if (form) {
            form.onsubmit = submitTaskForm;
            form.reset();
        }
        
        // Restaurar textos originales
        if (modalTitle) modalTitle.textContent = 'Create New Task';
        if (submitButton) submitButton.textContent = 'Create Task';
        
        console.log('Task form reset to create mode');
    } catch (error) {
        console.error('Error resetting task form:', error);
    }
}

// 6. SIMPLIFICAR closeModal override
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
        
        // Solo resetear si es el modal de tasks
        if (modalId === 'createTaskModal') {
            setTimeout(() => {
                resetTaskForm();
            }, 100);
        }
    }
}
// Funci√≥n para mostrar detalles de LinkedIn enriquecidos
function viewLinkedInEnrichedDetails(prospectId) {
    const prospect = apiData.prospects.find(p => p.id == prospectId);
    if (!prospect || !prospect.is_premium) return;
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50';
    modal.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-yellow-100">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-star text-yellow-500 text-2xl mr-3"></i>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">Premium LinkedIn Profile</h3>
                                <p class="text-sm text-gray-600">${prospect.name}</p>
                            </div>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Professional Summary -->
                        ${prospect.linkedin_summary ? `
                            <div class="md:col-span-2">
                                <h4 class="font-semibold text-gray-900 mb-2">Professional Summary</h4>
                                <p class="text-gray-700 bg-gray-50 p-4 rounded-lg">${prospect.linkedin_summary}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Current Position -->
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Current Position</h4>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="font-medium">${prospect.title || 'N/A'}</p>
                                <p class="text-sm text-gray-600">${prospect.company || 'N/A'}</p>
                                ${prospect.current_position_duration ? 
                                    '<p class="text-xs text-gray-500 mt-1">Duration: ' + prospect.current_position_duration + '</p>' : 
                                    ''
                                }
                            </div>
                        </div>
                        
                        <!-- Education -->
                        ${prospect.education && prospect.education.length > 0 ? `
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2">Education</h4>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    ${prospect.education.map(edu => 
                                        '<p class="text-sm text-gray-700">' + edu + '</p>'
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Skills -->
                        ${prospect.skills && prospect.skills.length > 0 ? `
                            <div class="md:col-span-2">
                                <h4 class="font-semibold text-gray-900 mb-2">Skills</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${prospect.skills.map(skill => 
                                        '<span class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm">' + skill + '</span>'
                                    ).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- LinkedIn Stats -->
                        <div class="md:col-span-2">
                            <h4 class="font-semibold text-gray-900 mb-2">LinkedIn Activity</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center p-3 bg-gray-50 rounded-lg">
                                    <div class="text-xl font-bold text-gray-900">${prospect.linkedin_connections || 'N/A'}</div>
                                    <div class="text-xs text-gray-600">Connections</div>
                                </div>
                                <div class="text-center p-3 bg-gray-50 rounded-lg">
                                    <div class="text-xl font-bold text-gray-900">${prospect.linkedin_followers || 'N/A'}</div>
                                    <div class="text-xs text-gray-600">Followers</div>
                                </div>
                                <div class="text-center p-3 bg-gray-50 rounded-lg">
                                    <div class="text-xl font-bold text-gray-900">${prospect.last_active || 'N/A'}</div>
                                    <div class="text-xs text-gray-600">Last Active</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-clock"></i> Enriched: ${prospect.enrichment_date ? new Date(prospect.enrichment_date).toLocaleDateString() : 'N/A'}
                        </div>
                        <a href="${prospect.linkedin_url}" target="_blank" class="btn-primary text-white px-4 py-2 rounded-lg">
                            <i class="fab fa-linkedin mr-2"></i>View on LinkedIn
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}



  </script>


</body>
</html>

